<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - ç”µå•†ç®¡ç†è®¾è®¡å·¥å…·</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #131314;
            color: #E3E3E3;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ç™»å½•æ¡† - Google é£æ ¼ */
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            background: #1E1F20;
            padding: 48px 40px;
            border-radius: 24px;
            border: 1px solid #444746;
        }

        .login-box h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
            text-align: center;
            color: #E3E3E3;
        }

        .login-box .login-subtitle {
            text-align: center;
            color: #C4C7C5;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-box input {
            width: 100%;
            padding: 16px;
            border: 1px solid #444746;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            background: transparent;
            color: #E3E3E3;
            transition: border-color 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: #A8C7FA;
        }

        .login-box input::placeholder {
            color: #C4C7C5;
        }

        .login-box button {
            float: right;
            padding: 12px 24px;
            background: #A8C7FA;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-box button:hover {
            background: #c4dbfc;
        }

        .error-msg {
            color: #f28b82;
            text-align: center;
            margin-top: 16px;
            clear: both;
            padding-top: 16px;
        }

        /* ç®¡ç†é¢æ¿ */
        .admin-panel {
            display: none;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1E1F20;
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .admin-header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .btn-logout {
            padding: 10px 20px;
            background: transparent;
            color: #f28b82;
            border: 1px solid #f28b82;
            border-radius: 999px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(242, 139, 130, 0.12);
        }

        /* ç»Ÿè®¡å¡ç‰‡ - æ·±è‰²é£æ ¼ */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            flex: 1;
            background: #1E1F20;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-number {
            font-size: 48px;
            font-weight: 500;
            color: #E3E3E3;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 14px;
            color: #C4C7C5;
            margin-top: 8px;
        }

        /* æ ‡ç­¾é¡µ - èƒ¶å›Šé£æ ¼ */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            color: #C4C7C5;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #E3E3E3;
        }

        .tab-btn.active {
            background: #A8C7FA;
            color: #131314;
        }

        /* ç”¨æˆ·å¡ç‰‡ - æ·±è‰² */
        .user-card {
            background: #1E1F20;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-card:hover {
            background: #282A2C;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-size: 16px;
            font-weight: 500;
            color: #A8C7FA;
        }

        .user-meta {
            font-size: 13px;
            color: #C4C7C5;
            margin-top: 4px;
        }

        .user-tags {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid;
        }

        .tag-company {
            background: transparent;
            border-color: #E5C16C;
            color: #E5C16C;
        }

        .tag-position {
            background: transparent;
            border-color: #A8C7FA;
            color: #A8C7FA;
        }

        .tag-credits {
            background: transparent;
            border-color: #81C995;
            color: #81C995;
        }

        .tag-credits-low {
            background: rgba(242, 139, 130, 0.15);
            border-color: #f28b82;
            color: #f28b82;
        }

        .tag-sessions {
            background: transparent;
            border-color: #C4C7C5;
            color: #C4C7C5;
        }

        .user-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .user-stat {
            text-align: center;
        }

        .user-stat-num {
            font-size: 20px;
            font-weight: 500;
            color: #E3E3E3;
        }

        .user-stat-label {
            font-size: 11px;
            color: #C4C7C5;
        }

        /* ä¼šè¯å¡ç‰‡ - æ·±è‰² */
        .session-card {
            background: #1E1F20;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444746;
        }

        .session-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-user {
            font-weight: 500;
            color: #A8C7FA;
        }

        .session-company {
            padding: 3px 10px;
            background: transparent;
            border: 1px solid #E5C16C;
            color: #E5C16C;
            border-radius: 999px;
            font-size: 12px;
        }

        .session-position {
            padding: 3px 10px;
            background: transparent;
            border: 1px solid #A8C7FA;
            color: #A8C7FA;
            border-radius: 999px;
            font-size: 12px;
        }

        .session-module {
            padding: 4px 12px;
            background: #282A2C;
            border-radius: 999px;
            font-size: 13px;
            color: #E3E3E3;
        }

        .session-time {
            font-size: 12px;
            color: #C4C7C5;
        }

        /* æ¶ˆæ¯åˆ—è¡¨ - æ·±è‰² */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .msg-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .msg-user {
            background: #282A2C;
        }

        .msg-assistant {
            background: transparent;
            border: 1px solid #444746;
        }

        .msg-role {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #C4C7C5;
        }

        /* æŒ‰é’® - æ·±è‰² */
        .btn-expand {
            padding: 8px 16px;
            background: #282A2C;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            color: #E3E3E3;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-expand:hover {
            background: #37393b;
        }

        /* æç¤ºè¯ç®¡ç†æ ·å¼ - æ·±è‰² */
        .prompt-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .module-list {
            background: #1E1F20;
            border-radius: 16px;
            padding: 16px;
        }

        .module-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444746;
        }

        .module-list-header h3 {
            font-size: 16px;
            color: #E3E3E3;
        }

        .btn-add-module {
            padding: 6px 12px;
            background: #81C995;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-module:hover {
            background: #a3dab4;
        }

        .module-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .module-item:hover {
            background: #282A2C;
        }

        .module-item.active {
            background: rgba(168, 199, 250, 0.15);
        }

        .module-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 20px;
        }

        .module-item-info {
            flex: 1;
        }

        .module-item-name {
            font-weight: 500;
            font-size: 14px;
            color: #E3E3E3;
        }

        .module-item-desc {
            font-size: 12px;
            color: #C4C7C5;
            margin-top: 2px;
        }

        .btn-delete-module {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(242, 139, 130, 0.2);
            color: #f28b82;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-item:hover .btn-delete-module {
            opacity: 1;
        }

        .btn-delete-module:hover {
            background: rgba(242, 139, 130, 0.3);
        }

        .prompt-editor {
            background: #1E1F20;
            border-radius: 16px;
            padding: 24px;
        }

        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #444746;
        }

        .prompt-editor-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: #E3E3E3;
            font-size: 18px;
            font-weight: 500;
            font-family: inherit;
            padding: 6px 12px;
            outline: none;
            transition: all 0.2s;
            min-width: 120px;
            max-width: 300px;
        }

        .module-name-input:hover {
            border-color: #444746;
            background: rgba(255, 255, 255, 0.05);
        }

        .module-name-input:focus {
            border-color: #A8C7FA;
            background: rgba(168, 199, 250, 0.08);
        }

        .prompt-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .prompt-tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: #C4C7C5;
            transition: all 0.2s;
        }

        .prompt-tab-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #E3E3E3;
        }

        .prompt-tab-btn.active {
            background: #A8C7FA;
            color: #131314;
            font-weight: 500;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid #444746;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: #131314;
            color: #E3E3E3;
            transition: border-color 0.2s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #A8C7FA;
        }

        .btn-save-prompt {
            padding: 12px 24px;
            background: #A8C7FA;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save-prompt:hover {
            background: #c4dbfc;
        }

        /* çŸ¥è¯†åº“æ ·å¼ - æ·±è‰² */
        .knowledge-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #444746;
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .knowledge-header h3 {
            font-size: 16px;
            color: #E3E3E3;
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .knowledge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #282A2C;
            border-radius: 12px;
        }

        .knowledge-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .knowledge-icon {
            font-size: 20px;
        }

        .knowledge-name {
            font-weight: 500;
            color: #E3E3E3;
        }

        .knowledge-meta {
            font-size: 12px;
            color: #C4C7C5;
        }

        .btn-delete-knowledge {
            padding: 6px 12px;
            background: rgba(242, 139, 130, 0.2);
            color: #f28b82;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-delete-knowledge:hover {
            background: rgba(242, 139, 130, 0.3);
        }

        .upload-zone {
            border: 2px dashed #444746;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: #A8C7FA;
            background: rgba(168, 199, 250, 0.08);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-zone label {
            cursor: pointer;
            color: #C4C7C5;
        }

        .upload-zone label strong {
            color: #A8C7FA;
        }

        /* æ–°æ¨¡å—å¼¹çª— - æ·±è‰² */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: #1E1F20;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #444746;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 500;
        }

        .modal-form .form-group {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #C4C7C5;
            font-size: 14px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #444746;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: #131314;
            color: #E3E3E3;
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #A8C7FA;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-cancel {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid #444746;
            border-radius: 999px;
            cursor: pointer;
            color: #E3E3E3;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-modal-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-modal-submit {
            flex: 1;
            padding: 12px;
            background: #A8C7FA;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-submit:hover {
            background: #c4dbfc;
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .emoji-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444746;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .emoji-option:hover,
        .emoji-option.selected {
            border-color: #A8C7FA;
            background: rgba(168, 199, 250, 0.12);
        }

        /* å¯¼å‡ºæ  - æ·±è‰² */
        .export-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: #1E1F20;
            border-radius: 16px;
            flex-wrap: wrap;
        }

        .export-label {
            font-weight: 500;
            color: #C4C7C5;
        }

        .btn-export {
            padding: 8px 16px;
            background: #81C995;
            color: #131314;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-export:hover {
            background: #a3dab4;
        }

        .btn-export-user {
            background: #A8C7FA;
        }

        .btn-export-user:hover {
            background: #c4dbfc;
        }

        /* ç”¨æˆ·è¯¦æƒ…é¢æ¿ - æ·±è‰² */
        .user-detail-panel {
            display: none;
            background: #1E1F20;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #444746;
        }

        .user-detail-info h2 {
            font-size: 20px;
            color: #A8C7FA;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .user-detail-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn-back {
            padding: 10px 20px;
            background: transparent;
            color: #E3E3E3;
            border: 1px solid #444746;
            border-radius: 999px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-export-single {
            padding: 10px 20px;
            background: #81C995;
            color: #131314;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-export-single:hover {
            background: #a3dab4;
        }

        /* å…‘æ¢ç ç®¡ç†æ ·å¼ */
        .redeem-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .redeem-form-card,
        .redeem-list-card {
            background: #1E1F20;
            border-radius: 16px;
            padding: 24px;
        }

        .redeem-form-card h3,
        .redeem-list-card h3 {
            font-size: 16px;
            color: #E3E3E3;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444746;
        }

        .redeem-form .form-row {
            display: flex;
            gap: 16px;
        }

        .redeem-form .form-group {
            flex: 1;
            margin-bottom: 16px;
        }

        .redeem-form label {
            display: block;
            font-size: 13px;
            color: #C4C7C5;
            margin-bottom: 8px;
        }

        .redeem-form input,
        .redeem-form select {
            width: 100%;
            padding: 12px 16px;
            background: #282A2C;
            border: 1px solid #444746;
            border-radius: 8px;
            color: #E3E3E3;
            font-size: 14px;
            font-family: inherit;
        }

        .redeem-form input:focus,
        .redeem-form select:focus {
            outline: none;
            border-color: #A8C7FA;
        }

        .btn-create-code {
            width: 100%;
            padding: 14px;
            background: #A8C7FA;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-create-code:hover {
            background: #c4dbfc;
        }

        .redeem-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(129, 201, 149, 0.1);
            border: 1px solid #81C995;
            border-radius: 12px;
            text-align: center;
        }

        .result-code {
            font-size: 32px;
            font-weight: 600;
            color: #81C995;
            letter-spacing: 4px;
            margin-bottom: 12px;
            font-family: monospace;
        }

        .btn-copy-code {
            padding: 10px 24px;
            background: #81C995;
            color: #131314;
            border: none;
            border-radius: 999px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-copy-code:hover {
            background: #a3dab4;
        }

        .redeem-codes-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .redeem-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #282A2C;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .redeem-code-info {
            flex: 1;
        }

        .redeem-code-value {
            font-size: 18px;
            font-weight: 600;
            color: #A8C7FA;
            font-family: monospace;
            letter-spacing: 2px;
        }

        .redeem-code-meta {
            font-size: 13px;
            color: #C4C7C5;
            margin-top: 6px;
        }

        .redeem-code-status {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            margin-left: 12px;
        }

        .status-unused {
            background: rgba(129, 201, 149, 0.2);
            color: #81C995;
        }

        .status-used {
            background: rgba(196, 199, 197, 0.2);
            color: #C4C7C5;
        }

        .btn-delete-code {
            padding: 8px 16px;
            background: rgba(242, 139, 130, 0.2);
            color: #f28b82;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
        }

        .btn-delete-code:hover {
            background: rgba(242, 139, 130, 0.3);
        }

        .btn-delete-code:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ—¥å¿—ç­›é€‰æŒ‰é’® */
        .log-filter-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #444746;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: #C4C7C5;
            transition: all 0.2s;
        }

        .log-filter-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #E3E3E3;
        }

        .log-filter-btn.active {
            background: #A8C7FA;
            color: #131314;
            border-color: #A8C7FA;
        }

        /* æ—¥å¿—åˆ—è¡¨é¡¹ */
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: #282A2C;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .log-item-info {
            flex: 1;
        }

        .log-item-action {
            font-size: 15px;
            font-weight: 500;
            color: #E3E3E3;
            margin-bottom: 4px;
        }

        .log-item-target {
            color: #A8C7FA;
            font-weight: 500;
        }

        .log-item-details {
            font-size: 13px;
            color: #C4C7C5;
            margin-top: 4px;
            line-height: 1.5;
        }

        .log-item-admin {
            padding: 4px 10px;
            background: rgba(168, 199, 250, 0.15);
            color: #A8C7FA;
            border-radius: 999px;
            font-size: 12px;
        }

        .log-item-time {
            font-size: 12px;
            color: #9ca3af;
            margin-left: 12px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #C4C7C5;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ç™»å½•æ¡† -->
        <div class="login-box" id="loginBox">
            <h1>Sign in</h1>
            <p class="login-subtitle">ç”µå•†ç®¡ç†è®¾è®¡å·¥å…· - ç®¡ç†åå°</p>
            <input type="text" id="adminUsername" placeholder="Username"
                onkeydown="if(event.key==='Enter')document.getElementById('adminPassword').focus()">
            <input type="password" id="adminPassword" placeholder="Password"
                onkeydown="if(event.key==='Enter')adminLogin()">
            <button onclick="adminLogin()">Next</button>
            <p class="error-msg" id="loginError"></p>
        </div>

        <!-- ç®¡ç†é¢æ¿ -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h1>ç”µå•†ç®¡ç†è®¾è®¡å·¥å…· - Admin</h1>
                <button class="btn-logout" onclick="adminLogout()">Sign out</button>
            </div>

            <!-- ç»Ÿè®¡ -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">æ³¨å†Œç”¨æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">å¯¹è¯ä¼šè¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('users')">ç”¨æˆ·åˆ—è¡¨</button>
                <button class="tab-btn" onclick="switchTab('sessions')">èŠå¤©è®°å½•</button>
                <button class="tab-btn" onclick="switchTab('prompts')">æç¤ºè¯ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('redeem')">å…‘æ¢ç ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('logs')">æ“ä½œæ—¥å¿—</button>
            </div>

            <!-- ç”¨æˆ·è¯¦æƒ…é¢æ¿ -->
            <div class="user-detail-panel" id="userDetailPanel">
                <div class="user-detail-header">
                    <div class="user-detail-info">
                        <h2 id="detailUserEmail">ç”¨æˆ·é‚®ç®±</h2>
                        <div class="user-detail-meta">
                            <span class="tag tag-company" id="detailUserCompany"></span>
                            <span class="tag tag-position" id="detailUserPosition"></span>
                            <span class="tag tag-credits" id="detailUserCredits"></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-back" onclick="hideUserDetail()">â† è¿”å›åˆ—è¡¨</button>
                        <button class="btn-export-single" onclick="exportUserSessions()">å¯¼å‡ºè¯¥ç”¨æˆ·å…¨éƒ¨å¯¹è¯</button>
                    </div>
                </div>
                <div id="userSessionsList"></div>
            </div>

            <!-- å¯¼å‡ºæŒ‰é’®ï¼ˆèŠå¤©è®°å½•æ ‡ç­¾ä¸‹æ˜¾ç¤ºï¼‰ -->
            <div class="export-bar" id="exportBar" style="display: none;">
                <span class="export-label">å¯¼å‡ºæ•°æ®ï¼š</span>
                <button class="btn-export" onclick="exportChat('all', 'json')">å…¨éƒ¨å¯¹è¯ (JSON)</button>
                <button class="btn-export" onclick="exportChat('all', 'csv')">å…¨éƒ¨å¯¹è¯ (CSV)</button>
                <button class="btn-export btn-export-user" onclick="exportChat('user', 'json')">ä»…ç”¨æˆ·è¾“å…¥ (JSON)</button>
                <button class="btn-export btn-export-user" onclick="exportChat('user', 'csv')">ä»…ç”¨æˆ·è¾“å…¥ (CSV)</button>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div id="usersTab">
                <div id="usersList"></div>
            </div>

            <!-- ä¼šè¯åˆ—è¡¨ -->
            <div id="sessionsTab" class="hidden">
                <div id="sessionsList"></div>
            </div>

            <!-- æç¤ºè¯ç®¡ç† -->
            <div id="promptsTab" class="hidden">
                <div class="prompt-container">
                    <!-- æ¨¡å—åˆ—è¡¨ -->
                    <div class="module-list">
                        <div class="module-list-header">
                            <h3>æ¨¡å—åˆ—è¡¨</h3>
                            <button class="btn-add-module" onclick="showAddModuleModal()">+ æ–°å¢æ¨¡å—</button>
                        </div>
                        <div id="moduleListItems">
                            <p class="loading">åŠ è½½ä¸­...</p>
                        </div>
                    </div>

                    <!-- æç¤ºè¯ç¼–è¾‘å™¨ -->
                    <div class="prompt-editor" id="promptEditor" style="display: none;">
                        <div class="prompt-editor-header">
                            <div class="prompt-editor-title">
                                <span id="currentModuleIcon" style="font-size: 24px;"></span>
                                <input type="text" id="currentModuleName" class="module-name-input" value=""
                                    placeholder="æ¨¡å—åç§°" onblur="saveModuleName()"
                                    onkeydown="if(event.key==='Enter'){this.blur()}">
                            </div>
                            <button class="btn-save-prompt" onclick="savePrompt()">ä¿å­˜æç¤ºè¯</button>
                        </div>

                        <div class="prompt-tabs">
                            <button class="prompt-tab-btn active" onclick="switchPromptTab('prompt')">ç³»ç»Ÿæç¤ºè¯</button>
                            <button class="prompt-tab-btn" onclick="switchPromptTab('knowledge')">çŸ¥è¯†åº“</button>
                        </div>

                        <!-- æç¤ºè¯ç¼–è¾‘ -->
                        <div id="promptContent">
                            <textarea class="prompt-textarea" id="promptTextarea"
                                placeholder="è¾“å…¥è¯¥æ¨¡å—çš„ç³»ç»Ÿæç¤ºè¯..."></textarea>
                        </div>

                        <!-- çŸ¥è¯†åº“ç®¡ç† -->
                        <div id="knowledgeContent" style="display: none;">
                            <div class="knowledge-section">
                                <div class="knowledge-header">
                                    <h3>çŸ¥è¯†åº“æ–‡ä»¶</h3>
                                </div>
                                <div class="knowledge-list" id="knowledgeList">
                                    <p class="loading">æš‚æ— çŸ¥è¯†åº“æ–‡ä»¶</p>
                                </div>
                                <div class="upload-zone">
                                    <input type="file" id="knowledgeUpload" accept=".txt,.md,.pdf,.docx"
                                        onchange="uploadKnowledge()">
                                    <label for="knowledgeUpload">
                                        ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶<br>
                                        <small>æ”¯æŒ TXTã€MDã€PDFã€DOCX æ ¼å¼</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p id="promptSaveStatus" style="margin-top: 12px; font-size: 13px; color: #10b981;"></p>
                    </div>

                    <!-- æœªé€‰æ‹©æ¨¡å—æ—¶çš„å ä½ -->
                    <div class="prompt-editor" id="promptPlaceholder">
                        <div style="text-align: center; padding: 100px 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘ˆ</div>
                            <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¨¡å—è¿›è¡Œç¼–è¾‘</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å…‘æ¢ç ç®¡ç† -->
            <div id="redeemTab" class="hidden">
                <div class="redeem-container">
                    <!-- åˆ›å»ºå…‘æ¢ç è¡¨å• -->
                    <div class="redeem-form-card">
                        <h3>ç”Ÿæˆå…‘æ¢ç </h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>ç›®æ ‡ç”¨æˆ·å§“å</label>
                                <input type="text" id="redeemTargetName" placeholder="è¾“å…¥ç”¨æˆ·å§“å">
                            </div>

                            <!-- ç”¨æˆ·ç±»å‹é€‰æ‹© -->
                            <div class="form-group">
                                <label>ç”¨æˆ·ç±»å‹</label>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid #444746;"
                                        id="typeBusinessSchoolLabel">
                                        <input type="radio" name="redeemUserType" value="business_school"
                                            onchange="toggleRedeemType()" checked>
                                        <span>ğŸ“ å•†å­¦é™¢å­¦å‘˜</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid transparent;"
                                        id="typeCatCoinsLabel">
                                        <input type="radio" name="redeemUserType" value="cat_coins"
                                            onchange="toggleRedeemType()">
                                        <span>ğŸ± çŒ«å¸å…‘æ¢</span>
                                    </label>
                                </div>
                            </div>

                            <!-- å•†å­¦é™¢ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º -->
                            <div class="form-group" id="businessSchoolInfo">
                                <div
                                    style="padding: 16px; background: rgba(129, 201, 149, 0.15); border-radius: 12px; border: 1px solid #81C995;">
                                    <div style="font-size: 16px; font-weight: 600; color: #81C995; margin-bottom: 8px;">
                                        ğŸ“ å•†å­¦é™¢å­¦å‘˜ä¸“å±</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #E3E3E3;">2000 ç§¯åˆ†</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">çº¦ 1000 æ¬¡å›ç­”æœºä¼š</div>
                                </div>
                            </div>

                            <!-- çŒ«å¸è¾“å…¥ï¼ˆä»…çŒ«å¸å…‘æ¢æ—¶æ˜¾ç¤ºï¼‰ -->
                            <div class="form-group" id="catCoinsInputGroup" style="display: none;">
                                <label>çŒ«å¸æ•°é‡</label>
                                <input type="number" id="redeemCatCoins" placeholder="è¾“å…¥çŒ«å¸æ•°é‡" min="1"
                                    oninput="updateRedeemPreview()">
                                <div class="cat-coin-preview" id="redeemPreview"
                                    style="padding: 12px; background: rgba(129, 201, 149, 0.1); border-radius: 8px; color: #81C995; font-size: 14px; display: none; margin-top: 8px;">
                                </div>
                                <div
                                    style="padding: 12px; background: #282A2C; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #C4C7C5;">
                                    <div style="font-weight: 500; margin-bottom: 8px; color: #E3E3E3;">ğŸ’¡ çŒ«å¸å…‘æ¢è§„åˆ™</div>
                                    <div>â€¢ æ¯ä¸ªçŒ«å¸ = 20ç§¯åˆ†</div>
                                    <div style="margin-top: 8px; color: #81C995;">ç¤ºä¾‹ï¼š5çŒ«å¸ = 100ç§¯åˆ†ï¼ˆçº¦50æ¬¡å›ç­”æœºä¼šï¼‰</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="redeemNote" placeholder="å¦‚ï¼šçŒ«è¯¾å­¦å‘˜ã€VIPå®¢æˆ·ç­‰">
                            </div>
                            <button class="btn-create-code" onclick="createRedeemCode()">ç”Ÿæˆå…‘æ¢ç </button>
                        </div>
                        <!-- ç”Ÿæˆç»“æœ -->
                        <div id="redeemResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="generatedCode"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;" id="generatedCredits">
                            </div>
                            <button class="btn-copy-code" onclick="copyRedeemCode()">å¤åˆ¶å…‘æ¢ç </button>
                        </div>
                    </div>

                    <!-- å…‘æ¢ç åˆ—è¡¨ -->
                    <div class="redeem-list-card">
                        <h3>å…‘æ¢ç è®°å½•</h3>
                        <div id="redeemCodesList" class="redeem-codes-list">
                            <p class="loading">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæ—¥å¿— -->
            <div id="logsTab" class="hidden">
                <div class="logs-container">
                    <!-- æ—¥å¿—ç­›é€‰ -->
                    <div class="logs-filter" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="log-filter-btn active" onclick="filterLogs('all')">å…¨éƒ¨æ—¥å¿—</button>
                        <button class="log-filter-btn" onclick="filterLogs('redeem')">å…‘æ¢ç ç®¡ç†</button>
                        <button class="log-filter-btn" onclick="filterLogs('user_redeem')">ç”¨æˆ·å…‘æ¢</button>
                        <button class="log-filter-btn" onclick="filterLogs('prompt')">æç¤ºè¯æ“ä½œ</button>
                    </div>
                    <!-- æ—¥å¿—åˆ—è¡¨ -->
                    <div class="logs-list-card" style="background: #1E1F20; border-radius: 16px; padding: 24px;">
                        <h3
                            style="font-size: 16px; color: #E3E3E3; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #444746;">
                            æ“ä½œæ—¥å¿—</h3>
                        <div id="adminLogsList" class="admin-logs-list" style="max-height: 600px; overflow-y: auto;">
                            <p class="loading">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ¨¡å—å¼¹çª— -->
    <div class="modal-overlay" id="addModuleModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>æ–°å¢æ¨¡å—</h2>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label>æ¨¡å—IDï¼ˆè‹±æ–‡ï¼Œå¦‚ customer_researchï¼‰</label>
                    <input type="text" id="newModuleId" placeholder="customer_research">
                </div>
                <div class="form-group">
                    <label>æ¨¡å—åç§°</label>
                    <input type="text" id="newModuleName" placeholder="å®¢æˆ·è°ƒç ”">
                </div>
                <div class="form-group">
                    <label>æ¨¡å—æè¿°</label>
                    <input type="text" id="newModuleDesc" placeholder="å¸®åŠ©åˆ†æå®¢æˆ·éœ€æ±‚å’Œå¸‚åœºåé¦ˆ">
                </div>
                <div class="form-group">
                    <label>å‰¯æ ‡é¢˜</label>
                    <input type="text" id="newModuleSubtitle" placeholder="æ·±å…¥äº†è§£ç›®æ ‡å®¢æˆ·">
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å›¾æ ‡</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" onclick="selectEmoji('ğŸ“Š')">ğŸ“Š</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ¯')">ğŸ¯</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ’¡')">ğŸ’¡</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ“ˆ')">ğŸ“ˆ</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ”')">ğŸ”</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ›’')">ğŸ›’</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ‘¥')">ğŸ‘¥</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸ“')">ğŸ“</span>
                        <span class="emoji-option" onclick="selectEmoji('ğŸš€')">ğŸš€</span>
                        <span class="emoji-option" onclick="selectEmoji('â­')">â­</span>
                    </div>
                    <input type="hidden" id="newModuleIcon" value="ğŸ“Š">
                </div>
                <div class="form-group">
                    <label>ä¸»é¢˜è‰²</label>
                    <input type="color" id="newModuleColor" value="#6366f1"
                        style="width: 60px; height: 40px; padding: 4px;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="hideAddModuleModal()">å–æ¶ˆ</button>
                <button class="btn-modal-submit" onclick="createModule()">åˆ›å»ºæ¨¡å—</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®
        let allUsers = [];
        let allSessions = [];
        let currentUserEmail = null;

        // ç®¡ç†å‘˜ç™»å½•
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadData();
                } else {
                    errorEl.textContent = data.message;
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        function adminLogout() {
            location.reload();
        }

        // åŠ è½½æ•°æ®ï¼ˆå…ˆåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå†æ¸²æŸ“ï¼‰
        async function loadData() {
            // å¹¶è¡ŒåŠ è½½ç”¨æˆ·å’Œä¼šè¯æ•°æ®
            const [usersRes, sessionsRes] = await Promise.all([
                fetch('/api/admin/users').then(r => r.json()).catch(() => ({ success: false })),
                fetch('/api/admin/sessions').then(r => r.json()).catch(() => ({ success: false }))
            ]);

            // ä¿å­˜æ•°æ®
            if (usersRes.success) {
                allUsers = usersRes.users || [];
                document.getElementById('totalUsers').textContent = allUsers.length;
            }

            if (sessionsRes.success) {
                allSessions = sessionsRes.sessions || [];
                document.getElementById('totalSessions').textContent = allSessions.length;

                // è®¡ç®—æ€»æ¶ˆæ¯æ•°
                let totalMsgs = 0;
                allSessions.forEach(s => {
                    totalMsgs += (s.messages || []).length;
                });
                document.getElementById('totalMessages').textContent = totalMsgs;
            }

            // æ•°æ®éƒ½åŠ è½½å®Œæˆåå†æ¸²æŸ“
            renderUsers();
            renderSessions();
        }

        // åŠ è½½ç”¨æˆ·ï¼ˆä¿ç•™ç”¨äºå•ç‹¬åˆ·æ–°ï¼‰
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                if (data.success) {
                    allUsers = data.users || [];
                    document.getElementById('totalUsers').textContent = allUsers.length;
                    renderUsers();
                }
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', e);
            }
        }

        // åŠ è½½ä¼šè¯ï¼ˆä¿ç•™ç”¨äºå•ç‹¬åˆ·æ–°ï¼‰
        async function loadSessions() {
            try {
                const res = await fetch('/api/admin/sessions');
                const data = await res.json();

                if (data.success) {
                    allSessions = data.sessions || [];
                    document.getElementById('totalSessions').textContent = allSessions.length;

                    // è®¡ç®—æ€»æ¶ˆæ¯æ•°
                    let totalMsgs = 0;
                    allSessions.forEach(s => {
                        totalMsgs += (s.messages || []).length;
                    });
                    document.getElementById('totalMessages').textContent = totalMsgs;

                    renderSessions();
                }
            } catch (e) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦ç»Ÿè®¡ä¿¡æ¯ï¼‰
        function renderUsers() {
            const container = document.getElementById('usersList');

            if (allUsers.length === 0) {
                container.innerHTML = '<p class="loading">æš‚æ— æ³¨å†Œç”¨æˆ·</p>';
                return;
            }

            // ä¸ºæ¯ä¸ªç”¨æˆ·ç»Ÿè®¡ä¼šè¯æ•°å’Œæ¶ˆæ¯æ•°
            const userStats = {};
            allSessions.forEach(s => {
                const email = s.user_email || 'æœªçŸ¥';
                if (!userStats[email]) {
                    userStats[email] = { sessions: 0, messages: 0 };
                }
                userStats[email].sessions++;
                userStats[email].messages += (s.messages || []).length;
            });

            container.innerHTML = allUsers.map(user => {
                const email = user.email || 'æœªçŸ¥';
                const stats = userStats[email] || { sessions: 0, messages: 0 };
                const credits = user.credits || 0;
                // ç§¯åˆ†çŠ¶æ€ï¼šä½äº 20 æ˜¾ç¤ºè­¦å‘Š
                const creditsClass = credits < 20 ? 'tag-credits-low' : 'tag-credits';

                return `
                <div class="user-card" onclick="showUserDetail('${email}')">
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-email">${user.nickname || email}</div>
                            <div class="user-tags">
                                ${user.company ? `<span class="tag tag-company">ğŸ¢ ${user.company}</span>` : ''}
                                ${user.position ? `<span class="tag tag-position">ğŸ‘¤ ${user.position}</span>` : ''}
                                <span class="tag ${creditsClass}">ğŸ’ ${credits} ç§¯åˆ†</span>
                                <span class="tag tag-sessions">ğŸ’¬ ${stats.sessions} æ¬¡å¯¹è¯</span>
                            </div>
                            <div class="user-meta">
                                æ³¨å†Œæ—¶é—´: ${formatTime(user.created_at)}
                            </div>
                        </div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-num" style="color: ${credits < 20 ? '#f28b82' : '#81C995'};">${credits}</div>
                                <div class="user-stat-label">ç§¯åˆ†</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.sessions}</div>
                                <div class="user-stat-label">å¯¹è¯</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.messages}</div>
                                <div class="user-stat-label">æ¶ˆæ¯</div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…ï¼ˆè¯¥ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯ï¼‰
        function showUserDetail(email) {
            currentUserEmail = email;

            // æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯
            const user = allUsers.find(u => u.email === email) || {};

            // æ›´æ–°è¯¦æƒ…é¢æ¿
            document.getElementById('detailUserEmail').textContent = email;
            document.getElementById('detailUserCompany').textContent = user.company ? 'ğŸ¢ ' + user.company : '';
            document.getElementById('detailUserPosition').textContent = user.position ? 'ğŸ‘¤ ' + user.position : '';
            document.getElementById('detailUserCredits').textContent = 'ğŸ’ ' + (user.credits || 0) + ' ç§¯åˆ†';

            // è¿‡æ»¤è¯¥ç”¨æˆ·çš„ä¼šè¯
            const userSessions = allSessions.filter(s => s.user_email === email);

            // æ¸²æŸ“è¯¥ç”¨æˆ·çš„ä¼šè¯
            const container = document.getElementById('userSessionsList');
            if (userSessions.length === 0) {
                container.innerHTML = '<p class="loading">è¯¥ç”¨æˆ·æš‚æ— å¯¹è¯è®°å½•</p>';
            } else {
                container.innerHTML = userSessions.map((s, idx) => `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user-info">
                                <span class="session-module">${s.module}</span>
                            </div>
                            <div>
                                <span class="session-time">${formatTime(s.updated_at)}</span>
                                <button class="btn-expand" onclick="toggleUserMessages(${idx})">
                                    ${(s.messages || []).length} æ¡æ¶ˆæ¯ â–¼
                                </button>
                            </div>
                        </div>
                        <div class="messages-list hidden" id="user-messages-${idx}">
                            ${(s.messages || []).map(m => `
                                <div class="msg-item msg-${m.role}">
                                    <div class="msg-role">${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}</div>
                                    <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿ï¼Œéšè—åˆ—è¡¨
            document.getElementById('userDetailPanel').style.display = 'block';
            document.getElementById('usersList').style.display = 'none';
        }

        function hideUserDetail() {
            currentUserEmail = null;
            document.getElementById('userDetailPanel').style.display = 'none';
            document.getElementById('usersList').style.display = 'block';
        }

        function toggleUserMessages(idx) {
            const el = document.getElementById('user-messages-' + idx);
            el.classList.toggle('hidden');
        }

        // å¯¼å‡ºå•ä¸ªç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
        function exportUserSessions() {
            if (!currentUserEmail) return;

            const user = allUsers.find(u => u.email === currentUserEmail) || {};
            const userSessions = allSessions.filter(s => s.user_email === currentUserEmail);

            const exportData = {
                user: {
                    email: currentUserEmail,
                    company: user.company || '',
                    position: user.position || '',
                    credits: user.credits || 0,
                    created_at: user.created_at
                },
                sessions: userSessions.map(s => ({
                    session_id: s.session_id || s.id,
                    module: s.module,
                    created_at: s.created_at,
                    messages: s.messages
                })),
                exported_at: new Date().toISOString()
            };

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `user_${currentUserEmail.split('@')[0]}_${timestamp}.json`;

            downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        function renderSessions() {
            const container = document.getElementById('sessionsList');

            if (allSessions.length === 0) {
                container.innerHTML = '<p class="loading">æš‚æ— èŠå¤©è®°å½•</p>';
                return;
            }

            container.innerHTML = allSessions.map((s, idx) => `
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-user-info">
                            <span class="session-user">${s.user_email || 'æœªçŸ¥ç”¨æˆ·'}</span>
                            ${s.user_company ? `<span class="session-company">ğŸ¢ ${s.user_company}</span>` : ''}
                            ${s.user_position ? `<span class="session-position">ğŸ‘¤ ${s.user_position}</span>` : ''}
                            <span class="session-module">${s.module}</span>
                        </div>
                        <div>
                            <span class="session-time">${formatTime(s.updated_at)}</span>
                            <button class="btn-expand" onclick="toggleMessages(${idx})">
                                ${(s.messages || []).length} æ¡æ¶ˆæ¯ â–¼
                            </button>
                        </div>
                    </div>
                    <div class="messages-list hidden" id="messages-${idx}">
                        ${(s.messages || []).map(m => `
                            <div class="msg-item msg-${m.role}">
                                <div class="msg-role">${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}</div>
                                <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // å±•å¼€/æ”¶èµ·æ¶ˆæ¯
        function toggleMessages(idx) {
            const el = document.getElementById('messages-' + idx);
            el.classList.toggle('hidden');
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('usersTab').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sessionsTab').classList.toggle('hidden', tab !== 'sessions');
            document.getElementById('promptsTab').classList.toggle('hidden', tab !== 'prompts');
            document.getElementById('redeemTab').classList.toggle('hidden', tab !== 'redeem');
            document.getElementById('logsTab').classList.toggle('hidden', tab !== 'logs');
            document.getElementById('userDetailPanel').style.display = 'none';

            // æ˜¾ç¤º/éšè—å¯¼å‡ºæŒ‰é’®
            document.getElementById('exportBar').style.display = tab === 'sessions' ? 'flex' : 'none';

            // åˆ‡æ¢åˆ°æç¤ºè¯ç®¡ç†æ—¶åŠ è½½æ¨¡å—
            if (tab === 'prompts') {
                loadModules();
            }
            // åˆ‡æ¢åˆ°å…‘æ¢ç ç®¡ç†æ—¶åŠ è½½å…‘æ¢ç åˆ—è¡¨
            if (tab === 'redeem') {
                loadRedeemCodes();
            }
            // åˆ‡æ¢åˆ°æ—¥å¿—æ ‡ç­¾æ—¶åŠ è½½æ—¥å¿—
            if (tab === 'logs') {
                loadAdminLogs('all');
            }
        }

        // å¯¼å‡ºèŠå¤©è®°å½•ï¼ˆåŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼‰
        function exportChat(type, format) {
            if (allSessions.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // æ„å»ºç”¨æˆ·ä¿¡æ¯æ˜ å°„
            const userMap = {};
            allUsers.forEach(u => {
                userMap[u.email] = u;
            });

            let exportData;
            const timestamp = new Date().toISOString().slice(0, 10);

            if (type === 'user') {
                // åªå¯¼å‡ºç”¨æˆ·è¾“å…¥
                exportData = allSessions.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || 'æœªçŸ¥',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        user_messages: (s.messages || []).filter(m => m.role === 'user').map(m => m.content)
                    };
                });
            } else {
                // å¯¼å‡ºå…¨éƒ¨å¯¹è¯
                exportData = allSessions.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || 'æœªçŸ¥',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        messages: s.messages
                    };
                });
            }

            if (format === 'json') {
                downloadFile(
                    JSON.stringify(exportData, null, 2),
                    `chat_${type}_${timestamp}.json`,
                    'application/json'
                );
            } else {
                // CSV æ ¼å¼
                const csvContent = convertToCSV(exportData, type);
                downloadFile(csvContent, `chat_${type}_${timestamp}.csv`, 'text/csv');
            }
        }

        // è½¬æ¢ä¸º CSV
        function convertToCSV(data, type) {
            let rows = [];

            if (type === 'user') {
                rows.push(['ä¼šè¯ID', 'ç”¨æˆ·é‚®ç®±', 'å…¬å¸åç§°', 'èŒä½', 'æ¨¡å—', 'æ—¶é—´', 'ç”¨æˆ·è¾“å…¥']);
                data.forEach(s => {
                    (s.user_messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            } else {
                rows.push(['ä¼šè¯ID', 'ç”¨æˆ·é‚®ç®±', 'å…¬å¸åç§°', 'èŒä½', 'æ¨¡å—', 'æ—¶é—´', 'è§’è‰²', 'å†…å®¹']);
                data.forEach(s => {
                    (s.messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.role === 'user' ? 'ç”¨æˆ·' : 'AI',
                            msg.content.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            }

            return rows.map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(str) {
            if (!str) return '-';
            const d = new Date(str);
            return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        // HTML è½¬ä¹‰
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ========================================
        // æç¤ºè¯ç®¡ç†åŠŸèƒ½
        // ========================================

        let allModules = [];
        let currentModuleId = null;

        // åŠ è½½æ¨¡å—åˆ—è¡¨
        async function loadModules() {
            try {
                const res = await fetch('/api/admin/modules');
                const data = await res.json();

                if (data.success) {
                    allModules = data.modules || [];
                    renderModuleList();
                }
            } catch (e) {
                console.error('åŠ è½½æ¨¡å—å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“æ¨¡å—åˆ—è¡¨
        function renderModuleList() {
            const container = document.getElementById('moduleListItems');

            if (allModules.length === 0) {
                container.innerHTML = '<p class="loading">æš‚æ— æ¨¡å—</p>';
                return;
            }

            container.innerHTML = allModules.map(m => `
                <div class="module-item ${currentModuleId === m.id ? 'active' : ''}"
                     onclick="selectModule('${m.id}')">
                    <div class="module-icon" style="background: ${m.color}20; color: ${m.color};">
                        ${m.icon || 'ğŸ“‹'}
                    </div>
                    <div class="module-item-info">
                        <div class="module-item-name">${m.name}</div>
                        <div class="module-item-desc">${m.description || ''}</div>
                    </div>
                    <button class="btn-delete-module" onclick="event.stopPropagation(); deleteModule('${m.id}', '${m.name}')" title="åˆ é™¤æ¨¡å—">Ã—</button>
                </div>
            `).join('');
        }

        // åˆ é™¤æ¨¡å—
        async function deleteModule(moduleId, moduleName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å—ã€Œ${moduleName}ã€å—ï¼Ÿ\n\nåˆ é™¤åé¦–é¡µå°†ä¸å†æ˜¾ç¤ºè¯¥æ¨¡å—ã€‚`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/modules/${moduleId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    alert('æ¨¡å—å·²åˆ é™¤');
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ¨¡å—ï¼Œæ¸…é™¤é€‰æ‹©
                    if (currentModuleId === moduleId) {
                        currentModuleId = null;
                        document.getElementById('promptEditor').style.display = 'none';
                        document.getElementById('promptPlaceholder').style.display = 'block';
                    }
                    // é‡æ–°åŠ è½½æ¨¡å—åˆ—è¡¨
                    await loadModules();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // é€‰æ‹©æ¨¡å—
        async function selectModule(moduleId) {
            currentModuleId = moduleId;
            const module = allModules.find(m => m.id === moduleId);

            if (!module) return;

            // æ›´æ–°UI
            document.getElementById('promptEditor').style.display = 'block';
            document.getElementById('promptPlaceholder').style.display = 'none';
            document.getElementById('currentModuleIcon').textContent = module.icon || 'ğŸ“‹';
            document.getElementById('currentModuleName').value = module.name;
            document.getElementById('promptSaveStatus').textContent = '';

            // æ›´æ–°æ¨¡å—åˆ—è¡¨é«˜äº®
            renderModuleList();

            // åŠ è½½æç¤ºè¯
            await loadPrompt(moduleId);

            // åŠ è½½çŸ¥è¯†åº“
            await loadKnowledge(moduleId);
        }

        // åŠ è½½æç¤ºè¯
        async function loadPrompt(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/prompt`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('promptTextarea').value = data.prompt || '';
                }
            } catch (e) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥', e);
            }
        }

        // ä¿å­˜æç¤ºè¯
        async function savePrompt() {
            if (!currentModuleId) return;

            const prompt = document.getElementById('promptTextarea').value;
            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = 'ä¿å­˜ä¸­...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = 'âœ“ ä¿å­˜æˆåŠŸ';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = 'âœ— ä¿å­˜å¤±è´¥: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = 'âœ— ç½‘ç»œé”™è¯¯';
                statusEl.style.color = '#ef4444';
            }
        }

        // ä¿å­˜æ¨¡å—åç§°
        async function saveModuleName() {
            if (!currentModuleId) return;

            const nameInput = document.getElementById('currentModuleName');
            const newName = nameInput.value.trim();
            const statusEl = document.getElementById('promptSaveStatus');

            if (!newName) {
                // å¦‚æœåç§°ä¸ºç©ºï¼Œæ¢å¤åŸåç§°
                const module = allModules.find(m => m.id === currentModuleId);
                if (module) {
                    nameInput.value = module.name;
                }
                return;
            }

            // æ£€æŸ¥åç§°æ˜¯å¦æ”¹å˜
            const module = allModules.find(m => m.id === currentModuleId);
            if (module && module.name === newName) {
                return; // åç§°æœªå˜ï¼Œä¸éœ€è¦ä¿å­˜
            }

            try {
                statusEl.textContent = 'ä¿å­˜æ¨¡å—åç§°...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = 'âœ“ æ¨¡å—åç§°å·²ä¿å­˜';
                    statusEl.style.color = '#10b981';
                    // æ›´æ–°æœ¬åœ°æ•°æ®å¹¶é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    if (module) {
                        module.name = newName;
                    }
                    renderModuleList();
                } else {
                    statusEl.textContent = 'âœ— ä¿å­˜å¤±è´¥: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = 'âœ— ç½‘ç»œé”™è¯¯';
                statusEl.style.color = '#ef4444';
            }
        }

        // åˆ‡æ¢æç¤ºè¯/çŸ¥è¯†åº“æ ‡ç­¾
        function switchPromptTab(tab) {
            document.querySelectorAll('.prompt-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('promptContent').style.display = tab === 'prompt' ? 'block' : 'none';
            document.getElementById('knowledgeContent').style.display = tab === 'knowledge' ? 'block' : 'none';
        }

        // åŠ è½½çŸ¥è¯†åº“æ–‡ä»¶
        async function loadKnowledge(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/knowledge`);
                const data = await res.json();

                const container = document.getElementById('knowledgeList');

                if (data.success && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = getFileIcon(f.file_type);
                        return `
                            <div class="knowledge-item">
                                <div class="knowledge-item-info">
                                    <span class="knowledge-icon">${icon}</span>
                                    <div>
                                        <div class="knowledge-name">${f.filename}</div>
                                        <div class="knowledge-meta">${formatTime(f.created_at)}</div>
                                    </div>
                                </div>
                                <button class="btn-delete-knowledge" onclick="deleteKnowledge('${f.id}')">åˆ é™¤</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="loading">æš‚æ— çŸ¥è¯†åº“æ–‡ä»¶</p>';
                }
            } catch (e) {
                console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥', e);
            }
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(type) {
            const icons = {
                'txt': 'ğŸ“„',
                'md': 'ğŸ“',
                'pdf': 'ğŸ“•',
                'docx': 'ğŸ“˜'
            };
            return icons[type] || 'ğŸ“„';
        }

        // ä¸Šä¼ çŸ¥è¯†åº“æ–‡ä»¶
        async function uploadKnowledge() {
            if (!currentModuleId) {
                alert('è¯·å…ˆé€‰æ‹©æ¨¡å—');
                return;
            }

            const input = document.getElementById('knowledgeUpload');
            const file = input.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/admin/modules/${currentModuleId}/knowledge`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert('ä¸Šä¼ æˆåŠŸ');
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }

            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            input.value = '';
        }

        // åˆ é™¤çŸ¥è¯†åº“æ–‡ä»¶
        async function deleteKnowledge(fileId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/admin/knowledge/${fileId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ˜¾ç¤ºæ–°å¢æ¨¡å—å¼¹çª—
        function showAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'flex';
        }

        // éšè—æ–°å¢æ¨¡å—å¼¹çª—
        function hideAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('newModuleId').value = '';
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleDesc').value = '';
            document.getElementById('newModuleSubtitle').value = '';
            document.getElementById('newModuleIcon').value = 'ğŸ“Š';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
        }

        // é€‰æ‹© Emoji
        function selectEmoji(emoji) {
            document.getElementById('newModuleIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === emoji);
            });
        }

        // åˆ›å»ºæ–°æ¨¡å—
        async function createModule() {
            const id = document.getElementById('newModuleId').value.trim();
            const name = document.getElementById('newModuleName').value.trim();
            const description = document.getElementById('newModuleDesc').value.trim();
            const subtitle = document.getElementById('newModuleSubtitle').value.trim();
            const icon = document.getElementById('newModuleIcon').value;
            const color = document.getElementById('newModuleColor').value;

            if (!id || !name) {
                alert('è¯·å¡«å†™æ¨¡å—IDå’Œåç§°');
                return;
            }

            // éªŒè¯ ID æ ¼å¼ï¼ˆåªå…è®¸è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
            if (!/^[a-z][a-z0-9_]*$/.test(id)) {
                alert('æ¨¡å—IDåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”ä»¥å­—æ¯å¼€å¤´');
                return;
            }

            try {
                const res = await fetch('/api/admin/modules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        name,
                        description,
                        subtitle,
                        icon,
                        color,
                        prompt: `## ${name}æ¨¡å—\n\nè¯·åœ¨æ­¤è¾“å…¥è¯¥æ¨¡å—çš„ç³»ç»Ÿæç¤ºè¯...`
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('æ¨¡å—åˆ›å»ºæˆåŠŸï¼');
                    hideAddModuleModal();
                    await loadModules();
                    // è‡ªåŠ¨é€‰ä¸­æ–°æ¨¡å—
                    selectModule(id);
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ========================================
        // å…‘æ¢ç ç®¡ç†åŠŸèƒ½
        // ========================================

        let allRedeemCodes = [];

        async function loadRedeemCodes() {
            try {
                const res = await fetch('/api/admin/redeem/codes');
                const data = await res.json();
                if (data.success) {
                    allRedeemCodes = data.codes;
                    renderRedeemCodes();
                }
            } catch (e) {
                console.error('åŠ è½½å…‘æ¢ç å¤±è´¥:', e);
            }
        }

        function renderRedeemCodes() {
            const container = document.getElementById('redeemCodesList');
            if (allRedeemCodes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">æš‚æ— å…‘æ¢ç </p>';
                return;
            }

            container.innerHTML = allRedeemCodes.map(code => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value">${code.code}</div>
                        <div class="redeem-code-meta">
                            ç›®æ ‡: ${code.target_name} |
                            ${code.cat_coins ? code.cat_coins + 'çŒ«å¸ â†’ ' : ''}${code.credits} ç§¯åˆ† |
                            åˆ›å»º: ${code.created_by} | ${formatTime(code.created_at)}
                            ${code.note ? ' | ' + code.note : ''}
                        </div>
                    </div>
                    <span class="redeem-code-status ${code.is_used ? 'status-used' : 'status-unused'}">
                        ${code.is_used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}
                    </span>
                    <button class="btn-delete-code" onclick="deleteRedeemCode('${code.id}')" ${code.is_used ? 'disabled' : ''}>
                        åˆ é™¤
                    </button>
                </div>
            `).join('');
        }

        // è®¡ç®—çŒ«å¸å…‘æ¢ç§¯åˆ†
        function calculateCreditsFromCatCoins(catCoins) {
            if (catCoins <= 0) return 0;
            // æ¯ä¸ªçŒ«å¸ = 20ç§¯åˆ†
            return catCoins * 20;
        }

        // æ›´æ–°å…‘æ¢é¢„è§ˆ
        function updateRedeemPreview() {
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const preview = document.getElementById('redeemPreview');
            if (catCoins > 0) {
                const credits = calculateCreditsFromCatCoins(catCoins);
                preview.innerHTML = `<strong>${catCoins} ä¸ªçŒ«å¸ = ${credits} ç§¯åˆ†</strong>ï¼ˆçº¦ ${Math.floor(credits / 2)} æ¬¡å›ç­”æœºä¼šï¼‰`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // åˆ‡æ¢ç”¨æˆ·ç±»å‹
        function toggleRedeemType() {
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const businessSchoolInfo = document.getElementById('businessSchoolInfo');
            const catCoinsInputGroup = document.getElementById('catCoinsInputGroup');
            const typeBusinessSchoolLabel = document.getElementById('typeBusinessSchoolLabel');
            const typeCatCoinsLabel = document.getElementById('typeCatCoinsLabel');

            if (userType === 'business_school') {
                businessSchoolInfo.style.display = 'block';
                catCoinsInputGroup.style.display = 'none';
                typeBusinessSchoolLabel.style.borderColor = '#444746';
                typeCatCoinsLabel.style.borderColor = 'transparent';
            } else {
                businessSchoolInfo.style.display = 'none';
                catCoinsInputGroup.style.display = 'block';
                typeBusinessSchoolLabel.style.borderColor = 'transparent';
                typeCatCoinsLabel.style.borderColor = '#444746';
            }
        }

        async function createRedeemCode() {
            const targetName = document.getElementById('redeemTargetName').value.trim();
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const note = document.getElementById('redeemNote').value.trim();

            if (!targetName) {
                alert('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·å§“å');
                return;
            }

            // çŒ«å¸å…‘æ¢æ¨¡å¼éœ€è¦è¾“å…¥çŒ«å¸æ•°é‡
            if (userType === 'cat_coins' && (!catCoins || catCoins <= 0)) {
                alert('è¯·è¾“å…¥çŒ«å¸æ•°é‡');
                return;
            }

            try {
                const requestBody = {
                    target_name: targetName,
                    note,
                    user_type: userType
                };

                // æ ¹æ®ç±»å‹è®¾ç½®ç§¯åˆ†
                if (userType === 'business_school') {
                    requestBody.credits = 2000;  // å•†å­¦é™¢å›ºå®š2000ç§¯åˆ†
                } else {
                    requestBody.cat_coins = catCoins;
                }

                const res = await fetch('/api/admin/redeem/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„å…‘æ¢ç 
                    document.getElementById('generatedCode').textContent = data.code.code;
                    const creditsInfo = userType === 'business_school'
                        ? 'å•†å­¦é™¢å­¦å‘˜ â†’ 2000 ç§¯åˆ†'
                        : `${catCoins} çŒ«å¸ â†’ ${data.code.credits} ç§¯åˆ†`;
                    document.getElementById('generatedCredits').textContent = creditsInfo;
                    document.getElementById('redeemResult').style.display = 'block';
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('redeemTargetName').value = '';
                    document.getElementById('redeemCatCoins').value = '';
                    document.getElementById('redeemNote').value = '';
                    document.getElementById('redeemPreview').style.display = 'none';
                    // åˆ·æ–°åˆ—è¡¨
                    loadRedeemCodes();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function copyRedeemCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('å…‘æ¢ç å·²å¤åˆ¶: ' + code);
            });
        }

        async function deleteRedeemCode(codeId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…‘æ¢ç å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/admin/redeem/${codeId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadRedeemCodes();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜æ“ä½œæ—¥å¿—åŠŸèƒ½
        // ========================================

        let currentLogType = 'all';

        async function loadAdminLogs(type = 'all') {
            currentLogType = type;
            const container = document.getElementById('adminLogsList');
            container.innerHTML = '<p class="loading">åŠ è½½ä¸­...</p>';

            try {
                const res = await fetch(`/api/admin/logs?type=${type}`);
                const data = await res.json();

                if (data.success) {
                    renderAdminLogs(data.logs || []);
                } else {
                    container.innerHTML = '<p class="loading">åŠ è½½å¤±è´¥</p>';
                }
            } catch (e) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', e);
                container.innerHTML = '<p class="loading">åŠ è½½å¤±è´¥</p>';
            }
        }

        function renderAdminLogs(logs) {
            const container = document.getElementById('adminLogsList');

            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">æš‚æ— æ“ä½œæ—¥å¿—</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                // æ ¹æ®æ“ä½œç±»å‹è®¾ç½®å›¾æ ‡
                const icons = {
                    'PROMPT_CREATE': 'ğŸ“',
                    'PROMPT_UPDATE': 'âœï¸',
                    'PROMPT_DELETE': 'ğŸ—‘ï¸',
                    'MODULE_CREATE': 'â•',
                    'MODULE_DELETE': 'âŒ',
                    'REDEEM_CREATE': 'ğŸ«',
                    'REDEEM_USED': 'âœ…',
                    'CREDITS_ADD': 'ğŸ’°'
                };
                const icon = icons[log.action_type] || 'ğŸ“‹';

                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <div class="log-item-action">
                                ${icon} ${log.action_name || log.action_type}
                                <span class="log-item-target">â†’ ${log.target || ''}</span>
                            </div>
                            <div class="log-item-details">${log.details || ''}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <span class="log-item-admin">${log.admin_name}</span>
                            <span class="log-item-time">${formatTime(log.created_at)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLogs(type) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // åŠ è½½å¯¹åº”ç±»å‹çš„æ—¥å¿—
            loadAdminLogs(type);
        }
    </script>
</body>

</html>