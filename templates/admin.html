<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 电商管理设计工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-blue: #6366f1;
            --accent-purple: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* 背景装饰 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% -20%, rgba(99, 102, 241, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139, 92, 246, 0.1), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ========== 侧边栏 ========== */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.95) 0%, rgba(10, 10, 15, 0.98) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            color: var(--text-primary);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .nav-item.active .nav-icon {
            color: var(--accent-blue);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border-color);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn-logout-small {
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout-small:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ========== 主内容区 ========== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            padding: 24px 32px;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .page-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========== 统计卡片 ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.users { background: rgba(99, 102, 241, 0.15); }
        .stat-icon.sessions { background: rgba(34, 211, 238, 0.15); }
        .stat-icon.messages { background: rgba(16, 185, 129, 0.15); }

        .stat-number {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== 内容面板 ========== */
        .content-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-body {
            padding: 24px;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* 登录框 - 现代玻璃风格 */
        .login-box {
            max-width: 420px;
            margin: 100px auto;
            background: var(--bg-card);
            padding: 48px 40px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 10;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            border-radius: 0 0 4px 4px;
        }

        .login-box h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text-primary);
        }

        .login-box .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .login-box input::placeholder {
            color: var(--text-muted);
        }

        .login-box button {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .error-msg {
            color: var(--accent-red);
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }

        /* 管理面板 */
        .admin-panel {
            display: none;
        }

        .admin-header {
            display: none;
        }

        /* 隐藏旧的tabs和stats */
        .tabs {
            display: none !important;
        }

        .stats {
            display: none !important;
        }

        /* 用户卡片 - 现代风格 */
        .user-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
            transform: translateX(4px);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .user-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .tag-company {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
        }

        .tag-position {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
        }

        .tag-credits {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        .tag-credits-low {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        .tag-sessions {
            background: rgba(161, 161, 170, 0.1);
            border-color: rgba(161, 161, 170, 0.3);
            color: var(--text-secondary);
        }

        .user-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .user-stat {
            text-align: center;
        }

        .user-stat-num {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* 会话卡片 - 现代风格 */
        .session-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .session-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-user {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .session-company {
            padding: 3px 10px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-position {
            padding: 3px 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-module {
            padding: 4px 12px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* 消息列表 - 现代风格 */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .msg-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .msg-user {
            background: var(--bg-card-hover);
        }

        .msg-assistant {
            background: transparent;
            border: 1px solid var(--border-color);
        }

        .msg-role {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* 按钮 - 现代风格 */
        .btn-expand {
            padding: 8px 14px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-expand:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* 提示词管理样式 - 现代风格 */
        .prompt-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .module-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
        }

        .module-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .module-list-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn-add-module {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-module:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .module-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .module-item:hover {
            background: var(--bg-card-hover);
        }

        .module-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .module-icon {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 18px;
        }

        .module-item-info {
            flex: 1;
        }

        .module-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .module-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .btn-delete-module {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-item:hover .btn-delete-module {
            opacity: 1;
        }

        .btn-delete-module:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .prompt-editor {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .prompt-editor-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            font-family: inherit;
            padding: 6px 12px;
            outline: none;
            transition: all 0.2s;
            min-width: 120px;
            max-width: 300px;
        }

        .module-name-input:hover {
            border-color: var(--border-color);
            background: var(--bg-card-hover);
        }

        .module-name-input:focus {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .prompt-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .prompt-tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .prompt-tab-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .prompt-tab-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
            font-weight: 500;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-save-prompt {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save-prompt:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* 知识库样式 - 现代风格 */
        .knowledge-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .knowledge-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .knowledge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
        }

        .knowledge-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .knowledge-icon {
            font-size: 20px;
        }

        .knowledge-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .knowledge-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .btn-delete-knowledge {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-delete-knowledge:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-zone label {
            cursor: pointer;
            color: var(--text-secondary);
        }

        .upload-zone label strong {
            color: var(--accent-blue);
        }

        /* 新模块弹窗 - 现代风格 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-form .form-group {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-cancel {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-modal-cancel:hover {
            background: var(--bg-card-hover);
        }

        .btn-modal-submit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .emoji-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .emoji-option:hover,
        .emoji-option.selected {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }

        /* 搜索和导出栏 - 现代风格 */
        .search-export-bar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 280px;
            max-width: 500px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            color: var(--bg-primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .search-clear-btn:hover {
            background: var(--text-secondary);
        }

        .search-result-count {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .search-result-count.has-results {
            color: var(--accent-green);
        }

        .export-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-export {
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-export-user {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .btn-export-user:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* 用户详情面板 - 现代风格 */
        .user-detail-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-detail-info h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            color: var(--accent-blue);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-detail-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-back {
            padding: 10px 18px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: var(--bg-card-hover);
        }

        .btn-export-single {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-export-single:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* 兑换码管理样式 - 现代风格 */
        .redeem-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .redeem-form-card,
        .redeem-list-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .redeem-form-card h3,
        .redeem-list-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .redeem-form .form-row {
            display: flex;
            gap: 16px;
        }

        .redeem-form .form-group {
            flex: 1;
            margin-bottom: 16px;
        }

        .redeem-form label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .redeem-form input,
        .redeem-form select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .redeem-form input:focus,
        .redeem-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-create-code {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-create-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .redeem-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            text-align: center;
        }

        .result-code {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
            letter-spacing: 4px;
            margin-bottom: 12px;
        }

        .btn-copy-code {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .redeem-codes-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .redeem-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .redeem-code-info {
            flex: 1;
        }

        .redeem-code-value {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-blue);
            letter-spacing: 2px;
        }

        .redeem-code-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .redeem-code-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 12px;
        }

        .status-unused {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .status-used {
            background: rgba(161, 161, 170, 0.15);
            color: var(--text-muted);
        }

        .btn-delete-code {
            padding: 8px 14px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-delete-code:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-delete-code:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 日志筛选按钮 - 现代风格 */
        .log-filter-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .log-filter-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .log-filter-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
        }

        /* 日志列表项 */
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .log-item-info {
            flex: 1;
        }

        .log-item-action {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .log-item-target {
            color: var(--accent-blue);
            font-weight: 500;
        }

        .log-item-details {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.5;
        }

        .log-item-admin {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .log-item-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* ========== 移动端汉堡菜单按钮 ========== */
        .mobile-menu-btn {
            display: none;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .mobile-menu-btn:hover {
            background: var(--bg-card-hover);
        }

        /* 侧边栏遮罩层 */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* ========== 响应式设计 - 平板 (1024px) ========== */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .prompt-container {
                grid-template-columns: 240px 1fr;
            }

            .redeem-container {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 20px 24px;
            }
        }

        /* ========== 响应式设计 - 平板小屏 (900px) ========== */
        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px 20px;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .main-header {
                flex-direction: row;
                align-items: center;
                gap: 16px;
            }

            .page-title {
                font-size: 24px;
            }

            .prompt-container {
                grid-template-columns: 1fr;
            }

            .module-list {
                margin-bottom: 20px;
            }

            .search-section {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input-wrapper {
                max-width: 100%;
                min-width: auto;
            }

            .export-section {
                flex-wrap: wrap;
            }

            .btn-export {
                flex: 1;
                min-width: 140px;
                text-align: center;
            }
        }

        /* ========== 响应式设计 - 手机 (768px) ========== */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 28px;
            }

            .user-detail-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .user-detail-header > div:last-child {
                display: flex;
                gap: 8px;
                width: 100%;
            }

            .user-detail-header .btn-back,
            .user-detail-header .btn-export-single {
                flex: 1;
                text-align: center;
                margin-left: 0;
            }

            .session-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .user-header {
                flex-direction: column;
                gap: 12px;
            }

            .user-stats {
                width: 100%;
                justify-content: space-around;
            }

            .redeem-form .form-row {
                flex-direction: column;
                gap: 0;
            }

            .modal-box {
                width: 95%;
                padding: 24px;
            }

            .prompt-tabs {
                flex-wrap: wrap;
            }

            .prompt-textarea {
                min-height: 300px;
            }

            .log-item {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .log-item-time {
                margin-left: 0;
            }
        }

        /* ========== 响应式设计 - 小屏手机 (480px) ========== */
        @media (max-width: 480px) {
            .main-content {
                padding: 12px 16px;
            }

            .main-header {
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 20px;
            }

            .page-subtitle {
                font-size: 13px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-bottom: 12px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 13px;
            }

            .login-box {
                margin: 40px 16px;
                padding: 32px 24px;
            }

            .login-box h1 {
                font-size: 22px;
            }

            .content-panel {
                border-radius: 12px;
            }

            .panel-header {
                padding: 16px;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .panel-body {
                padding: 16px;
            }

            .user-card {
                padding: 16px;
            }

            .user-tags {
                gap: 6px;
            }

            .tag {
                padding: 3px 8px;
                font-size: 11px;
            }

            .session-card {
                padding: 16px;
            }

            .btn-export {
                padding: 10px 12px;
                font-size: 12px;
            }

            .export-label {
                width: 100%;
                margin-bottom: 8px;
            }

            .redeem-code-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .redeem-code-status,
            .btn-delete-code {
                margin-left: 0;
            }

            .module-item {
                padding: 10px;
            }

            .module-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .prompt-editor {
                padding: 16px;
            }

            .prompt-editor-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .btn-save-prompt {
                width: 100%;
            }

            .knowledge-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .upload-zone {
                padding: 16px;
            }
        }

        /* ========== 响应式设计 - 超小屏手机 (360px) ========== */
        @media (max-width: 360px) {
            .sidebar-logo .logo-text {
                font-size: 14px;
            }

            .sidebar-logo .logo-subtitle {
                font-size: 10px;
            }

            .nav-item {
                padding: 10px 12px;
                font-size: 13px;
            }

            .nav-icon {
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <!-- 登录框 -->
    <div class="login-box" id="loginBox">
        <h1>管理后台</h1>
        <p class="login-subtitle">电商管理设计工具</p>
        <input type="text" id="adminUsername" placeholder="用户名"
            onkeydown="if(event.key==='Enter')document.getElementById('adminPassword').focus()">
        <input type="password" id="adminPassword" placeholder="密码"
            onkeydown="if(event.key==='Enter')adminLogin()">
        <button onclick="adminLogin()">登录</button>
        <p class="error-msg" id="loginError"></p>
    </div>

    <!-- 管理面板（侧边栏布局） -->
    <div class="app-container" id="adminPanel">
        <!-- 侧边栏遮罩层（移动端） -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

        <!-- 侧边栏 -->
        <aside class="sidebar" id="adminSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">⚡</div>
                    <div>
                        <div class="logo-text">Admin Panel</div>
                        <div class="logo-subtitle">电商管理设计工具</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">数据概览</div>
                    <div class="nav-item active" onclick="switchTab('users')" data-tab="users" data-role="super">
                        <span class="nav-icon">👥</span>
                        <span>用户列表</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('sessions')" data-tab="sessions" data-role="super">
                        <span class="nav-icon">💬</span>
                        <span>聊天记录</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">内容管理</div>
                    <div class="nav-item" onclick="switchTab('prompts')" data-tab="prompts" data-role="super">
                        <span class="nav-icon">📝</span>
                        <span>提示词管理</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('redeem')" data-tab="redeem" data-role="all">
                        <span class="nav-icon">🎫</span>
                        <span>兑换码管理</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">系统设置</div>
                    <div class="nav-item" onclick="switchTab('admins')" data-tab="admins" data-role="super">
                        <span class="nav-icon">👤</span>
                        <span>管理员管理</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('logs')" data-tab="logs" data-role="super">
                        <span class="nav-icon">📋</span>
                        <span>操作日志</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Admin</div>
                        <div class="user-role" id="adminRoleText">超级管理员</div>
                    </div>
                    <button class="btn-logout-small" onclick="adminLogout()">退出</button>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 页面标题 -->
            <div class="main-header">
                <!-- 移动端汉堡菜单按钮 -->
                <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileSidebar()">
                    ☰
                </button>
                <div>
                    <h1 class="page-title" id="pageTitle">用户列表</h1>
                    <p class="page-subtitle" id="pageSubtitle">管理所有注册用户</p>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon users">👥</div>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">注册用户</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon sessions">💬</div>
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">对话会话</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon messages">📨</div>
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">总消息数</div>
                </div>
            </div>

            <!-- 用户详情面板 -->
            <div class="user-detail-panel" id="userDetailPanel">
                <div class="user-detail-header">
                    <div class="user-detail-info">
                        <h2 id="detailUserEmail">用户邮箱</h2>
                        <div class="user-detail-meta">
                            <span class="tag tag-company" id="detailUserCompany"></span>
                            <span class="tag tag-position" id="detailUserPosition"></span>
                            <span class="tag tag-credits" id="detailUserCredits"></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-back" onclick="hideUserDetail()">← 返回列表</button>
                        <button class="btn-export-single" onclick="exportUserSessions()">导出该用户全部对话</button>
                    </div>
                </div>
                <div id="userSessionsList"></div>
            </div>

            <!-- 搜索和导出栏（聊天记录标签下显示） -->
            <div class="search-export-bar" id="exportBar" style="display: none;">
                <!-- 搜索区域 -->
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="sessionSearchInput" class="search-input"
                            placeholder="搜索用户邮箱、公司、消息内容..."
                            oninput="handleSessionSearch()">
                        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                            ✕
                        </button>
                    </div>
                    <span class="search-result-count" id="searchResultCount"></span>
                </div>
                <!-- 导出区域 -->
                <div class="export-section">
                    <span class="export-label">导出数据：</span>
                    <button class="btn-export" onclick="exportChat('all', 'json')">全部对话 (JSON)</button>
                    <button class="btn-export" onclick="exportChat('all', 'csv')">全部对话 (CSV)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'json')">仅用户输入 (JSON)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'csv')">仅用户输入 (CSV)</button>
                </div>
            </div>

            <!-- 用户列表 -->
            <div id="usersTab">
                <div id="usersList"></div>
            </div>

            <!-- 会话列表 -->
            <div id="sessionsTab" class="hidden">
                <div id="sessionsList"></div>
            </div>

            <!-- 提示词管理 -->
            <div id="promptsTab" class="hidden">
                <div class="prompt-container">
                    <!-- 模块列表 -->
                    <div class="module-list">
                        <div class="module-list-header">
                            <h3>模块列表</h3>
                            <button class="btn-add-module" onclick="showAddModuleModal()">+ 新增模块</button>
                        </div>
                        <div id="moduleListItems">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>

                    <!-- 提示词编辑器 -->
                    <div class="prompt-editor" id="promptEditor" style="display: none;">
                        <div class="prompt-editor-header">
                            <div class="prompt-editor-title">
                                <span id="currentModuleIcon" style="font-size: 24px;"></span>
                                <input type="text" id="currentModuleName" class="module-name-input" value=""
                                    placeholder="模块名称" onblur="saveModuleName()"
                                    onkeydown="if(event.key==='Enter'){this.blur()}">
                            </div>
                            <button class="btn-save-prompt" onclick="savePrompt()">保存提示词</button>
                        </div>

                        <div class="prompt-tabs">
                            <button class="prompt-tab-btn active" onclick="switchPromptTab('prompt')">系统提示词</button>
                            <button class="prompt-tab-btn" onclick="switchPromptTab('knowledge')">知识库</button>
                        </div>

                        <!-- 提示词编辑 -->
                        <div id="promptContent">
                            <textarea class="prompt-textarea" id="promptTextarea"
                                placeholder="输入该模块的系统提示词..."></textarea>
                        </div>

                        <!-- 知识库管理 -->
                        <div id="knowledgeContent" style="display: none;">
                            <div class="knowledge-section">
                                <div class="knowledge-header">
                                    <h3>知识库文件</h3>
                                </div>
                                <div class="knowledge-list" id="knowledgeList">
                                    <p class="loading">暂无知识库文件</p>
                                </div>
                                <div class="upload-zone">
                                    <input type="file" id="knowledgeUpload" accept=".txt,.md,.pdf,.docx"
                                        onchange="uploadKnowledge()">
                                    <label for="knowledgeUpload">
                                        📁 点击或拖拽上传文件<br>
                                        <small>支持 TXT、MD、PDF、DOCX 格式</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p id="promptSaveStatus" style="margin-top: 12px; font-size: 13px; color: #10b981;"></p>
                    </div>

                    <!-- 未选择模块时的占位 -->
                    <div class="prompt-editor" id="promptPlaceholder">
                        <div style="text-align: center; padding: 100px 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">👈</div>
                            <p>请从左侧选择一个模块进行编辑</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 兑换码管理 -->
            <div id="redeemTab" class="hidden">
                <div class="redeem-container">
                    <!-- 创建兑换码表单 -->
                    <div class="redeem-form-card">
                        <h3>生成兑换码</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>目标用户姓名</label>
                                <input type="text" id="redeemTargetName" placeholder="输入用户姓名">
                            </div>

                            <!-- 用户类型选择 -->
                            <div class="form-group">
                                <label>用户类型</label>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid #444746;"
                                        id="typeBusinessSchoolLabel">
                                        <input type="radio" name="redeemUserType" value="business_school"
                                            onchange="toggleRedeemType()" checked>
                                        <span>🎓 商学院学员</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid transparent;"
                                        id="typeCatCoinsLabel">
                                        <input type="radio" name="redeemUserType" value="cat_coins"
                                            onchange="toggleRedeemType()">
                                        <span>🐱 猫币兑换</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 商学院用户积分显示 -->
                            <div class="form-group" id="businessSchoolInfo">
                                <div
                                    style="padding: 16px; background: rgba(129, 201, 149, 0.15); border-radius: 12px; border: 1px solid #81C995;">
                                    <div style="font-size: 16px; font-weight: 600; color: #81C995; margin-bottom: 8px;">
                                        🎓 商学院学员专属</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #E3E3E3;">2000 积分</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">约 1000 次回答机会</div>
                                </div>
                            </div>

                            <!-- 猫币输入（仅猫币兑换时显示） -->
                            <div class="form-group" id="catCoinsInputGroup" style="display: none;">
                                <label>猫币数量</label>
                                <input type="number" id="redeemCatCoins" placeholder="输入猫币数量" min="1"
                                    oninput="updateRedeemPreview()">
                                <div class="cat-coin-preview" id="redeemPreview"
                                    style="padding: 12px; background: rgba(129, 201, 149, 0.1); border-radius: 8px; color: #81C995; font-size: 14px; display: none; margin-top: 8px;">
                                </div>
                                <div
                                    style="padding: 12px; background: #282A2C; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #C4C7C5;">
                                    <div style="font-weight: 500; margin-bottom: 8px; color: #E3E3E3;">💡 猫币兑换规则</div>
                                    <div>• 每个猫币 = 20积分</div>
                                    <div style="margin-top: 8px; color: #81C995;">示例：5猫币 = 100积分（约50次回答机会）</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>备注（可选）</label>
                                <input type="text" id="redeemNote" placeholder="如：猫课学员、VIP客户等">
                            </div>
                            <button class="btn-create-code" onclick="createRedeemCode()">生成兑换码</button>
                        </div>
                        <!-- 生成结果 -->
                        <div id="redeemResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="generatedCode"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;" id="generatedCredits">
                            </div>
                            <button class="btn-copy-code" onclick="copyRedeemCode()">复制兑换码</button>
                        </div>

                        <!-- 批量生成分隔线 -->
                        <div style="border-top: 1px solid var(--border-color); margin: 24px 0; padding-top: 24px;">
                            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">批量生成兑换码</h3>
                            <div class="redeem-form">
                                <div style="display: flex; gap: 12px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>积分数量</label>
                                        <input type="number" id="batchCredits" placeholder="每个兑换码的积分" min="1">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>生成数量</label>
                                        <input type="number" id="batchCount" placeholder="1-100" min="1" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>备注（可选）</label>
                                    <input type="text" id="batchNote" placeholder="如：活动赠送、批量发放等">
                                </div>
                                <button class="btn-create-code" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="batchCreateRedeemCodes()">批量生成</button>
                            </div>
                            <!-- 批量生成结果 -->
                            <div id="batchResult" class="redeem-result" style="display: none;">
                                <div style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 12px;" id="batchResultTitle"></div>
                                <div id="batchCodesList" style="max-height: 200px; overflow-y: auto; text-align: left; background: var(--bg-primary); border-radius: 8px; padding: 12px;"></div>
                                <button class="btn-copy-code" style="margin-top: 12px;" onclick="copyBatchCodes()">复制全部兑换码</button>
                            </div>
                        </div>
                    </div>

                    <!-- 兑换码列表 -->
                    <div class="redeem-list-card">
                        <h3>兑换码记录</h3>
                        <div id="redeemCodesList" class="redeem-codes-list">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div id="logsTab" class="hidden">
                <div class="logs-container">
                    <!-- 日志筛选 -->
                    <div class="logs-filter" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="log-filter-btn active" onclick="filterLogs('all')">全部日志</button>
                        <button class="log-filter-btn" onclick="filterLogs('redeem')">兑换码管理</button>
                        <button class="log-filter-btn" onclick="filterLogs('user_redeem')">用户兑换</button>
                        <button class="log-filter-btn" onclick="filterLogs('prompt')">提示词操作</button>
                    </div>
                    <!-- 日志列表 -->
                    <div class="logs-list-card" style="background: #1E1F20; border-radius: 16px; padding: 24px;">
                        <h3
                            style="font-size: 16px; color: #E3E3E3; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #444746;">
                            操作日志</h3>
                        <div id="adminLogsList" class="admin-logs-list" style="max-height: 600px; overflow-y: auto;">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 管理员管理（仅主管理员可见） -->
            <div id="adminsTab" class="hidden">
                <div class="redeem-container">
                    <!-- 添加管理员表单 -->
                    <div class="redeem-form-card">
                        <h3>添加管理员</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" id="newAdminUsername" placeholder="输入用户名">
                            </div>
                            <div class="form-group">
                                <label>备注（可选）</label>
                                <input type="text" id="newAdminNote" placeholder="如：运营组、销售组">
                            </div>
                            <div class="form-group">
                                <div style="padding: 16px; background: rgba(168, 199, 250, 0.1); border-radius: 12px; border: 1px solid #A8C7FA;">
                                    <div style="font-size: 14px; color: #A8C7FA; margin-bottom: 8px;">💡 默认密码</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #E3E3E3;">maoke2024</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">新管理员首次登录请使用此密码</div>
                                </div>
                            </div>
                            <button class="btn-create-code" onclick="createAdmin()">添加管理员</button>
                        </div>
                        <!-- 添加结果 -->
                        <div id="adminResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="createdAdminName"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;">默认密码：maoke2024</div>
                        </div>
                    </div>

                    <!-- 管理员列表 -->
                    <div class="redeem-list-card">
                        <h3>管理员列表</h3>
                        <div id="adminsList" class="redeem-codes-list">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 新增模块弹窗 -->
    <div class="modal-overlay" id="addModuleModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>新增模块</h2>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label>模块ID（英文，如 customer_research）</label>
                    <input type="text" id="newModuleId" placeholder="customer_research">
                </div>
                <div class="form-group">
                    <label>模块名称</label>
                    <input type="text" id="newModuleName" placeholder="客户调研">
                </div>
                <div class="form-group">
                    <label>模块描述</label>
                    <input type="text" id="newModuleDesc" placeholder="帮助分析客户需求和市场反馈">
                </div>
                <div class="form-group">
                    <label>副标题</label>
                    <input type="text" id="newModuleSubtitle" placeholder="深入了解目标客户">
                </div>
                <div class="form-group">
                    <label>选择图标</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" onclick="selectEmoji('📊')">📊</span>
                        <span class="emoji-option" onclick="selectEmoji('🎯')">🎯</span>
                        <span class="emoji-option" onclick="selectEmoji('💡')">💡</span>
                        <span class="emoji-option" onclick="selectEmoji('📈')">📈</span>
                        <span class="emoji-option" onclick="selectEmoji('🔍')">🔍</span>
                        <span class="emoji-option" onclick="selectEmoji('🛒')">🛒</span>
                        <span class="emoji-option" onclick="selectEmoji('👥')">👥</span>
                        <span class="emoji-option" onclick="selectEmoji('📝')">📝</span>
                        <span class="emoji-option" onclick="selectEmoji('🚀')">🚀</span>
                        <span class="emoji-option" onclick="selectEmoji('⭐')">⭐</span>
                    </div>
                    <input type="hidden" id="newModuleIcon" value="📊">
                </div>
                <div class="form-group">
                    <label>主题色</label>
                    <input type="color" id="newModuleColor" value="#6366f1"
                        style="width: 60px; height: 40px; padding: 4px;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="hideAddModuleModal()">取消</button>
                <button class="btn-modal-submit" onclick="createModule()">创建模块</button>
            </div>
        </div>
    </div>

    <script>
        // ========== 移动端侧边栏切换 ==========
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');

                // 防止背景滚动
                if (sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // 点击导航项时关闭侧边栏（移动端）
        function closeMobileSidebarOnNav() {
            if (window.innerWidth <= 900) {
                const sidebar = document.getElementById('adminSidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        }

        // 窗口大小改变时重置侧边栏状态
        window.addEventListener('resize', function() {
            if (window.innerWidth > 900) {
                const sidebar = document.getElementById('adminSidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        });

        // 全局数据
        let allUsers = [];
        let allSessions = [];
        let currentUserEmail = null;
        let currentAdminRole = 'normal';  // 当前管理员角色：'super' 或 'normal'

        // 管理员登录
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = '请输入用户名和密码';
                return;
            }

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    currentAdminRole = data.role || 'normal';
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';

                    // 更新侧边栏用户信息
                    const adminName = username.charAt(0).toUpperCase() + username.slice(1);
                    document.getElementById('adminName').textContent = adminName;
                    document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
                    document.getElementById('adminRoleText').textContent = currentAdminRole === 'super' ? '超级管理员' : '普通管理员';

                    // 根据角色显示/隐藏标签页
                    setupTabsForRole(currentAdminRole);

                    // 加载数据
                    if (currentAdminRole === 'super') {
                        loadData();
                    } else {
                        // 普通管理员直接跳转到兑换码管理
                        switchTab('redeem');
                        loadRedeemCodes();
                    }
                } else {
                    errorEl.textContent = data.message || data.error;
                }
            } catch (e) {
                errorEl.textContent = '网络错误';
            }
        }

        // 根据角色设置标签页显示
        function setupTabsForRole(role) {
            const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
            navItems.forEach(item => {
                const itemRole = item.getAttribute('data-role');
                if (itemRole === 'super' && role !== 'super') {
                    item.style.display = 'none';
                } else {
                    item.style.display = '';
                }
            });

            // 隐藏统计数据（普通管理员不显示）
            if (role !== 'super') {
                document.getElementById('statsGrid').style.display = 'none';
            }
        }

        function adminLogout() {
            location.reload();
        }

        // 加载数据（先加载所有数据，再渲染）
        async function loadData() {
            // 并行加载用户和会话数据
            const [usersRes, sessionsRes] = await Promise.all([
                fetch('/api/admin/users').then(r => r.json()).catch(() => ({ success: false })),
                fetch('/api/admin/sessions').then(r => r.json()).catch(() => ({ success: false }))
            ]);

            // 保存数据
            if (usersRes.success) {
                allUsers = usersRes.users || [];
                document.getElementById('totalUsers').textContent = allUsers.length;
            }

            if (sessionsRes.success) {
                allSessions = sessionsRes.sessions || [];
                document.getElementById('totalSessions').textContent = allSessions.length;

                // 计算总消息数
                let totalMsgs = 0;
                allSessions.forEach(s => {
                    totalMsgs += (s.messages || []).length;
                });
                document.getElementById('totalMessages').textContent = totalMsgs;
            }

            // 数据都加载完成后再渲染
            renderUsers();
            renderSessions();
        }

        // 加载用户（保留用于单独刷新）
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                if (data.success) {
                    allUsers = data.users || [];
                    document.getElementById('totalUsers').textContent = allUsers.length;
                    renderUsers();
                }
            } catch (e) {
                console.error('加载用户失败', e);
            }
        }

        // 加载会话（保留用于单独刷新）
        async function loadSessions() {
            try {
                const res = await fetch('/api/admin/sessions');
                const data = await res.json();

                if (data.success) {
                    allSessions = data.sessions || [];
                    document.getElementById('totalSessions').textContent = allSessions.length;

                    // 计算总消息数
                    let totalMsgs = 0;
                    allSessions.forEach(s => {
                        totalMsgs += (s.messages || []).length;
                    });
                    document.getElementById('totalMessages').textContent = totalMsgs;

                    renderSessions();
                }
            } catch (e) {
                console.error('加载会话失败', e);
            }
        }

        // 渲染用户列表（带统计信息）
        function renderUsers() {
            const container = document.getElementById('usersList');

            if (allUsers.length === 0) {
                container.innerHTML = '<p class="loading">暂无注册用户</p>';
                return;
            }

            // 为每个用户统计会话数和消息数
            const userStats = {};
            allSessions.forEach(s => {
                const email = s.user_email || '未知';
                if (!userStats[email]) {
                    userStats[email] = { sessions: 0, messages: 0 };
                }
                userStats[email].sessions++;
                userStats[email].messages += (s.messages || []).length;
            });

            container.innerHTML = allUsers.map(user => {
                const email = user.email || '未知';
                const stats = userStats[email] || { sessions: 0, messages: 0 };
                const credits = user.credits || 0;
                // 积分状态：低于 20 显示警告
                const creditsClass = credits < 20 ? 'tag-credits-low' : 'tag-credits';

                return `
                <div class="user-card" onclick="showUserDetail('${email}')">
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-email">${user.nickname || email}</div>
                            <div class="user-tags">
                                ${user.company ? `<span class="tag tag-company">🏢 ${user.company}</span>` : ''}
                                ${user.position ? `<span class="tag tag-position">👤 ${user.position}</span>` : ''}
                                <span class="tag ${creditsClass}">💎 ${credits} 积分</span>
                                <span class="tag tag-sessions">💬 ${stats.sessions} 次对话</span>
                            </div>
                            <div class="user-meta">
                                注册时间: ${formatTime(user.created_at)}
                            </div>
                        </div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-num" style="color: ${credits < 20 ? '#f28b82' : '#81C995'};">${credits}</div>
                                <div class="user-stat-label">积分</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.sessions}</div>
                                <div class="user-stat-label">对话</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.messages}</div>
                                <div class="user-stat-label">消息</div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // 显示用户详情（该用户的所有对话）
        function showUserDetail(email) {
            currentUserEmail = email;

            // 找到用户信息
            const user = allUsers.find(u => u.email === email) || {};

            // 更新详情面板
            document.getElementById('detailUserEmail').textContent = email;
            document.getElementById('detailUserCompany').textContent = user.company ? '🏢 ' + user.company : '';
            document.getElementById('detailUserPosition').textContent = user.position ? '👤 ' + user.position : '';
            document.getElementById('detailUserCredits').textContent = '💎 ' + (user.credits || 0) + ' 积分';

            // 过滤该用户的会话
            const userSessions = allSessions.filter(s => s.user_email === email);

            // 渲染该用户的会话
            const container = document.getElementById('userSessionsList');
            if (userSessions.length === 0) {
                container.innerHTML = '<p class="loading">该用户暂无对话记录</p>';
            } else {
                container.innerHTML = userSessions.map((s, idx) => `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user-info">
                                <span class="session-module">${s.module}</span>
                            </div>
                            <div>
                                <span class="session-time">${formatTime(s.updated_at)}</span>
                                <button class="btn-expand" onclick="toggleUserMessages(${idx})">
                                    ${(s.messages || []).length} 条消息 ▼
                                </button>
                            </div>
                        </div>
                        <div class="messages-list hidden" id="user-messages-${idx}">
                            ${(s.messages || []).map(m => `
                                <div class="msg-item msg-${m.role}">
                                    <div class="msg-role">${m.role === 'user' ? '用户' : 'AI'}</div>
                                    <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // 显示详情面板，隐藏列表
            document.getElementById('userDetailPanel').style.display = 'block';
            document.getElementById('usersList').style.display = 'none';
        }

        function hideUserDetail() {
            currentUserEmail = null;
            document.getElementById('userDetailPanel').style.display = 'none';
            document.getElementById('usersList').style.display = 'block';
        }

        function toggleUserMessages(idx) {
            const el = document.getElementById('user-messages-' + idx);
            el.classList.toggle('hidden');
        }

        // 导出单个用户的所有对话
        function exportUserSessions() {
            if (!currentUserEmail) return;

            const user = allUsers.find(u => u.email === currentUserEmail) || {};
            const userSessions = allSessions.filter(s => s.user_email === currentUserEmail);

            const exportData = {
                user: {
                    email: currentUserEmail,
                    company: user.company || '',
                    position: user.position || '',
                    credits: user.credits || 0,
                    created_at: user.created_at
                },
                sessions: userSessions.map(s => ({
                    session_id: s.session_id || s.id,
                    module: s.module,
                    created_at: s.created_at,
                    messages: s.messages
                })),
                exported_at: new Date().toISOString()
            };

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `user_${currentUserEmail.split('@')[0]}_${timestamp}.json`;

            downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
        }

        // 存储过滤后的会话（用于搜索和导出）
        let filteredSessions = [];
        let currentSearchKeyword = '';

        // 搜索处理函数
        function handleSessionSearch() {
            const input = document.getElementById('sessionSearchInput');
            const keyword = input.value.trim().toLowerCase();
            currentSearchKeyword = keyword;

            // 显示/隐藏清除按钮
            document.getElementById('searchClearBtn').style.display = keyword ? 'flex' : 'none';

            // 过滤会话
            if (!keyword) {
                filteredSessions = [...allSessions];
            } else {
                filteredSessions = allSessions.filter(s => {
                    // 搜索用户邮箱
                    if ((s.user_email || '').toLowerCase().includes(keyword)) return true;
                    // 搜索公司名称
                    if ((s.user_company || '').toLowerCase().includes(keyword)) return true;
                    // 搜索职位
                    if ((s.user_position || '').toLowerCase().includes(keyword)) return true;
                    // 搜索模块名称
                    if ((s.module || '').toLowerCase().includes(keyword)) return true;
                    // 搜索消息内容
                    const messages = s.messages || [];
                    for (const m of messages) {
                        if ((m.content || '').toLowerCase().includes(keyword)) return true;
                    }
                    return false;
                });
            }

            // 更新搜索结果计数
            updateSearchResultCount();
            // 重新渲染
            renderSessions();
        }

        // 更新搜索结果计数
        function updateSearchResultCount() {
            const countEl = document.getElementById('searchResultCount');
            if (!currentSearchKeyword) {
                countEl.textContent = '';
                countEl.classList.remove('has-results');
            } else {
                countEl.textContent = `找到 ${filteredSessions.length} 条记录`;
                countEl.classList.toggle('has-results', filteredSessions.length > 0);
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('sessionSearchInput').value = '';
            currentSearchKeyword = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            filteredSessions = [...allSessions];
            updateSearchResultCount();
            renderSessions();
        }

        // 渲染会话列表
        function renderSessions() {
            const container = document.getElementById('sessionsList');

            // 如果还没有初始化 filteredSessions，使用 allSessions
            if (filteredSessions.length === 0 && allSessions.length > 0 && !currentSearchKeyword) {
                filteredSessions = [...allSessions];
            }

            const sessionsToRender = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToRender.length === 0) {
                container.innerHTML = currentSearchKeyword
                    ? '<p class="loading">未找到匹配的聊天记录</p>'
                    : '<p class="loading">暂无聊天记录</p>';
                return;
            }

            container.innerHTML = sessionsToRender.map((s, idx) => `
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-user-info">
                            <span class="session-user">${s.user_email || '未知用户'}</span>
                            ${s.user_company ? `<span class="session-company">🏢 ${s.user_company}</span>` : ''}
                            ${s.user_position ? `<span class="session-position">👤 ${s.user_position}</span>` : ''}
                            <span class="session-module">${s.module}</span>
                        </div>
                        <div>
                            <span class="session-time">${formatTime(s.updated_at)}</span>
                            <button class="btn-expand" onclick="toggleMessages(${idx})">
                                ${(s.messages || []).length} 条消息 ▼
                            </button>
                        </div>
                    </div>
                    <div class="messages-list hidden" id="messages-${idx}">
                        ${(s.messages || []).map(m => `
                            <div class="msg-item msg-${m.role}">
                                <div class="msg-role">${m.role === 'user' ? '用户' : 'AI'}</div>
                                <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 展开/收起消息
        function toggleMessages(idx) {
            const el = document.getElementById('messages-' + idx);
            el.classList.toggle('hidden');
        }

        // 切换标签
        function switchTab(tab) {
            // 移动端：切换标签时关闭侧边栏
            closeMobileSidebarOnNav();

            // 更新侧边栏导航高亮
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => item.classList.remove('active'));
            const targetItem = document.querySelector(`.sidebar-nav .nav-item[data-tab="${tab}"]`);
            if (targetItem) targetItem.classList.add('active');

            // 更新页面标题
            const titles = {
                'users': { title: '用户列表', subtitle: '管理所有注册用户' },
                'sessions': { title: '聊天记录', subtitle: '查看所有对话历史' },
                'prompts': { title: '提示词管理', subtitle: '配置AI模块提示词' },
                'redeem': { title: '兑换码管理', subtitle: '生成和管理兑换码' },
                'admins': { title: '管理员管理', subtitle: '添加和管理管理员账号' },
                'logs': { title: '操作日志', subtitle: '查看系统操作记录' }
            };
            if (titles[tab]) {
                document.getElementById('pageTitle').textContent = titles[tab].title;
                document.getElementById('pageSubtitle').textContent = titles[tab].subtitle;
            }

            // 切换内容面板
            document.getElementById('usersTab').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sessionsTab').classList.toggle('hidden', tab !== 'sessions');
            document.getElementById('promptsTab').classList.toggle('hidden', tab !== 'prompts');
            document.getElementById('redeemTab').classList.toggle('hidden', tab !== 'redeem');
            document.getElementById('adminsTab').classList.toggle('hidden', tab !== 'admins');
            document.getElementById('logsTab').classList.toggle('hidden', tab !== 'logs');
            document.getElementById('userDetailPanel').style.display = 'none';

            // 显示/隐藏导出按钮
            document.getElementById('exportBar').style.display = tab === 'sessions' ? 'flex' : 'none';

            // 显示/隐藏统计卡片
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.style.display = (tab === 'users' || tab === 'sessions') ? 'grid' : 'none';
            }

            // 切换到提示词管理时加载模块
            if (tab === 'prompts') {
                loadModules();
            }
            // 切换到兑换码管理时加载兑换码列表
            if (tab === 'redeem') {
                loadRedeemCodes();
            }
            // 切换到日志标签时加载日志
            if (tab === 'logs') {
                loadAdminLogs('all');
            }
            // 切换到管理员管理时加载管理员列表
            if (tab === 'admins') {
                loadAdminUsers();
            }
        }

        // 导出聊天记录（包含完整用户信息）
        function exportChat(type, format) {
            // 使用搜索结果或全部数据
            const sessionsToExport = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToExport.length === 0) {
                alert(currentSearchKeyword ? '搜索结果为空，无数据可导出' : '暂无数据可导出');
                return;
            }

            // 构建用户信息映射
            const userMap = {};
            allUsers.forEach(u => {
                userMap[u.email] = u;
            });

            let exportData;
            const timestamp = new Date().toISOString().slice(0, 10);
            // 文件名添加搜索标识
            const searchSuffix = currentSearchKeyword ? `_search_${currentSearchKeyword.substring(0, 20)}` : '';

            if (type === 'user') {
                // 只导出用户输入
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || '未知',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        user_messages: (s.messages || []).filter(m => m.role === 'user').map(m => m.content)
                    };
                });
            } else {
                // 导出全部对话
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || '未知',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        messages: s.messages
                    };
                });
            }

            if (format === 'json') {
                downloadFile(
                    JSON.stringify(exportData, null, 2),
                    `chat_${type}${searchSuffix}_${timestamp}.json`,
                    'application/json'
                );
            } else {
                // CSV 格式
                const csvContent = convertToCSV(exportData, type);
                downloadFile(csvContent, `chat_${type}${searchSuffix}_${timestamp}.csv`, 'text/csv');
            }
        }

        // 转换为 CSV
        function convertToCSV(data, type) {
            let rows = [];

            if (type === 'user') {
                rows.push(['会话ID', '用户邮箱', '公司名称', '职位', '模块', '时间', '用户输入']);
                data.forEach(s => {
                    (s.user_messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            } else {
                rows.push(['会话ID', '用户邮箱', '公司名称', '职位', '模块', '时间', '角色', '内容']);
                data.forEach(s => {
                    (s.messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.role === 'user' ? '用户' : 'AI',
                            msg.content.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            }

            return rows.map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
        }

        // 下载文件
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 格式化时间
        function formatTime(str) {
            if (!str) return '-';
            const d = new Date(str);
            return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        // HTML 转义
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ========================================
        // 提示词管理功能
        // ========================================

        let allModules = [];
        let currentModuleId = null;

        // 加载模块列表
        async function loadModules() {
            try {
                const res = await fetch('/api/admin/modules');
                const data = await res.json();

                if (data.success) {
                    allModules = data.modules || [];
                    renderModuleList();
                }
            } catch (e) {
                console.error('加载模块失败', e);
            }
        }

        // 渲染模块列表
        function renderModuleList() {
            const container = document.getElementById('moduleListItems');

            if (allModules.length === 0) {
                container.innerHTML = '<p class="loading">暂无模块</p>';
                return;
            }

            container.innerHTML = allModules.map(m => `
                <div class="module-item ${currentModuleId === m.id ? 'active' : ''}"
                     onclick="selectModule('${m.id}')">
                    <div class="module-icon" style="background: ${m.color}20; color: ${m.color};">
                        ${m.icon || '📋'}
                    </div>
                    <div class="module-item-info">
                        <div class="module-item-name">${m.name}</div>
                        <div class="module-item-desc">${m.description || ''}</div>
                    </div>
                    <button class="btn-delete-module" onclick="event.stopPropagation(); deleteModule('${m.id}', '${m.name}')" title="删除模块">×</button>
                </div>
            `).join('');
        }

        // 删除模块
        async function deleteModule(moduleId, moduleName) {
            if (!confirm(`确定要删除模块「${moduleName}」吗？\n\n删除后首页将不再显示该模块。`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/modules/${moduleId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    alert('模块已删除');
                    // 如果删除的是当前选中的模块，清除选择
                    if (currentModuleId === moduleId) {
                        currentModuleId = null;
                        document.getElementById('promptEditor').style.display = 'none';
                        document.getElementById('promptPlaceholder').style.display = 'block';
                    }
                    // 重新加载模块列表
                    await loadModules();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // 选择模块
        async function selectModule(moduleId) {
            currentModuleId = moduleId;
            const module = allModules.find(m => m.id === moduleId);

            if (!module) return;

            // 更新UI
            document.getElementById('promptEditor').style.display = 'block';
            document.getElementById('promptPlaceholder').style.display = 'none';
            document.getElementById('currentModuleIcon').textContent = module.icon || '📋';
            document.getElementById('currentModuleName').value = module.name;
            document.getElementById('promptSaveStatus').textContent = '';

            // 更新模块列表高亮
            renderModuleList();

            // 加载提示词
            await loadPrompt(moduleId);

            // 加载知识库
            await loadKnowledge(moduleId);
        }

        // 加载提示词
        async function loadPrompt(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/prompt`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('promptTextarea').value = data.prompt || '';
                }
            } catch (e) {
                console.error('加载提示词失败', e);
            }
        }

        // 保存提示词
        async function savePrompt() {
            if (!currentModuleId) return;

            const prompt = document.getElementById('promptTextarea').value;
            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = '保存中...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 保存成功';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // 保存模块名称
        async function saveModuleName() {
            if (!currentModuleId) return;

            const nameInput = document.getElementById('currentModuleName');
            const newName = nameInput.value.trim();
            const statusEl = document.getElementById('promptSaveStatus');

            if (!newName) {
                // 如果名称为空，恢复原名称
                const module = allModules.find(m => m.id === currentModuleId);
                if (module) {
                    nameInput.value = module.name;
                }
                return;
            }

            // 检查名称是否改变
            const module = allModules.find(m => m.id === currentModuleId);
            if (module && module.name === newName) {
                return; // 名称未变，不需要保存
            }

            try {
                statusEl.textContent = '保存模块名称...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 模块名称已保存';
                    statusEl.style.color = '#10b981';
                    // 更新本地数据并重新渲染列表
                    if (module) {
                        module.name = newName;
                    }
                    renderModuleList();
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // 切换提示词/知识库标签
        function switchPromptTab(tab) {
            document.querySelectorAll('.prompt-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('promptContent').style.display = tab === 'prompt' ? 'block' : 'none';
            document.getElementById('knowledgeContent').style.display = tab === 'knowledge' ? 'block' : 'none';
        }

        // 加载知识库文件
        async function loadKnowledge(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/knowledge`);
                const data = await res.json();

                const container = document.getElementById('knowledgeList');

                if (data.success && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = getFileIcon(f.file_type);
                        return `
                            <div class="knowledge-item">
                                <div class="knowledge-item-info">
                                    <span class="knowledge-icon">${icon}</span>
                                    <div>
                                        <div class="knowledge-name">${f.filename}</div>
                                        <div class="knowledge-meta">${formatTime(f.created_at)}</div>
                                    </div>
                                </div>
                                <button class="btn-delete-knowledge" onclick="deleteKnowledge('${f.id}')">删除</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="loading">暂无知识库文件</p>';
                }
            } catch (e) {
                console.error('加载知识库失败', e);
            }
        }

        // 获取文件图标
        function getFileIcon(type) {
            const icons = {
                'txt': '📄',
                'md': '📝',
                'pdf': '📕',
                'docx': '📘'
            };
            return icons[type] || '📄';
        }

        // 上传知识库文件
        async function uploadKnowledge() {
            if (!currentModuleId) {
                alert('请先选择模块');
                return;
            }

            const input = document.getElementById('knowledgeUpload');
            const file = input.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/admin/modules/${currentModuleId}/knowledge`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert('上传成功');
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('上传失败: ' + data.message);
                }
            } catch (e) {
                alert('网络错误');
            }

            // 清空文件选择
            input.value = '';
        }

        // 删除知识库文件
        async function deleteKnowledge(fileId) {
            if (!confirm('确定要删除这个文件吗？')) return;

            try {
                const res = await fetch(`/api/admin/knowledge/${fileId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // 显示新增模块弹窗
        function showAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'flex';
        }

        // 隐藏新增模块弹窗
        function hideAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            // 清空表单
            document.getElementById('newModuleId').value = '';
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleDesc').value = '';
            document.getElementById('newModuleSubtitle').value = '';
            document.getElementById('newModuleIcon').value = '📊';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
        }

        // 选择 Emoji
        function selectEmoji(emoji) {
            document.getElementById('newModuleIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === emoji);
            });
        }

        // 创建新模块
        async function createModule() {
            const id = document.getElementById('newModuleId').value.trim();
            const name = document.getElementById('newModuleName').value.trim();
            const description = document.getElementById('newModuleDesc').value.trim();
            const subtitle = document.getElementById('newModuleSubtitle').value.trim();
            const icon = document.getElementById('newModuleIcon').value;
            const color = document.getElementById('newModuleColor').value;

            if (!id || !name) {
                alert('请填写模块ID和名称');
                return;
            }

            // 验证 ID 格式（只允许英文、数字、下划线）
            if (!/^[a-z][a-z0-9_]*$/.test(id)) {
                alert('模块ID只能包含小写字母、数字和下划线，且以字母开头');
                return;
            }

            try {
                const res = await fetch('/api/admin/modules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        name,
                        description,
                        subtitle,
                        icon,
                        color,
                        prompt: `## ${name}模块\n\n请在此输入该模块的系统提示词...`
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('模块创建成功！');
                    hideAddModuleModal();
                    await loadModules();
                    // 自动选中新模块
                    selectModule(id);
                } else {
                    alert('创建失败: ' + data.message);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 兑换码管理功能
        // ========================================

        let allRedeemCodes = [];

        async function loadRedeemCodes() {
            try {
                const res = await fetch('/api/admin/redeem/codes');
                const data = await res.json();
                if (data.success) {
                    allRedeemCodes = data.codes;
                    renderRedeemCodes();
                }
            } catch (e) {
                console.error('加载兑换码失败:', e);
            }
        }

        function renderRedeemCodes() {
            const container = document.getElementById('redeemCodesList');
            if (allRedeemCodes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无兑换码</p>';
                return;
            }

            container.innerHTML = allRedeemCodes.map(code => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value">${code.code}</div>
                        <div class="redeem-code-meta">
                            目标: ${code.target_name} |
                            ${code.cat_coins ? code.cat_coins + '猫币 → ' : ''}${code.credits} 积分 |
                            创建: ${code.created_by} | ${formatTime(code.created_at)}
                            ${code.note ? ' | ' + code.note : ''}
                        </div>
                    </div>
                    <span class="redeem-code-status ${code.is_used ? 'status-used' : 'status-unused'}">
                        ${code.is_used ? '已使用' : '未使用'}
                    </span>
                    <button class="btn-delete-code" onclick="deleteRedeemCode('${code.id}')" ${code.is_used ? 'disabled' : ''}>
                        删除
                    </button>
                </div>
            `).join('');
        }

        // 计算猫币兑换积分
        function calculateCreditsFromCatCoins(catCoins) {
            if (catCoins <= 0) return 0;
            // 每个猫币 = 20积分
            return catCoins * 20;
        }

        // 更新兑换预览
        function updateRedeemPreview() {
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const preview = document.getElementById('redeemPreview');
            if (catCoins > 0) {
                const credits = calculateCreditsFromCatCoins(catCoins);
                preview.innerHTML = `<strong>${catCoins} 个猫币 = ${credits} 积分</strong>（约 ${Math.floor(credits / 2)} 次回答机会）`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // 切换用户类型
        function toggleRedeemType() {
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const businessSchoolInfo = document.getElementById('businessSchoolInfo');
            const catCoinsInputGroup = document.getElementById('catCoinsInputGroup');
            const typeBusinessSchoolLabel = document.getElementById('typeBusinessSchoolLabel');
            const typeCatCoinsLabel = document.getElementById('typeCatCoinsLabel');

            if (userType === 'business_school') {
                businessSchoolInfo.style.display = 'block';
                catCoinsInputGroup.style.display = 'none';
                typeBusinessSchoolLabel.style.borderColor = '#444746';
                typeCatCoinsLabel.style.borderColor = 'transparent';
            } else {
                businessSchoolInfo.style.display = 'none';
                catCoinsInputGroup.style.display = 'block';
                typeBusinessSchoolLabel.style.borderColor = 'transparent';
                typeCatCoinsLabel.style.borderColor = '#444746';
            }
        }

        async function createRedeemCode() {
            const targetName = document.getElementById('redeemTargetName').value.trim();
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const note = document.getElementById('redeemNote').value.trim();

            if (!targetName) {
                alert('请输入目标用户姓名');
                return;
            }

            // 猫币兑换模式需要输入猫币数量
            if (userType === 'cat_coins' && (!catCoins || catCoins <= 0)) {
                alert('请输入猫币数量');
                return;
            }

            try {
                const requestBody = {
                    target_name: targetName,
                    note,
                    user_type: userType
                };

                // 根据类型设置积分
                if (userType === 'business_school') {
                    requestBody.credits = 2000;  // 商学院固定2000积分
                } else {
                    requestBody.cat_coins = catCoins;
                }

                const res = await fetch('/api/admin/redeem/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    // 显示生成的兑换码
                    document.getElementById('generatedCode').textContent = data.code.code;
                    const creditsInfo = userType === 'business_school'
                        ? '商学院学员 → 2000 积分'
                        : `${catCoins} 猫币 → ${data.code.credits} 积分`;
                    document.getElementById('generatedCredits').textContent = creditsInfo;
                    document.getElementById('redeemResult').style.display = 'block';
                    // 清空表单
                    document.getElementById('redeemTargetName').value = '';
                    document.getElementById('redeemCatCoins').value = '';
                    document.getElementById('redeemNote').value = '';
                    document.getElementById('redeemPreview').style.display = 'none';
                    // 刷新列表
                    loadRedeemCodes();
                } else {
                    alert('生成失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        function copyRedeemCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('兑换码已复制: ' + code);
            });
        }

        // 批量生成的兑换码列表（用于复制）
        let batchGeneratedCodes = [];

        async function batchCreateRedeemCodes() {
            const credits = parseInt(document.getElementById('batchCredits').value) || 0;
            const count = parseInt(document.getElementById('batchCount').value) || 0;
            const note = document.getElementById('batchNote').value.trim();

            if (credits <= 0) {
                alert('请输入积分数量');
                return;
            }

            if (count <= 0 || count > 100) {
                alert('生成数量必须在1-100之间');
                return;
            }

            try {
                const res = await fetch('/api/admin/redeem/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credits, count, note })
                });
                const data = await res.json();

                if (data.success) {
                    batchGeneratedCodes = data.codes.map(c => c.code);

                    // 显示结果
                    document.getElementById('batchResultTitle').textContent =
                        `成功生成 ${data.codes.length} 个兑换码（每个 ${credits} 积分）`;

                    // 显示兑换码列表
                    const listHtml = data.codes.map(c =>
                        `<div style="font-family: monospace; padding: 4px 0; color: var(--accent-blue);">${c.code}</div>`
                    ).join('');
                    document.getElementById('batchCodesList').innerHTML = listHtml;

                    document.getElementById('batchResult').style.display = 'block';

                    // 清空表单
                    document.getElementById('batchCredits').value = '';
                    document.getElementById('batchCount').value = '';
                    document.getElementById('batchNote').value = '';

                    // 刷新列表
                    loadRedeemCodes();
                } else {
                    alert('生成失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        function copyBatchCodes() {
            if (batchGeneratedCodes.length === 0) {
                alert('没有可复制的兑换码');
                return;
            }
            const codesText = batchGeneratedCodes.join('\n');
            navigator.clipboard.writeText(codesText).then(() => {
                alert(`已复制 ${batchGeneratedCodes.length} 个兑换码`);
            });
        }

        async function deleteRedeemCode(codeId) {
            if (!confirm('确定要删除这个兑换码吗？')) return;

            try {
                const res = await fetch(`/api/admin/redeem/${codeId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadRedeemCodes();
                } else {
                    alert('删除失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 管理员操作日志功能
        // ========================================

        let currentLogType = 'all';

        async function loadAdminLogs(type = 'all') {
            currentLogType = type;
            const container = document.getElementById('adminLogsList');
            container.innerHTML = '<p class="loading">加载中...</p>';

            try {
                const res = await fetch(`/api/admin/logs?type=${type}`);
                const data = await res.json();

                if (data.success) {
                    renderAdminLogs(data.logs || []);
                } else {
                    container.innerHTML = '<p class="loading">加载失败</p>';
                }
            } catch (e) {
                console.error('加载日志失败:', e);
                container.innerHTML = '<p class="loading">加载失败</p>';
            }
        }

        function renderAdminLogs(logs) {
            const container = document.getElementById('adminLogsList');

            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无操作日志</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                // 根据操作类型设置图标
                const icons = {
                    'PROMPT_CREATE': '📝',
                    'PROMPT_UPDATE': '✏️',
                    'PROMPT_DELETE': '🗑️',
                    'MODULE_CREATE': '➕',
                    'MODULE_DELETE': '❌',
                    'REDEEM_CREATE': '🎫',
                    'REDEEM_USED': '✅',
                    'CREDITS_ADD': '💰'
                };
                const icon = icons[log.action_type] || '📋';

                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <div class="log-item-action">
                                ${icon} ${log.action_name || log.action_type}
                                <span class="log-item-target">→ ${log.target || ''}</span>
                            </div>
                            <div class="log-item-details">${log.details || ''}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <span class="log-item-admin">${log.admin_name}</span>
                            <span class="log-item-time">${formatTime(log.created_at)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLogs(type) {
            // 更新按钮状态
            document.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // 加载对应类型的日志
            loadAdminLogs(type);
        }

        // ========================================
        // 管理员用户管理功能
        // ========================================

        let allAdminUsers = [];

        async function loadAdminUsers() {
            const container = document.getElementById('adminsList');
            container.innerHTML = '<p class="loading">加载中...</p>';

            try {
                const res = await fetch('/api/admin/admins');
                const data = await res.json();

                if (data.success) {
                    allAdminUsers = data.admins || [];
                    renderAdminUsers();
                } else {
                    container.innerHTML = '<p class="loading">加载失败: ' + (data.error || '未知错误') + '</p>';
                }
            } catch (e) {
                console.error('加载管理员列表失败:', e);
                container.innerHTML = '<p class="loading">加载失败</p>';
            }
        }

        function renderAdminUsers() {
            const container = document.getElementById('adminsList');

            if (allAdminUsers.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无普通管理员</p>';
                return;
            }

            container.innerHTML = allAdminUsers.map(admin => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value" style="letter-spacing: 0;">${admin.username}</div>
                        <div class="redeem-code-meta">
                            创建者: ${admin.created_by || '-'} |
                            创建时间: ${formatTime(admin.created_at)}
                            ${admin.note ? ' | ' + admin.note : ''}
                        </div>
                    </div>
                    <button class="btn-delete-code" style="background: rgba(168, 199, 250, 0.2); color: #A8C7FA;" onclick="resetAdminPassword('${admin.id}', '${admin.username}')">
                        重置密码
                    </button>
                    <button class="btn-delete-code" onclick="deleteAdmin('${admin.id}', '${admin.username}')">
                        删除
                    </button>
                </div>
            `).join('');
        }

        async function createAdmin() {
            const username = document.getElementById('newAdminUsername').value.trim();
            const note = document.getElementById('newAdminNote').value.trim();

            if (!username) {
                alert('请输入用户名');
                return;
            }

            try {
                const res = await fetch('/api/admin/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, note })
                });
                const data = await res.json();

                if (data.success) {
                    // 显示创建结果
                    document.getElementById('createdAdminName').textContent = username;
                    document.getElementById('adminResult').style.display = 'block';
                    // 清空表单
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminNote').value = '';
                    // 刷新列表
                    loadAdminUsers();
                } else {
                    alert('创建失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        async function deleteAdmin(adminId, username) {
            if (!confirm(`确定要删除管理员「${username}」吗？`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    alert('已删除');
                    loadAdminUsers();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        async function resetAdminPassword(adminId, username) {
            if (!confirm(`确定要重置「${username}」的密码为「maoke2024」吗？`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}/reset-password`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    alert(data.message || '密码已重置为：猫科');
                } else {
                    alert('重置失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }
    </script>
</body>

</html>