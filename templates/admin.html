<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆ°ÁêÜÂêéÂè∞ - ÁîµÂïÜÁÆ°ÁêÜËÆæËÆ°Â∑•ÂÖ∑</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-blue: #6366f1;
            --accent-purple: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* ËÉåÊôØË£ÖÈ•∞ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% -20%, rgba(99, 102, 241, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139, 92, 246, 0.1), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ========== ‰æßËæπÊ†è ========== */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.95) 0%, rgba(10, 10, 15, 0.98) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            color: var(--text-primary);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .nav-item.active .nav-icon {
            color: var(--accent-blue);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border-color);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn-logout-small {
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout-small:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ========== ‰∏ªÂÜÖÂÆπÂå∫ ========== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            padding: 24px 32px;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .page-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========== ÁªüËÆ°Âç°Áâá ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.users { background: rgba(99, 102, 241, 0.15); }
        .stat-icon.sessions { background: rgba(34, 211, 238, 0.15); }
        .stat-icon.messages { background: rgba(16, 185, 129, 0.15); }

        .stat-number {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== ÂÜÖÂÆπÈù¢Êùø ========== */
        .content-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-body {
            padding: 24px;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* ÁôªÂΩïÊ°Ü - Áé∞‰ª£ÁéªÁíÉÈ£éÊ†º */
        .login-box {
            max-width: 420px;
            margin: 100px auto;
            background: var(--bg-card);
            padding: 48px 40px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 10;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            border-radius: 0 0 4px 4px;
        }

        .login-box h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text-primary);
        }

        .login-box .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .login-box input::placeholder {
            color: var(--text-muted);
        }

        .login-box button {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .error-msg {
            color: var(--accent-red);
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }

        /* ÁÆ°ÁêÜÈù¢Êùø */
        .admin-panel {
            display: none;
        }

        .admin-header {
            display: none;
        }

        /* ÈöêËóèÊóßÁöÑtabsÂíåstats */
        .tabs {
            display: none !important;
        }

        .stats {
            display: none !important;
        }

        /* Áî®Êà∑Âç°Áâá - Áé∞‰ª£È£éÊ†º */
        .user-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
            transform: translateX(4px);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .user-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .tag-company {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
        }

        .tag-position {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
        }

        .tag-credits {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        .tag-credits-low {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        .tag-sessions {
            background: rgba(161, 161, 170, 0.1);
            border-color: rgba(161, 161, 170, 0.3);
            color: var(--text-secondary);
        }

        .user-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .user-stat {
            text-align: center;
        }

        .user-stat-num {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ‰ºöËØùÂç°Áâá - Áé∞‰ª£È£éÊ†º */
        .session-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .session-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-user {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .clickable-user {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-user:hover {
            text-decoration: underline;
            color: #0066ff;
            transform: translateX(2px);
        }

        .session-company {
            padding: 3px 10px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-position {
            padding: 3px 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-module {
            padding: 4px 12px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Ê∂àÊÅØÂàóË°® - Áé∞‰ª£È£éÊ†º */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .msg-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .msg-user {
            background: var(--bg-card-hover);
        }

        .msg-assistant {
            background: transparent;
            border: 1px solid var(--border-color);
        }

        .msg-role {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* ÊåâÈíÆ - Áé∞‰ª£È£éÊ†º */
        .btn-expand {
            padding: 8px 14px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-expand:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* ÊèêÁ§∫ËØçÁÆ°ÁêÜÊ†∑Âºè - Áé∞‰ª£È£éÊ†º */
        .prompt-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .module-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
        }

        .module-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .module-list-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn-add-module {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-module:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .module-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .module-item:hover {
            background: var(--bg-card-hover);
        }

        .module-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .module-icon {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 18px;
        }

        .module-item-info {
            flex: 1;
        }

        .module-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .module-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .btn-delete-module {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-item:hover .btn-delete-module {
            opacity: 1;
        }

        .btn-delete-module:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .prompt-editor {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .prompt-editor-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            font-family: inherit;
            padding: 6px 12px;
            outline: none;
            transition: all 0.2s;
            min-width: 120px;
            max-width: 300px;
        }

        .module-name-input:hover {
            border-color: var(--border-color);
            background: var(--bg-card-hover);
        }

        .module-name-input:focus {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .prompt-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .prompt-tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .prompt-tab-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .prompt-tab-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
            font-weight: 500;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-save-prompt {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save-prompt:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Áü•ËØÜÂ∫ìÊ†∑Âºè - Áé∞‰ª£È£éÊ†º */
        .knowledge-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .knowledge-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .knowledge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
        }

        .knowledge-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .knowledge-icon {
            font-size: 20px;
        }

        .knowledge-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .knowledge-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .btn-delete-knowledge {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-delete-knowledge:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-zone label {
            cursor: pointer;
            color: var(--text-secondary);
        }

        .upload-zone label strong {
            color: var(--accent-blue);
        }

        /* Êñ∞Ê®°ÂùóÂºπÁ™ó - Áé∞‰ª£È£éÊ†º */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-form .form-group {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-cancel {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-modal-cancel:hover {
            background: var(--bg-card-hover);
        }

        .btn-modal-submit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .emoji-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .emoji-option:hover,
        .emoji-option.selected {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Áî®Êà∑ÁîªÂÉèÊ®°ÊÄÅÊ°Ü */
        .user-profile-modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 0;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .user-profile-modal-content .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .user-profile-modal-content .modal-header h2 {
            margin: 0;
        }

        .user-profile-modal-content .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card-hover);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner p {
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .profile-content ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .profile-content li {
            margin-bottom: 8px;
        }

        .profile-stat {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* ÊêúÁ¥¢ÂíåÂØºÂá∫Ê†è - Áé∞‰ª£È£éÊ†º */
        .search-export-bar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 280px;
            max-width: 500px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            color: var(--bg-primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .search-clear-btn:hover {
            background: var(--text-secondary);
        }

        .search-result-count {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .search-result-count.has-results {
            color: var(--accent-green);
        }

        .export-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-export {
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-export-user {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .btn-export-user:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Áî®Êà∑ËØ¶ÊÉÖÈù¢Êùø - Áé∞‰ª£È£éÊ†º */
        .user-detail-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-detail-info h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            color: var(--accent-blue);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-detail-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-back {
            padding: 10px 18px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: var(--bg-card-hover);
        }

        .btn-user-profile {
            padding: 10px 18px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-user-profile:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn-user-profile:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-export-single {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-export-single:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* ÂÖëÊç¢Á†ÅÁÆ°ÁêÜÊ†∑Âºè - Áé∞‰ª£È£éÊ†º */
        .redeem-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .redeem-form-card,
        .redeem-list-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .redeem-form-card h3,
        .redeem-list-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .redeem-form .form-row {
            display: flex;
            gap: 16px;
        }

        .redeem-form .form-group {
            flex: 1;
            margin-bottom: 16px;
        }

        .redeem-form label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .redeem-form input,
        .redeem-form select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .redeem-form input:focus,
        .redeem-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-create-code {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-create-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .redeem-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            text-align: center;
        }

        .result-code {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
            letter-spacing: 4px;
            margin-bottom: 12px;
        }

        .btn-copy-code {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .redeem-codes-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .redeem-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .redeem-code-info {
            flex: 1;
        }

        .redeem-code-value {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-blue);
            letter-spacing: 2px;
        }

        .redeem-code-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .redeem-code-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 12px;
        }

        .status-unused {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .status-used {
            background: rgba(161, 161, 170, 0.15);
            color: var(--text-muted);
        }

        .btn-delete-code {
            padding: 8px 14px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-delete-code:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-delete-code:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Êó•ÂøóÁ≠õÈÄâÊåâÈíÆ - Áé∞‰ª£È£éÊ†º */
        .log-filter-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .log-filter-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .log-filter-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
        }

        /* Êó•ÂøóÂàóË°®È°π */
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .log-item-info {
            flex: 1;
        }

        .log-item-action {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .log-item-target {
            color: var(--accent-blue);
            font-weight: 500;
        }

        .log-item-details {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.5;
        }

        .log-item-admin {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .log-item-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- ÁôªÂΩïÊ°Ü -->
    <div class="login-box" id="loginBox">
        <h1>ÁÆ°ÁêÜÂêéÂè∞</h1>
        <p class="login-subtitle">ÁîµÂïÜÁÆ°ÁêÜËÆæËÆ°Â∑•ÂÖ∑</p>
        <input type="text" id="adminUsername" placeholder="Áî®Êà∑Âêç"
            onkeydown="if(event.key==='Enter')document.getElementById('adminPassword').focus()">
        <input type="password" id="adminPassword" placeholder="ÂØÜÁ†Å"
            onkeydown="if(event.key==='Enter')adminLogin()">
        <button onclick="adminLogin()">ÁôªÂΩï</button>
        <p class="error-msg" id="loginError"></p>
    </div>

    <!-- ÁÆ°ÁêÜÈù¢ÊùøÔºà‰æßËæπÊ†èÂ∏ÉÂ±ÄÔºâ -->
    <div class="app-container" id="adminPanel">
        <!-- ‰æßËæπÊ†è -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">‚ö°</div>
                    <div>
                        <div class="logo-text">Admin Panel</div>
                        <div class="logo-subtitle">ÁîµÂïÜÁÆ°ÁêÜËÆæËÆ°Â∑•ÂÖ∑</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Êï∞ÊçÆÊ¶ÇËßà</div>
                    <div class="nav-item active" onclick="switchTab('users')" data-tab="users" data-role="super">
                        <span class="nav-icon">üë•</span>
                        <span>Áî®Êà∑ÂàóË°®</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('sessions')" data-tab="sessions" data-role="super">
                        <span class="nav-icon">üí¨</span>
                        <span>ËÅäÂ§©ËÆ∞ÂΩï</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">ÂÜÖÂÆπÁÆ°ÁêÜ</div>
                    <div class="nav-item" onclick="switchTab('prompts')" data-tab="prompts" data-role="super">
                        <span class="nav-icon">üìù</span>
                        <span>ÊèêÁ§∫ËØçÁÆ°ÁêÜ</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('redeem')" data-tab="redeem" data-role="all">
                        <span class="nav-icon">üé´</span>
                        <span>ÂÖëÊç¢Á†ÅÁÆ°ÁêÜ</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Á≥ªÁªüËÆæÁΩÆ</div>
                    <div class="nav-item" onclick="switchTab('admins')" data-tab="admins" data-role="super">
                        <span class="nav-icon">üë§</span>
                        <span>ÁÆ°ÁêÜÂëòÁÆ°ÁêÜ</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('logs')" data-tab="logs" data-role="super">
                        <span class="nav-icon">üìã</span>
                        <span>Êìç‰ΩúÊó•Âøó</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Admin</div>
                        <div class="user-role" id="adminRoleText">Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò</div>
                    </div>
                    <button class="btn-logout-small" onclick="adminLogout()">ÈÄÄÂá∫</button>
                </div>
            </div>
        </aside>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <main class="main-content">
            <!-- È°µÈù¢Ê†áÈ¢ò -->
            <div class="main-header">
                <div>
                    <h1 class="page-title" id="pageTitle">Áî®Êà∑ÂàóË°®</h1>
                    <p class="page-subtitle" id="pageSubtitle">ÁÆ°ÁêÜÊâÄÊúâÊ≥®ÂÜåÁî®Êà∑</p>
                </div>
            </div>

            <!-- ÁªüËÆ°Âç°Áâá -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon users">üë•</div>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Ê≥®ÂÜåÁî®Êà∑</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon sessions">üí¨</div>
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">ÂØπËØù‰ºöËØù</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon messages">üì®</div>
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                </div>
            </div>

            <!-- Áî®Êà∑ËØ¶ÊÉÖÈù¢Êùø -->
            <div class="user-detail-panel" id="userDetailPanel">
                <div class="user-detail-header">
                    <div class="user-detail-info">
                        <h2 id="detailUserEmail">Áî®Êà∑ÈÇÆÁÆ±</h2>
                        <div class="user-detail-meta">
                            <span class="tag tag-company" id="detailUserCompany"></span>
                            <span class="tag tag-position" id="detailUserPosition"></span>
                            <span class="tag tag-credits" id="detailUserCredits"></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-back" onclick="hideUserDetail()">‚Üê ËøîÂõûÂàóË°®</button>
                        <button class="btn-user-profile" onclick="generateUserProfile()">üéØ ÁîüÊàêÁî®Êà∑ÁîªÂÉè</button>
                        <button class="btn-export-single" onclick="exportUserSessions()">ÂØºÂá∫ËØ•Áî®Êà∑ÂÖ®ÈÉ®ÂØπËØù</button>
                    </div>
                </div>
                <div id="userSessionsList"></div>
            </div>

            <!-- ÊêúÁ¥¢ÂíåÂØºÂá∫Ê†èÔºàËÅäÂ§©ËÆ∞ÂΩïÊ†áÁ≠æ‰∏ãÊòæÁ§∫Ôºâ -->
            <div class="search-export-bar" id="exportBar" style="display: none;">
                <!-- ÊêúÁ¥¢Âå∫Âüü -->
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="sessionSearchInput" class="search-input"
                            placeholder="ÊêúÁ¥¢Áî®Êà∑ÈÇÆÁÆ±„ÄÅÂÖ¨Âè∏„ÄÅÊ∂àÊÅØÂÜÖÂÆπ..."
                            oninput="handleSessionSearch()">
                        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                            ‚úï
                        </button>
                    </div>
                    <span class="search-result-count" id="searchResultCount"></span>
                </div>
                <!-- ÂØºÂá∫Âå∫Âüü -->
                <div class="export-section">
                    <span class="export-label">ÂØºÂá∫Êï∞ÊçÆÔºö</span>
                    <button class="btn-export" onclick="exportChat('all', 'json')">ÂÖ®ÈÉ®ÂØπËØù (JSON)</button>
                    <button class="btn-export" onclick="exportChat('all', 'csv')">ÂÖ®ÈÉ®ÂØπËØù (CSV)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'json')">‰ªÖÁî®Êà∑ËæìÂÖ• (JSON)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'csv')">‰ªÖÁî®Êà∑ËæìÂÖ• (CSV)</button>
                </div>
            </div>

            <!-- Áî®Êà∑ÂàóË°® -->
            <div id="usersTab">
                <div id="usersList"></div>
            </div>

            <!-- ‰ºöËØùÂàóË°® -->
            <div id="sessionsTab" class="hidden">
                <div id="sessionsList"></div>
            </div>

            <!-- ÊèêÁ§∫ËØçÁÆ°ÁêÜ -->
            <div id="promptsTab" class="hidden">
                <div class="prompt-container">
                    <!-- Ê®°ÂùóÂàóË°® -->
                    <div class="module-list">
                        <div class="module-list-header">
                            <h3>Ê®°ÂùóÂàóË°®</h3>
                            <button class="btn-add-module" onclick="showAddModuleModal()">+ Êñ∞Â¢ûÊ®°Âùó</button>
                        </div>
                        <div id="moduleListItems">
                            <p class="loading">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>

                    <!-- ÊèêÁ§∫ËØçÁºñËæëÂô® -->
                    <div class="prompt-editor" id="promptEditor" style="display: none;">
                        <div class="prompt-editor-header">
                            <div class="prompt-editor-title">
                                <span id="currentModuleIcon" style="font-size: 24px;"></span>
                                <input type="text" id="currentModuleName" class="module-name-input" value=""
                                    placeholder="Ê®°ÂùóÂêçÁß∞" onblur="saveModuleName()"
                                    onkeydown="if(event.key==='Enter'){this.blur()}">
                            </div>
                            <button class="btn-save-prompt" onclick="savePrompt()">‰øùÂ≠òÊèêÁ§∫ËØç</button>
                        </div>

                        <div class="prompt-tabs">
                            <button class="prompt-tab-btn active" onclick="switchPromptTab('prompt')">Á≥ªÁªüÊèêÁ§∫ËØç</button>
                            <button class="prompt-tab-btn" onclick="switchPromptTab('knowledge')">Áü•ËØÜÂ∫ì</button>
                        </div>

                        <!-- ÊèêÁ§∫ËØçÁºñËæë -->
                        <div id="promptContent">
                            <textarea class="prompt-textarea" id="promptTextarea"
                                placeholder="ËæìÂÖ•ËØ•Ê®°ÂùóÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç..."></textarea>
                        </div>

                        <!-- Áü•ËØÜÂ∫ìÁÆ°ÁêÜ -->
                        <div id="knowledgeContent" style="display: none;">
                            <div class="knowledge-section">
                                <div class="knowledge-header">
                                    <h3>Áü•ËØÜÂ∫ìÊñá‰ª∂</h3>
                                </div>
                                <div class="knowledge-list" id="knowledgeList">
                                    <p class="loading">ÊöÇÊó†Áü•ËØÜÂ∫ìÊñá‰ª∂</p>
                                </div>
                                <div class="upload-zone">
                                    <input type="file" id="knowledgeUpload" accept=".txt,.md,.pdf,.docx"
                                        onchange="uploadKnowledge()">
                                    <label for="knowledgeUpload">
                                        üìÅ ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Êñá‰ª∂<br>
                                        <small>ÊîØÊåÅ TXT„ÄÅMD„ÄÅPDF„ÄÅDOCX Ê†ºÂºè</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p id="promptSaveStatus" style="margin-top: 12px; font-size: 13px; color: #10b981;"></p>
                    </div>

                    <!-- Êú™ÈÄâÊã©Ê®°ÂùóÊó∂ÁöÑÂç†‰Ωç -->
                    <div class="prompt-editor" id="promptPlaceholder">
                        <div style="text-align: center; padding: 100px 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üëà</div>
                            <p>ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Ê®°ÂùóËøõË°åÁºñËæë</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂÖëÊç¢Á†ÅÁÆ°ÁêÜ -->
            <div id="redeemTab" class="hidden">
                <div class="redeem-container">
                    <!-- ÂàõÂª∫ÂÖëÊç¢Á†ÅË°®Âçï -->
                    <div class="redeem-form-card">
                        <h3>ÁîüÊàêÂÖëÊç¢Á†Å</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>ÁõÆÊ†áÁî®Êà∑ÂßìÂêç</label>
                                <input type="text" id="redeemTargetName" placeholder="ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                            </div>

                            <!-- Áî®Êà∑Á±ªÂûãÈÄâÊã© -->
                            <div class="form-group">
                                <label>Áî®Êà∑Á±ªÂûã</label>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid #444746;"
                                        id="typeBusinessSchoolLabel">
                                        <input type="radio" name="redeemUserType" value="business_school"
                                            onchange="toggleRedeemType()" checked>
                                        <span>üéì ÂïÜÂ≠¶Èô¢Â≠¶Âëò</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid transparent;"
                                        id="typeCatCoinsLabel">
                                        <input type="radio" name="redeemUserType" value="cat_coins"
                                            onchange="toggleRedeemType()">
                                        <span>üê± Áå´Â∏ÅÂÖëÊç¢</span>
                                    </label>
                                </div>
                            </div>

                            <!-- ÂïÜÂ≠¶Èô¢Áî®Êà∑ÁßØÂàÜÊòæÁ§∫ -->
                            <div class="form-group" id="businessSchoolInfo">
                                <div
                                    style="padding: 16px; background: rgba(129, 201, 149, 0.15); border-radius: 12px; border: 1px solid #81C995;">
                                    <div style="font-size: 16px; font-weight: 600; color: #81C995; margin-bottom: 8px;">
                                        üéì ÂïÜÂ≠¶Èô¢Â≠¶Âëò‰∏ìÂ±û</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #E3E3E3;">2000 ÁßØÂàÜ</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">Á∫¶ 1000 Ê¨°ÂõûÁ≠îÊú∫‰ºö</div>
                                </div>
                            </div>

                            <!-- Áå´Â∏ÅËæìÂÖ•Ôºà‰ªÖÁå´Â∏ÅÂÖëÊç¢Êó∂ÊòæÁ§∫Ôºâ -->
                            <div class="form-group" id="catCoinsInputGroup" style="display: none;">
                                <label>Áå´Â∏ÅÊï∞Èáè</label>
                                <input type="number" id="redeemCatCoins" placeholder="ËæìÂÖ•Áå´Â∏ÅÊï∞Èáè" min="1"
                                    oninput="updateRedeemPreview()">
                                <div class="cat-coin-preview" id="redeemPreview"
                                    style="padding: 12px; background: rgba(129, 201, 149, 0.1); border-radius: 8px; color: #81C995; font-size: 14px; display: none; margin-top: 8px;">
                                </div>
                                <div
                                    style="padding: 12px; background: #282A2C; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #C4C7C5;">
                                    <div style="font-weight: 500; margin-bottom: 8px; color: #E3E3E3;">üí° Áå´Â∏ÅÂÖëÊç¢ËßÑÂàô</div>
                                    <div>‚Ä¢ ÊØè‰∏™Áå´Â∏Å = 20ÁßØÂàÜ</div>
                                    <div style="margin-top: 8px; color: #81C995;">Á§∫‰æãÔºö5Áå´Â∏Å = 100ÁßØÂàÜÔºàÁ∫¶50Ê¨°ÂõûÁ≠îÊú∫‰ºöÔºâ</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
                                <input type="text" id="redeemNote" placeholder="Â¶ÇÔºöÁå´ËØæÂ≠¶Âëò„ÄÅVIPÂÆ¢Êà∑Á≠â">
                            </div>
                            <button class="btn-create-code" onclick="createRedeemCode()">ÁîüÊàêÂÖëÊç¢Á†Å</button>
                        </div>
                        <!-- ÁîüÊàêÁªìÊûú -->
                        <div id="redeemResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="generatedCode"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;" id="generatedCredits">
                            </div>
                            <button class="btn-copy-code" onclick="copyRedeemCode()">Â§çÂà∂ÂÖëÊç¢Á†Å</button>
                        </div>

                        <!-- ÊâπÈáèÁîüÊàêÂàÜÈöîÁ∫ø -->
                        <div style="border-top: 1px solid var(--border-color); margin: 24px 0; padding-top: 24px;">
                            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">ÊâπÈáèÁîüÊàêÂÖëÊç¢Á†Å</h3>
                            <div class="redeem-form">
                                <div style="display: flex; gap: 12px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>ÁßØÂàÜÊï∞Èáè</label>
                                        <input type="number" id="batchCredits" placeholder="ÊØè‰∏™ÂÖëÊç¢Á†ÅÁöÑÁßØÂàÜ" min="1">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>ÁîüÊàêÊï∞Èáè</label>
                                        <input type="number" id="batchCount" placeholder="1-100" min="1" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
                                    <input type="text" id="batchNote" placeholder="Â¶ÇÔºöÊ¥ªÂä®Ëµ†ÈÄÅ„ÄÅÊâπÈáèÂèëÊîæÁ≠â">
                                </div>
                                <button class="btn-create-code" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="batchCreateRedeemCodes()">ÊâπÈáèÁîüÊàê</button>
                            </div>
                            <!-- ÊâπÈáèÁîüÊàêÁªìÊûú -->
                            <div id="batchResult" class="redeem-result" style="display: none;">
                                <div style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 12px;" id="batchResultTitle"></div>
                                <div id="batchCodesList" style="max-height: 200px; overflow-y: auto; text-align: left; background: var(--bg-primary); border-radius: 8px; padding: 12px;"></div>
                                <button class="btn-copy-code" style="margin-top: 12px;" onclick="copyBatchCodes()">Â§çÂà∂ÂÖ®ÈÉ®ÂÖëÊç¢Á†Å</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÖëÊç¢Á†ÅÂàóË°® -->
                    <div class="redeem-list-card">
                        <h3>ÂÖëÊç¢Á†ÅËÆ∞ÂΩï</h3>
                        <div id="redeemCodesList" class="redeem-codes-list">
                            <p class="loading">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊó•Âøó -->
            <div id="logsTab" class="hidden">
                <div class="logs-container">
                    <!-- Êó•ÂøóÁ≠õÈÄâ -->
                    <div class="logs-filter" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="log-filter-btn active" onclick="filterLogs('all')">ÂÖ®ÈÉ®Êó•Âøó</button>
                        <button class="log-filter-btn" onclick="filterLogs('redeem')">ÂÖëÊç¢Á†ÅÁÆ°ÁêÜ</button>
                        <button class="log-filter-btn" onclick="filterLogs('user_redeem')">Áî®Êà∑ÂÖëÊç¢</button>
                        <button class="log-filter-btn" onclick="filterLogs('prompt')">ÊèêÁ§∫ËØçÊìç‰Ωú</button>
                    </div>
                    <!-- Êó•ÂøóÂàóË°® -->
                    <div class="logs-list-card" style="background: #1E1F20; border-radius: 16px; padding: 24px;">
                        <h3
                            style="font-size: 16px; color: #E3E3E3; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #444746;">
                            Êìç‰ΩúÊó•Âøó</h3>
                        <div id="adminLogsList" class="admin-logs-list" style="max-height: 600px; overflow-y: auto;">
                            <p class="loading">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÔºà‰ªÖ‰∏ªÁÆ°ÁêÜÂëòÂèØËßÅÔºâ -->
            <div id="adminsTab" class="hidden">
                <div class="redeem-container">
                    <!-- Ê∑ªÂä†ÁÆ°ÁêÜÂëòË°®Âçï -->
                    <div class="redeem-form-card">
                        <h3>Ê∑ªÂä†ÁÆ°ÁêÜÂëò</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>Áî®Êà∑Âêç</label>
                                <input type="text" id="newAdminUsername" placeholder="ËæìÂÖ•Áî®Êà∑Âêç">
                            </div>
                            <div class="form-group">
                                <label>Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
                                <input type="text" id="newAdminNote" placeholder="Â¶ÇÔºöËøêËê•ÁªÑ„ÄÅÈîÄÂîÆÁªÑ">
                            </div>
                            <div class="form-group">
                                <div style="padding: 16px; background: rgba(168, 199, 250, 0.1); border-radius: 12px; border: 1px solid #A8C7FA;">
                                    <div style="font-size: 14px; color: #A8C7FA; margin-bottom: 8px;">üí° ÈªòËÆ§ÂØÜÁ†Å</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #E3E3E3;">maoke2024</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">Êñ∞ÁÆ°ÁêÜÂëòÈ¶ñÊ¨°ÁôªÂΩïËØ∑‰ΩøÁî®Ê≠§ÂØÜÁ†Å</div>
                                </div>
                            </div>
                            <button class="btn-create-code" onclick="createAdmin()">Ê∑ªÂä†ÁÆ°ÁêÜÂëò</button>
                        </div>
                        <!-- Ê∑ªÂä†ÁªìÊûú -->
                        <div id="adminResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="createdAdminName"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;">ÈªòËÆ§ÂØÜÁ†ÅÔºömaoke2024</div>
                        </div>
                    </div>

                    <!-- ÁÆ°ÁêÜÂëòÂàóË°® -->
                    <div class="redeem-list-card">
                        <h3>ÁÆ°ÁêÜÂëòÂàóË°®</h3>
                        <div id="adminsList" class="redeem-codes-list">
                            <p class="loading">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Êñ∞Â¢ûÊ®°ÂùóÂºπÁ™ó -->
    <div class="modal-overlay" id="addModuleModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Êñ∞Â¢ûÊ®°Âùó</h2>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label>Ê®°ÂùóIDÔºàËã±ÊñáÔºåÂ¶Ç customer_researchÔºâ</label>
                    <input type="text" id="newModuleId" placeholder="customer_research">
                </div>
                <div class="form-group">
                    <label>Ê®°ÂùóÂêçÁß∞</label>
                    <input type="text" id="newModuleName" placeholder="ÂÆ¢Êà∑Ë∞ÉÁ†î">
                </div>
                <div class="form-group">
                    <label>Ê®°ÂùóÊèèËø∞</label>
                    <input type="text" id="newModuleDesc" placeholder="Â∏ÆÂä©ÂàÜÊûêÂÆ¢Êà∑ÈúÄÊ±ÇÂíåÂ∏ÇÂú∫ÂèçÈ¶à">
                </div>
                <div class="form-group">
                    <label>ÂâØÊ†áÈ¢ò</label>
                    <input type="text" id="newModuleSubtitle" placeholder="Ê∑±ÂÖ•‰∫ÜËß£ÁõÆÊ†áÂÆ¢Êà∑">
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©ÂõæÊ†á</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" onclick="selectEmoji('üìä')">üìä</span>
                        <span class="emoji-option" onclick="selectEmoji('üéØ')">üéØ</span>
                        <span class="emoji-option" onclick="selectEmoji('üí°')">üí°</span>
                        <span class="emoji-option" onclick="selectEmoji('üìà')">üìà</span>
                        <span class="emoji-option" onclick="selectEmoji('üîç')">üîç</span>
                        <span class="emoji-option" onclick="selectEmoji('üõí')">üõí</span>
                        <span class="emoji-option" onclick="selectEmoji('üë•')">üë•</span>
                        <span class="emoji-option" onclick="selectEmoji('üìù')">üìù</span>
                        <span class="emoji-option" onclick="selectEmoji('üöÄ')">üöÄ</span>
                        <span class="emoji-option" onclick="selectEmoji('‚≠ê')">‚≠ê</span>
                    </div>
                    <input type="hidden" id="newModuleIcon" value="üìä">
                </div>
                <div class="form-group">
                    <label>‰∏ªÈ¢òËâ≤</label>
                    <input type="color" id="newModuleColor" value="#6366f1"
                        style="width: 60px; height: 40px; padding: 4px;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="hideAddModuleModal()">ÂèñÊ∂à</button>
                <button class="btn-modal-submit" onclick="createModule()">ÂàõÂª∫Ê®°Âùó</button>
            </div>
        </div>
    </div>

    <!-- Áî®Êà∑ÁîªÂÉèÊ®°ÊÄÅÊ°Ü -->
    <div id="userProfileModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) hideUserProfileModal()">
        <div class="modal-content user-profile-modal-content">
            <div class="modal-header">
                <h2>üéØ Áî®Êà∑ÁîªÂÉèÂàÜÊûê</h2>
                <button class="modal-close" onclick="hideUserProfileModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="userProfileContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®ÂàÜÊûêÁî®Êà∑ËÅäÂ§©ËÆ∞ÂΩïÔºåËØ∑Á®çÂÄô...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÊï∞ÊçÆ
        let allUsers = [];
        let allSessions = [];
        let currentUserEmail = null;
        let currentAdminRole = 'normal';  // ÂΩìÂâçÁÆ°ÁêÜÂëòËßíËâ≤Ôºö'super' Êàñ 'normal'

        // ÁÆ°ÁêÜÂëòÁôªÂΩï
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
                return;
            }

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    currentAdminRole = data.role || 'normal';
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';

                    // Êõ¥Êñ∞‰æßËæπÊ†èÁî®Êà∑‰ø°ÊÅØ
                    const adminName = username.charAt(0).toUpperCase() + username.slice(1);
                    document.getElementById('adminName').textContent = adminName;
                    document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
                    document.getElementById('adminRoleText').textContent = currentAdminRole === 'super' ? 'Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò' : 'ÊôÆÈÄöÁÆ°ÁêÜÂëò';

                    // Ê†πÊçÆËßíËâ≤ÊòæÁ§∫/ÈöêËóèÊ†áÁ≠æÈ°µ
                    setupTabsForRole(currentAdminRole);

                    // Âä†ËΩΩÊï∞ÊçÆ
                    if (currentAdminRole === 'super') {
                        loadData();
                    } else {
                        // ÊôÆÈÄöÁÆ°ÁêÜÂëòÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂÖëÊç¢Á†ÅÁÆ°ÁêÜ
                        switchTab('redeem');
                        loadRedeemCodes();
                    }
                } else {
                    errorEl.textContent = data.message || data.error;
                }
            } catch (e) {
                errorEl.textContent = 'ÁΩëÁªúÈîôËØØ';
            }
        }

        // Ê†πÊçÆËßíËâ≤ËÆæÁΩÆÊ†áÁ≠æÈ°µÊòæÁ§∫
        function setupTabsForRole(role) {
            const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
            navItems.forEach(item => {
                const itemRole = item.getAttribute('data-role');
                if (itemRole === 'super' && role !== 'super') {
                    item.style.display = 'none';
                } else {
                    item.style.display = '';
                }
            });

            // ÈöêËóèÁªüËÆ°Êï∞ÊçÆÔºàÊôÆÈÄöÁÆ°ÁêÜÂëò‰∏çÊòæÁ§∫Ôºâ
            if (role !== 'super') {
                document.getElementById('statsGrid').style.display = 'none';
            }
        }

        function adminLogout() {
            location.reload();
        }

        // Âä†ËΩΩÊï∞ÊçÆÔºàÂÖàÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÔºåÂÜçÊ∏≤ÊüìÔºâ
        async function loadData() {
            // Âπ∂Ë°åÂä†ËΩΩÁî®Êà∑Âíå‰ºöËØùÊï∞ÊçÆ
            const [usersRes, sessionsRes] = await Promise.all([
                fetch('/api/admin/users').then(r => r.json()).catch(() => ({ success: false })),
                fetch('/api/admin/sessions').then(r => r.json()).catch(() => ({ success: false }))
            ]);

            // ‰øùÂ≠òÊï∞ÊçÆ
            if (usersRes.success) {
                allUsers = usersRes.users || [];
                document.getElementById('totalUsers').textContent = allUsers.length;
            }

            if (sessionsRes.success) {
                allSessions = sessionsRes.sessions || [];
                document.getElementById('totalSessions').textContent = allSessions.length;

                // ËÆ°ÁÆóÊÄªÊ∂àÊÅØÊï∞
                let totalMsgs = 0;
                allSessions.forEach(s => {
                    totalMsgs += (s.messages || []).length;
                });
                document.getElementById('totalMessages').textContent = totalMsgs;
            }

            // Êï∞ÊçÆÈÉΩÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊ∏≤Êüì
            renderUsers();
            renderSessions();
        }

        // Âä†ËΩΩÁî®Êà∑Ôºà‰øùÁïôÁî®‰∫éÂçïÁã¨Âà∑Êñ∞Ôºâ
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                if (data.success) {
                    allUsers = data.users || [];
                    document.getElementById('totalUsers').textContent = allUsers.length;
                    renderUsers();
                }
            } catch (e) {
                console.error('Âä†ËΩΩÁî®Êà∑Â§±Ë¥•', e);
            }
        }

        // Âä†ËΩΩ‰ºöËØùÔºà‰øùÁïôÁî®‰∫éÂçïÁã¨Âà∑Êñ∞Ôºâ
        async function loadSessions() {
            try {
                const res = await fetch('/api/admin/sessions');
                const data = await res.json();

                if (data.success) {
                    allSessions = data.sessions || [];
                    document.getElementById('totalSessions').textContent = allSessions.length;

                    // ËÆ°ÁÆóÊÄªÊ∂àÊÅØÊï∞
                    let totalMsgs = 0;
                    allSessions.forEach(s => {
                        totalMsgs += (s.messages || []).length;
                    });
                    document.getElementById('totalMessages').textContent = totalMsgs;

                    renderSessions();
                }
            } catch (e) {
                console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•', e);
            }
        }

        // Ê∏≤ÊüìÁî®Êà∑ÂàóË°®ÔºàÂ∏¶ÁªüËÆ°‰ø°ÊÅØÔºâ
        function renderUsers() {
            const container = document.getElementById('usersList');

            if (allUsers.length === 0) {
                container.innerHTML = '<p class="loading">ÊöÇÊó†Ê≥®ÂÜåÁî®Êà∑</p>';
                return;
            }

            // ‰∏∫ÊØè‰∏™Áî®Êà∑ÁªüËÆ°‰ºöËØùÊï∞ÂíåÊ∂àÊÅØÊï∞
            const userStats = {};
            allSessions.forEach(s => {
                const email = s.user_email || 'Êú™Áü•';
                if (!userStats[email]) {
                    userStats[email] = { sessions: 0, messages: 0 };
                }
                userStats[email].sessions++;
                userStats[email].messages += (s.messages || []).length;
            });

            container.innerHTML = allUsers.map(user => {
                const email = user.email || 'Êú™Áü•';
                const stats = userStats[email] || { sessions: 0, messages: 0 };
                const credits = user.credits || 0;
                // ÁßØÂàÜÁä∂ÊÄÅÔºö‰Ωé‰∫é 20 ÊòæÁ§∫Ë≠¶Âëä
                const creditsClass = credits < 20 ? 'tag-credits-low' : 'tag-credits';

                return `
                <div class="user-card" onclick="showUserDetail('${email}')">
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-email">${user.nickname || email}</div>
                            <div class="user-tags">
                                ${user.company ? `<span class="tag tag-company">üè¢ ${user.company}</span>` : ''}
                                ${user.position ? `<span class="tag tag-position">üë§ ${user.position}</span>` : ''}
                                <span class="tag ${creditsClass}">üíé ${credits} ÁßØÂàÜ</span>
                                <span class="tag tag-sessions">üí¨ ${stats.sessions} Ê¨°ÂØπËØù</span>
                            </div>
                            <div class="user-meta">
                                Ê≥®ÂÜåÊó∂Èó¥: ${formatTime(user.created_at)}
                            </div>
                        </div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-num" style="color: ${credits < 20 ? '#f28b82' : '#81C995'};">${credits}</div>
                                <div class="user-stat-label">ÁßØÂàÜ</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.sessions}</div>
                                <div class="user-stat-label">ÂØπËØù</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.messages}</div>
                                <div class="user-stat-label">Ê∂àÊÅØ</div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ÊòæÁ§∫Áî®Êà∑ËØ¶ÊÉÖÔºàËØ•Áî®Êà∑ÁöÑÊâÄÊúâÂØπËØùÔºâ
        function showUserDetail(email) {
            currentUserEmail = email;

            // ÊâæÂà∞Áî®Êà∑‰ø°ÊÅØ
            const user = allUsers.find(u => u.email === email) || {};

            // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
            document.getElementById('detailUserEmail').textContent = email;
            document.getElementById('detailUserCompany').textContent = user.company ? 'üè¢ ' + user.company : '';
            document.getElementById('detailUserPosition').textContent = user.position ? 'üë§ ' + user.position : '';
            document.getElementById('detailUserCredits').textContent = 'üíé ' + (user.credits || 0) + ' ÁßØÂàÜ';

            // ËøáÊª§ËØ•Áî®Êà∑ÁöÑ‰ºöËØù
            const userSessions = allSessions.filter(s => s.user_email === email);

            // Ê∏≤ÊüìËØ•Áî®Êà∑ÁöÑ‰ºöËØù
            const container = document.getElementById('userSessionsList');
            if (userSessions.length === 0) {
                container.innerHTML = '<p class="loading">ËØ•Áî®Êà∑ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</p>';
            } else {
                container.innerHTML = userSessions.map((s, idx) => `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user-info">
                                <span class="session-module">${s.module}</span>
                            </div>
                            <div>
                                <span class="session-time">${formatTime(s.updated_at)}</span>
                                <button class="btn-expand" onclick="toggleUserMessages(${idx})">
                                    ${(s.messages || []).length} Êù°Ê∂àÊÅØ ‚ñº
                                </button>
                            </div>
                        </div>
                        <div class="messages-list hidden" id="user-messages-${idx}">
                            ${(s.messages || []).map(m => `
                                <div class="msg-item msg-${m.role}">
                                    <div class="msg-role">${m.role === 'user' ? 'Áî®Êà∑' : 'AI'}</div>
                                    <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // ÊòæÁ§∫ËØ¶ÊÉÖÈù¢ÊùøÔºåÈöêËóèÊâÄÊúâÂàóË°®
            document.getElementById('userDetailPanel').style.display = 'block';
            document.getElementById('usersList').style.display = 'none';
            document.getElementById('sessionsList').style.display = 'none';
        }

        // ‰ªéËÅäÂ§©ËÆ∞ÂΩïÂàóË°®ÁÇπÂáªÁî®Êà∑ÈÇÆÁÆ±Êü•ÁúãËØ¶ÊÉÖ
        function showUserDetailFromSession(email) {
            if (!email) return;

            // ÊòæÁ§∫Áî®Êà∑ËØ¶ÊÉÖ
            showUserDetail(email);

            // ËÆ∞ÂΩïÊù•Ê∫êÊ†áÁ≠æÔºåÁî®‰∫éËøîÂõûÊó∂ÊÅ¢Â§ç
            sessionStorage.setItem('userDetailSource', 'sessions');
        }

        function hideUserDetail() {
            currentUserEmail = null;
            const source = sessionStorage.getItem('userDetailSource');

            // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
            document.getElementById('userDetailPanel').style.display = 'none';

            // Ê†πÊçÆÊù•Ê∫êÊòæÁ§∫Áõ∏Â∫îÁöÑÂàóË°®
            if (source === 'sessions') {
                // Â¶ÇÊûúÊòØ‰ªéËÅäÂ§©ËÆ∞ÂΩïtabÊù•ÁöÑÔºå‰øùÊåÅÂú®ËÅäÂ§©ËÆ∞ÂΩïtab
                document.getElementById('sessionsList').style.display = 'block';
                document.getElementById('usersList').style.display = 'none';
            } else {
                // Âê¶ÂàôÊòæÁ§∫Áî®Êà∑ÂàóË°®
                document.getElementById('usersList').style.display = 'block';
                document.getElementById('sessionsList').style.display = 'none';
            }

            // Ê∏ÖÈô§Êù•Ê∫êËÆ∞ÂΩï
            sessionStorage.removeItem('userDetailSource');
        }

        function toggleUserMessages(idx) {
            const el = document.getElementById('user-messages-' + idx);
            el.classList.toggle('hidden');
        }

        // ÁîüÊàêÁî®Êà∑ÁîªÂÉè
        async function generateUserProfile() {
            if (!currentUserEmail) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Áî®Êà∑');
                return;
            }

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂíåÂä†ËΩΩÁä∂ÊÄÅ
            const modal = document.getElementById('userProfileModal');
            const content = document.getElementById('userProfileContent');
            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®ÂàÜÊûêÁî®Êà∑ËÅäÂ§©ËÆ∞ÂΩïÔºåËØ∑Á®çÂÄô...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/admin/user-profile-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUserEmail
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayUserProfile(data.profile);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--text-secondary); font-size: 16px;">
                                ‚ùå ${data.error || 'ÁîüÊàêÁî®Êà∑ÁîªÂÉèÂ§±Ë¥•'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ÁîüÊàêÁî®Êà∑ÁîªÂÉèÂ§±Ë¥•:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary); font-size: 16px;">
                            ‚ùå ÁΩëÁªúÈîôËØØÊàñÊúçÂä°Âô®ÂºÇÂ∏∏
                        </p>
                    </div>
                `;
            }
        }

        // ÊòæÁ§∫Áî®Êà∑ÁîªÂÉè
        function displayUserProfile(profile) {
            const content = document.getElementById('userProfileContent');

            content.innerHTML = `
                <div class="profile-section">
                    <h3>üìä Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="profile-content">
                        <p><strong>Áî®Êà∑ÈÇÆÁÆ±Ôºö</strong>${escapeHtml(profile.email || '')}</p>
                        <p><strong>ÂØπËØùÊ¨°Êï∞Ôºö</strong><span class="profile-stat">${profile.session_count || 0} Ê¨°</span></p>
                        <p><strong>Ê∂àÊÅØÊÄªÊï∞Ôºö</strong><span class="profile-stat">${profile.message_count || 0} Êù°</span></p>
                        <p><strong>ÂàÜÊûêÊó∂Èó¥Ôºö</strong>${new Date(profile.analyzed_at).toLocaleString('zh-CN')}</p>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>üéØ Áî®Êà∑ÁîªÂÉèÊÄªÁªì</h3>
                    <div class="profile-content">
                        ${formatProfileText(profile.summary || 'ÊöÇÊó†ÊÄªÁªì')}
                    </div>
                </div>

                ${profile.topics && profile.topics.length > 0 ? `
                <div class="profile-section">
                    <h3>üí° ‰∏ªË¶ÅÂÖ≥Ê≥®ËØùÈ¢ò</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.topics.map(topic => `<li>${escapeHtml(topic)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${profile.patterns && profile.patterns.length > 0 ? `
                <div class="profile-section">
                    <h3>üìà ‰ΩøÁî®Ê®°Âºè</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.patterns.map(pattern => `<li>${escapeHtml(pattern)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${profile.recommendations && profile.recommendations.length > 0 ? `
                <div class="profile-section">
                    <h3>üíé Âª∫ËÆÆ‰∏éÊ¥ûÂØü</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Ê†ºÂºèÂåñÊñáÊú¨ÔºàÊîØÊåÅÊç¢Ë°åÔºâ
        function formatProfileText(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // ÈöêËóèÁî®Êà∑ÁîªÂÉèÊ®°ÊÄÅÊ°Ü
        function hideUserProfileModal() {
            document.getElementById('userProfileModal').style.display = 'none';
        }

        // ÂØºÂá∫Âçï‰∏™Áî®Êà∑ÁöÑÊâÄÊúâÂØπËØù
        function exportUserSessions() {
            if (!currentUserEmail) return;

            const user = allUsers.find(u => u.email === currentUserEmail) || {};
            const userSessions = allSessions.filter(s => s.user_email === currentUserEmail);

            const exportData = {
                user: {
                    email: currentUserEmail,
                    company: user.company || '',
                    position: user.position || '',
                    credits: user.credits || 0,
                    created_at: user.created_at
                },
                sessions: userSessions.map(s => ({
                    session_id: s.session_id || s.id,
                    module: s.module,
                    created_at: s.created_at,
                    messages: s.messages
                })),
                exported_at: new Date().toISOString()
            };

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `user_${currentUserEmail.split('@')[0]}_${timestamp}.json`;

            downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
        }

        // Â≠òÂÇ®ËøáÊª§ÂêéÁöÑ‰ºöËØùÔºàÁî®‰∫éÊêúÁ¥¢ÂíåÂØºÂá∫Ôºâ
        let filteredSessions = [];
        let currentSearchKeyword = '';

        // ÊêúÁ¥¢Â§ÑÁêÜÂáΩÊï∞
        function handleSessionSearch() {
            const input = document.getElementById('sessionSearchInput');
            const keyword = input.value.trim().toLowerCase();
            currentSearchKeyword = keyword;

            // ÊòæÁ§∫/ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
            document.getElementById('searchClearBtn').style.display = keyword ? 'flex' : 'none';

            // ËøáÊª§‰ºöËØù
            if (!keyword) {
                filteredSessions = [...allSessions];
            } else {
                filteredSessions = allSessions.filter(s => {
                    // ÊêúÁ¥¢Áî®Êà∑ÈÇÆÁÆ±
                    if ((s.user_email || '').toLowerCase().includes(keyword)) return true;
                    // ÊêúÁ¥¢ÂÖ¨Âè∏ÂêçÁß∞
                    if ((s.user_company || '').toLowerCase().includes(keyword)) return true;
                    // ÊêúÁ¥¢ËÅå‰Ωç
                    if ((s.user_position || '').toLowerCase().includes(keyword)) return true;
                    // ÊêúÁ¥¢Ê®°ÂùóÂêçÁß∞
                    if ((s.module || '').toLowerCase().includes(keyword)) return true;
                    // ÊêúÁ¥¢Ê∂àÊÅØÂÜÖÂÆπ
                    const messages = s.messages || [];
                    for (const m of messages) {
                        if ((m.content || '').toLowerCase().includes(keyword)) return true;
                    }
                    return false;
                });
            }

            // Êõ¥Êñ∞ÊêúÁ¥¢ÁªìÊûúËÆ°Êï∞
            updateSearchResultCount();
            // ÈáçÊñ∞Ê∏≤Êüì
            renderSessions();
        }

        // Êõ¥Êñ∞ÊêúÁ¥¢ÁªìÊûúËÆ°Êï∞
        function updateSearchResultCount() {
            const countEl = document.getElementById('searchResultCount');
            if (!currentSearchKeyword) {
                countEl.textContent = '';
                countEl.classList.remove('has-results');
            } else {
                countEl.textContent = `ÊâæÂà∞ ${filteredSessions.length} Êù°ËÆ∞ÂΩï`;
                countEl.classList.toggle('has-results', filteredSessions.length > 0);
            }
        }

        // Ê∏ÖÈô§ÊêúÁ¥¢
        function clearSearch() {
            document.getElementById('sessionSearchInput').value = '';
            currentSearchKeyword = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            filteredSessions = [...allSessions];
            updateSearchResultCount();
            renderSessions();
        }

        // Ê∏≤Êüì‰ºöËØùÂàóË°®
        function renderSessions() {
            const container = document.getElementById('sessionsList');

            // Â¶ÇÊûúËøòÊ≤°ÊúâÂàùÂßãÂåñ filteredSessionsÔºå‰ΩøÁî® allSessions
            if (filteredSessions.length === 0 && allSessions.length > 0 && !currentSearchKeyword) {
                filteredSessions = [...allSessions];
            }

            const sessionsToRender = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToRender.length === 0) {
                container.innerHTML = currentSearchKeyword
                    ? '<p class="loading">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÅäÂ§©ËÆ∞ÂΩï</p>'
                    : '<p class="loading">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p>';
                return;
            }

            container.innerHTML = sessionsToRender.map((s, idx) => `
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-user-info">
                            <span class="session-user clickable-user" onclick="showUserDetailFromSession('${s.user_email || ''}')" title="ÁÇπÂáªÊü•ÁúãËØ•Áî®Êà∑ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï">${s.user_email || 'Êú™Áü•Áî®Êà∑'}</span>
                            ${s.user_company ? `<span class="session-company">üè¢ ${s.user_company}</span>` : ''}
                            ${s.user_position ? `<span class="session-position">üë§ ${s.user_position}</span>` : ''}
                            <span class="session-module">${s.module}</span>
                        </div>
                        <div>
                            <span class="session-time">${formatTime(s.updated_at)}</span>
                            <button class="btn-expand" onclick="toggleMessages(${idx})">
                                ${(s.messages || []).length} Êù°Ê∂àÊÅØ ‚ñº
                            </button>
                        </div>
                    </div>
                    <div class="messages-list hidden" id="messages-${idx}">
                        ${(s.messages || []).map(m => `
                            <div class="msg-item msg-${m.role}">
                                <div class="msg-role">${m.role === 'user' ? 'Áî®Êà∑' : 'AI'}</div>
                                <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Â±ïÂºÄ/Êî∂Ëµ∑Ê∂àÊÅØ
        function toggleMessages(idx) {
            const el = document.getElementById('messages-' + idx);
            el.classList.toggle('hidden');
        }

        // ÂàáÊç¢Ê†áÁ≠æ
        function switchTab(tab) {
            // Êõ¥Êñ∞‰æßËæπÊ†èÂØºËà™È´ò‰∫Æ
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => item.classList.remove('active'));
            const targetItem = document.querySelector(`.sidebar-nav .nav-item[data-tab="${tab}"]`);
            if (targetItem) targetItem.classList.add('active');

            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            const titles = {
                'users': { title: 'Áî®Êà∑ÂàóË°®', subtitle: 'ÁÆ°ÁêÜÊâÄÊúâÊ≥®ÂÜåÁî®Êà∑' },
                'sessions': { title: 'ËÅäÂ§©ËÆ∞ÂΩï', subtitle: 'Êü•ÁúãÊâÄÊúâÂØπËØùÂéÜÂè≤' },
                'prompts': { title: 'ÊèêÁ§∫ËØçÁÆ°ÁêÜ', subtitle: 'ÈÖçÁΩÆAIÊ®°ÂùóÊèêÁ§∫ËØç' },
                'redeem': { title: 'ÂÖëÊç¢Á†ÅÁÆ°ÁêÜ', subtitle: 'ÁîüÊàêÂíåÁÆ°ÁêÜÂÖëÊç¢Á†Å' },
                'admins': { title: 'ÁÆ°ÁêÜÂëòÁÆ°ÁêÜ', subtitle: 'Ê∑ªÂä†ÂíåÁÆ°ÁêÜÁÆ°ÁêÜÂëòË¥¶Âè∑' },
                'logs': { title: 'Êìç‰ΩúÊó•Âøó', subtitle: 'Êü•ÁúãÁ≥ªÁªüÊìç‰ΩúËÆ∞ÂΩï' }
            };
            if (titles[tab]) {
                document.getElementById('pageTitle').textContent = titles[tab].title;
                document.getElementById('pageSubtitle').textContent = titles[tab].subtitle;
            }

            // ÂàáÊç¢ÂÜÖÂÆπÈù¢Êùø
            document.getElementById('usersTab').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sessionsTab').classList.toggle('hidden', tab !== 'sessions');
            document.getElementById('promptsTab').classList.toggle('hidden', tab !== 'prompts');
            document.getElementById('redeemTab').classList.toggle('hidden', tab !== 'redeem');
            document.getElementById('adminsTab').classList.toggle('hidden', tab !== 'admins');
            document.getElementById('logsTab').classList.toggle('hidden', tab !== 'logs');
            document.getElementById('userDetailPanel').style.display = 'none';

            // ÊòæÁ§∫/ÈöêËóèÂØºÂá∫ÊåâÈíÆ
            document.getElementById('exportBar').style.display = tab === 'sessions' ? 'flex' : 'none';

            // ÊòæÁ§∫/ÈöêËóèÁªüËÆ°Âç°Áâá
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.style.display = (tab === 'users' || tab === 'sessions') ? 'grid' : 'none';
            }

            // ÂàáÊç¢Âà∞ÊèêÁ§∫ËØçÁÆ°ÁêÜÊó∂Âä†ËΩΩÊ®°Âùó
            if (tab === 'prompts') {
                loadModules();
            }
            // ÂàáÊç¢Âà∞ÂÖëÊç¢Á†ÅÁÆ°ÁêÜÊó∂Âä†ËΩΩÂÖëÊç¢Á†ÅÂàóË°®
            if (tab === 'redeem') {
                loadRedeemCodes();
            }
            // ÂàáÊç¢Âà∞Êó•ÂøóÊ†áÁ≠æÊó∂Âä†ËΩΩÊó•Âøó
            if (tab === 'logs') {
                loadAdminLogs('all');
            }
            // ÂàáÊç¢Âà∞ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÊó∂Âä†ËΩΩÁÆ°ÁêÜÂëòÂàóË°®
            if (tab === 'admins') {
                loadAdminUsers();
            }
        }

        // ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩïÔºàÂåÖÂê´ÂÆåÊï¥Áî®Êà∑‰ø°ÊÅØÔºâ
        function exportChat(type, format) {
            // ‰ΩøÁî®ÊêúÁ¥¢ÁªìÊûúÊàñÂÖ®ÈÉ®Êï∞ÊçÆ
            const sessionsToExport = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToExport.length === 0) {
                alert(currentSearchKeyword ? 'ÊêúÁ¥¢ÁªìÊûú‰∏∫Á©∫ÔºåÊó†Êï∞ÊçÆÂèØÂØºÂá∫' : 'ÊöÇÊó†Êï∞ÊçÆÂèØÂØºÂá∫');
                return;
            }

            // ÊûÑÂª∫Áî®Êà∑‰ø°ÊÅØÊò†Â∞Ñ
            const userMap = {};
            allUsers.forEach(u => {
                userMap[u.email] = u;
            });

            let exportData;
            const timestamp = new Date().toISOString().slice(0, 10);
            // Êñá‰ª∂ÂêçÊ∑ªÂä†ÊêúÁ¥¢Ê†áËØÜ
            const searchSuffix = currentSearchKeyword ? `_search_${currentSearchKeyword.substring(0, 20)}` : '';

            if (type === 'user') {
                // Âè™ÂØºÂá∫Áî®Êà∑ËæìÂÖ•
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || 'Êú™Áü•',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        user_messages: (s.messages || []).filter(m => m.role === 'user').map(m => m.content)
                    };
                });
            } else {
                // ÂØºÂá∫ÂÖ®ÈÉ®ÂØπËØù
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || 'Êú™Áü•',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        messages: s.messages
                    };
                });
            }

            if (format === 'json') {
                downloadFile(
                    JSON.stringify(exportData, null, 2),
                    `chat_${type}${searchSuffix}_${timestamp}.json`,
                    'application/json'
                );
            } else {
                // CSV Ê†ºÂºè
                const csvContent = convertToCSV(exportData, type);
                downloadFile(csvContent, `chat_${type}${searchSuffix}_${timestamp}.csv`, 'text/csv');
            }
        }

        // ËΩ¨Êç¢‰∏∫ CSV
        function convertToCSV(data, type) {
            let rows = [];

            if (type === 'user') {
                rows.push(['‰ºöËØùID', 'Áî®Êà∑ÈÇÆÁÆ±', 'ÂÖ¨Âè∏ÂêçÁß∞', 'ËÅå‰Ωç', 'Ê®°Âùó', 'Êó∂Èó¥', 'Áî®Êà∑ËæìÂÖ•']);
                data.forEach(s => {
                    (s.user_messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            } else {
                rows.push(['‰ºöËØùID', 'Áî®Êà∑ÈÇÆÁÆ±', 'ÂÖ¨Âè∏ÂêçÁß∞', 'ËÅå‰Ωç', 'Ê®°Âùó', 'Êó∂Èó¥', 'ËßíËâ≤', 'ÂÜÖÂÆπ']);
                data.forEach(s => {
                    (s.messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.role === 'user' ? 'Áî®Êà∑' : 'AI',
                            msg.content.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            }

            return rows.map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
        }

        // ‰∏ãËΩΩÊñá‰ª∂
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(str) {
            if (!str) return '-';
            const d = new Date(str);
            return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        // HTML ËΩ¨‰πâ
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ========================================
        // ÊèêÁ§∫ËØçÁÆ°ÁêÜÂäüËÉΩ
        // ========================================

        let allModules = [];
        let currentModuleId = null;

        // Âä†ËΩΩÊ®°ÂùóÂàóË°®
        async function loadModules() {
            try {
                const res = await fetch('/api/admin/modules');
                const data = await res.json();

                if (data.success) {
                    allModules = data.modules || [];
                    renderModuleList();
                }
            } catch (e) {
                console.error('Âä†ËΩΩÊ®°ÂùóÂ§±Ë¥•', e);
            }
        }

        // Ê∏≤ÊüìÊ®°ÂùóÂàóË°®
        function renderModuleList() {
            const container = document.getElementById('moduleListItems');

            if (allModules.length === 0) {
                container.innerHTML = '<p class="loading">ÊöÇÊó†Ê®°Âùó</p>';
                return;
            }

            container.innerHTML = allModules.map(m => `
                <div class="module-item ${currentModuleId === m.id ? 'active' : ''}"
                     onclick="selectModule('${m.id}')">
                    <div class="module-icon" style="background: ${m.color}20; color: ${m.color};">
                        ${m.icon || 'üìã'}
                    </div>
                    <div class="module-item-info">
                        <div class="module-item-name">${m.name}</div>
                        <div class="module-item-desc">${m.description || ''}</div>
                    </div>
                    <button class="btn-delete-module" onclick="event.stopPropagation(); deleteModule('${m.id}', '${m.name}')" title="Âà†Èô§Ê®°Âùó">√ó</button>
                </div>
            `).join('');
        }

        // Âà†Èô§Ê®°Âùó
        async function deleteModule(moduleId, moduleName) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âùó„Äå${moduleName}„ÄçÂêóÔºü\n\nÂà†Èô§ÂêéÈ¶ñÈ°µÂ∞Ü‰∏çÂÜçÊòæÁ§∫ËØ•Ê®°Âùó„ÄÇ`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/modules/${moduleId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    alert('Ê®°ÂùóÂ∑≤Âà†Èô§');
                    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°ÂùóÔºåÊ∏ÖÈô§ÈÄâÊã©
                    if (currentModuleId === moduleId) {
                        currentModuleId = null;
                        document.getElementById('promptEditor').style.display = 'none';
                        document.getElementById('promptPlaceholder').style.display = 'block';
                    }
                    // ÈáçÊñ∞Âä†ËΩΩÊ®°ÂùóÂàóË°®
                    await loadModules();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + data.message);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        // ÈÄâÊã©Ê®°Âùó
        async function selectModule(moduleId) {
            currentModuleId = moduleId;
            const module = allModules.find(m => m.id === moduleId);

            if (!module) return;

            // Êõ¥Êñ∞UI
            document.getElementById('promptEditor').style.display = 'block';
            document.getElementById('promptPlaceholder').style.display = 'none';
            document.getElementById('currentModuleIcon').textContent = module.icon || 'üìã';
            document.getElementById('currentModuleName').value = module.name;
            document.getElementById('promptSaveStatus').textContent = '';

            // Êõ¥Êñ∞Ê®°ÂùóÂàóË°®È´ò‰∫Æ
            renderModuleList();

            // Âä†ËΩΩÊèêÁ§∫ËØç
            await loadPrompt(moduleId);

            // Âä†ËΩΩÁü•ËØÜÂ∫ì
            await loadKnowledge(moduleId);
        }

        // Âä†ËΩΩÊèêÁ§∫ËØç
        async function loadPrompt(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/prompt`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('promptTextarea').value = data.prompt || '';
                }
            } catch (e) {
                console.error('Âä†ËΩΩÊèêÁ§∫ËØçÂ§±Ë¥•', e);
            }
        }

        // ‰øùÂ≠òÊèêÁ§∫ËØç
        async function savePrompt() {
            if (!currentModuleId) return;

            const prompt = document.getElementById('promptTextarea').value;
            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = '‰øùÂ≠ò‰∏≠...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '‚úì ‰øùÂ≠òÊàêÂäü';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = '‚úó ‰øùÂ≠òÂ§±Ë¥•: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '‚úó ÁΩëÁªúÈîôËØØ';
                statusEl.style.color = '#ef4444';
            }
        }

        // ‰øùÂ≠òÊ®°ÂùóÂêçÁß∞
        async function saveModuleName() {
            if (!currentModuleId) return;

            const nameInput = document.getElementById('currentModuleName');
            const newName = nameInput.value.trim();
            const statusEl = document.getElementById('promptSaveStatus');

            if (!newName) {
                // Â¶ÇÊûúÂêçÁß∞‰∏∫Á©∫ÔºåÊÅ¢Â§çÂéüÂêçÁß∞
                const module = allModules.find(m => m.id === currentModuleId);
                if (module) {
                    nameInput.value = module.name;
                }
                return;
            }

            // Ê£ÄÊü•ÂêçÁß∞ÊòØÂê¶ÊîπÂèò
            const module = allModules.find(m => m.id === currentModuleId);
            if (module && module.name === newName) {
                return; // ÂêçÁß∞Êú™ÂèòÔºå‰∏çÈúÄË¶Å‰øùÂ≠ò
            }

            try {
                statusEl.textContent = '‰øùÂ≠òÊ®°ÂùóÂêçÁß∞...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '‚úì Ê®°ÂùóÂêçÁß∞Â∑≤‰øùÂ≠ò';
                    statusEl.style.color = '#10b981';
                    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆÂπ∂ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                    if (module) {
                        module.name = newName;
                    }
                    renderModuleList();
                } else {
                    statusEl.textContent = '‚úó ‰øùÂ≠òÂ§±Ë¥•: ' + data.message;
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '‚úó ÁΩëÁªúÈîôËØØ';
                statusEl.style.color = '#ef4444';
            }
        }

        // ÂàáÊç¢ÊèêÁ§∫ËØç/Áü•ËØÜÂ∫ìÊ†áÁ≠æ
        function switchPromptTab(tab) {
            document.querySelectorAll('.prompt-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('promptContent').style.display = tab === 'prompt' ? 'block' : 'none';
            document.getElementById('knowledgeContent').style.display = tab === 'knowledge' ? 'block' : 'none';
        }

        // Âä†ËΩΩÁü•ËØÜÂ∫ìÊñá‰ª∂
        async function loadKnowledge(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/knowledge`);
                const data = await res.json();

                const container = document.getElementById('knowledgeList');

                if (data.success && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = getFileIcon(f.file_type);
                        return `
                            <div class="knowledge-item">
                                <div class="knowledge-item-info">
                                    <span class="knowledge-icon">${icon}</span>
                                    <div>
                                        <div class="knowledge-name">${f.filename}</div>
                                        <div class="knowledge-meta">${formatTime(f.created_at)}</div>
                                    </div>
                                </div>
                                <button class="btn-delete-knowledge" onclick="deleteKnowledge('${f.id}')">Âà†Èô§</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="loading">ÊöÇÊó†Áü•ËØÜÂ∫ìÊñá‰ª∂</p>';
                }
            } catch (e) {
                console.error('Âä†ËΩΩÁü•ËØÜÂ∫ìÂ§±Ë¥•', e);
            }
        }

        // Ëé∑ÂèñÊñá‰ª∂ÂõæÊ†á
        function getFileIcon(type) {
            const icons = {
                'txt': 'üìÑ',
                'md': 'üìù',
                'pdf': 'üìï',
                'docx': 'üìò'
            };
            return icons[type] || 'üìÑ';
        }

        // ‰∏ä‰º†Áü•ËØÜÂ∫ìÊñá‰ª∂
        async function uploadKnowledge() {
            if (!currentModuleId) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ê®°Âùó');
                return;
            }

            const input = document.getElementById('knowledgeUpload');
            const file = input.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/admin/modules/${currentModuleId}/knowledge`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert('‰∏ä‰º†ÊàêÂäü');
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('‰∏ä‰º†Â§±Ë¥•: ' + data.message);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }

            // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
            input.value = '';
        }

        // Âà†Èô§Áü•ËØÜÂ∫ìÊñá‰ª∂
        async function deleteKnowledge(fileId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü')) return;

            try {
                const res = await fetch(`/api/admin/knowledge/${fileId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + data.message);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        // ÊòæÁ§∫Êñ∞Â¢ûÊ®°ÂùóÂºπÁ™ó
        function showAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'flex';
        }

        // ÈöêËóèÊñ∞Â¢ûÊ®°ÂùóÂºπÁ™ó
        function hideAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('newModuleId').value = '';
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleDesc').value = '';
            document.getElementById('newModuleSubtitle').value = '';
            document.getElementById('newModuleIcon').value = 'üìä';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
        }

        // ÈÄâÊã© Emoji
        function selectEmoji(emoji) {
            document.getElementById('newModuleIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === emoji);
            });
        }

        // ÂàõÂª∫Êñ∞Ê®°Âùó
        async function createModule() {
            const id = document.getElementById('newModuleId').value.trim();
            const name = document.getElementById('newModuleName').value.trim();
            const description = document.getElementById('newModuleDesc').value.trim();
            const subtitle = document.getElementById('newModuleSubtitle').value.trim();
            const icon = document.getElementById('newModuleIcon').value;
            const color = document.getElementById('newModuleColor').value;

            if (!id || !name) {
                alert('ËØ∑Â°´ÂÜôÊ®°ÂùóIDÂíåÂêçÁß∞');
                return;
            }

            // È™åËØÅ ID Ê†ºÂºèÔºàÂè™ÂÖÅËÆ∏Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ
            if (!/^[a-z][a-z0-9_]*$/.test(id)) {
                alert('Ê®°ÂùóIDÂè™ËÉΩÂåÖÂê´Â∞èÂÜôÂ≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫øÔºå‰∏î‰ª•Â≠óÊØçÂºÄÂ§¥');
                return;
            }

            try {
                const res = await fetch('/api/admin/modules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        name,
                        description,
                        subtitle,
                        icon,
                        color,
                        prompt: `## ${name}Ê®°Âùó\n\nËØ∑Âú®Ê≠§ËæìÂÖ•ËØ•Ê®°ÂùóÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç...`
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Ê®°ÂùóÂàõÂª∫ÊàêÂäüÔºÅ');
                    hideAddModuleModal();
                    await loadModules();
                    // Ëá™Âä®ÈÄâ‰∏≠Êñ∞Ê®°Âùó
                    selectModule(id);
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•: ' + data.message);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        // ========================================
        // ÂÖëÊç¢Á†ÅÁÆ°ÁêÜÂäüËÉΩ
        // ========================================

        let allRedeemCodes = [];

        async function loadRedeemCodes() {
            try {
                const res = await fetch('/api/admin/redeem/codes');
                const data = await res.json();
                if (data.success) {
                    allRedeemCodes = data.codes;
                    renderRedeemCodes();
                }
            } catch (e) {
                console.error('Âä†ËΩΩÂÖëÊç¢Á†ÅÂ§±Ë¥•:', e);
            }
        }

        function renderRedeemCodes() {
            const container = document.getElementById('redeemCodesList');
            if (allRedeemCodes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">ÊöÇÊó†ÂÖëÊç¢Á†Å</p>';
                return;
            }

            container.innerHTML = allRedeemCodes.map(code => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value">${code.code}</div>
                        <div class="redeem-code-meta">
                            ÁõÆÊ†á: ${code.target_name} |
                            ${code.cat_coins ? code.cat_coins + 'Áå´Â∏Å ‚Üí ' : ''}${code.credits} ÁßØÂàÜ |
                            ÂàõÂª∫: ${code.created_by} | ${formatTime(code.created_at)}
                            ${code.note ? ' | ' + code.note : ''}
                        </div>
                    </div>
                    <span class="redeem-code-status ${code.is_used ? 'status-used' : 'status-unused'}">
                        ${code.is_used ? 'Â∑≤‰ΩøÁî®' : 'Êú™‰ΩøÁî®'}
                    </span>
                    <button class="btn-delete-code" onclick="deleteRedeemCode('${code.id}')" ${code.is_used ? 'disabled' : ''}>
                        Âà†Èô§
                    </button>
                </div>
            `).join('');
        }

        // ËÆ°ÁÆóÁå´Â∏ÅÂÖëÊç¢ÁßØÂàÜ
        function calculateCreditsFromCatCoins(catCoins) {
            if (catCoins <= 0) return 0;
            // ÊØè‰∏™Áå´Â∏Å = 20ÁßØÂàÜ
            return catCoins * 20;
        }

        // Êõ¥Êñ∞ÂÖëÊç¢È¢ÑËßà
        function updateRedeemPreview() {
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const preview = document.getElementById('redeemPreview');
            if (catCoins > 0) {
                const credits = calculateCreditsFromCatCoins(catCoins);
                preview.innerHTML = `<strong>${catCoins} ‰∏™Áå´Â∏Å = ${credits} ÁßØÂàÜ</strong>ÔºàÁ∫¶ ${Math.floor(credits / 2)} Ê¨°ÂõûÁ≠îÊú∫‰ºöÔºâ`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // ÂàáÊç¢Áî®Êà∑Á±ªÂûã
        function toggleRedeemType() {
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const businessSchoolInfo = document.getElementById('businessSchoolInfo');
            const catCoinsInputGroup = document.getElementById('catCoinsInputGroup');
            const typeBusinessSchoolLabel = document.getElementById('typeBusinessSchoolLabel');
            const typeCatCoinsLabel = document.getElementById('typeCatCoinsLabel');

            if (userType === 'business_school') {
                businessSchoolInfo.style.display = 'block';
                catCoinsInputGroup.style.display = 'none';
                typeBusinessSchoolLabel.style.borderColor = '#444746';
                typeCatCoinsLabel.style.borderColor = 'transparent';
            } else {
                businessSchoolInfo.style.display = 'none';
                catCoinsInputGroup.style.display = 'block';
                typeBusinessSchoolLabel.style.borderColor = 'transparent';
                typeCatCoinsLabel.style.borderColor = '#444746';
            }
        }

        async function createRedeemCode() {
            const targetName = document.getElementById('redeemTargetName').value.trim();
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const note = document.getElementById('redeemNote').value.trim();

            if (!targetName) {
                alert('ËØ∑ËæìÂÖ•ÁõÆÊ†áÁî®Êà∑ÂßìÂêç');
                return;
            }

            // Áå´Â∏ÅÂÖëÊç¢Ê®°ÂºèÈúÄË¶ÅËæìÂÖ•Áå´Â∏ÅÊï∞Èáè
            if (userType === 'cat_coins' && (!catCoins || catCoins <= 0)) {
                alert('ËØ∑ËæìÂÖ•Áå´Â∏ÅÊï∞Èáè');
                return;
            }

            try {
                const requestBody = {
                    target_name: targetName,
                    note,
                    user_type: userType
                };

                // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÁßØÂàÜ
                if (userType === 'business_school') {
                    requestBody.credits = 2000;  // ÂïÜÂ≠¶Èô¢Âõ∫ÂÆö2000ÁßØÂàÜ
                } else {
                    requestBody.cat_coins = catCoins;
                }

                const res = await fetch('/api/admin/redeem/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    // ÊòæÁ§∫ÁîüÊàêÁöÑÂÖëÊç¢Á†Å
                    document.getElementById('generatedCode').textContent = data.code.code;
                    const creditsInfo = userType === 'business_school'
                        ? 'ÂïÜÂ≠¶Èô¢Â≠¶Âëò ‚Üí 2000 ÁßØÂàÜ'
                        : `${catCoins} Áå´Â∏Å ‚Üí ${data.code.credits} ÁßØÂàÜ`;
                    document.getElementById('generatedCredits').textContent = creditsInfo;
                    document.getElementById('redeemResult').style.display = 'block';
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('redeemTargetName').value = '';
                    document.getElementById('redeemCatCoins').value = '';
                    document.getElementById('redeemNote').value = '';
                    document.getElementById('redeemPreview').style.display = 'none';
                    // Âà∑Êñ∞ÂàóË°®
                    loadRedeemCodes();
                } else {
                    alert('ÁîüÊàêÂ§±Ë¥•: ' + data.error);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        function copyRedeemCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('ÂÖëÊç¢Á†ÅÂ∑≤Â§çÂà∂: ' + code);
            });
        }

        // ÊâπÈáèÁîüÊàêÁöÑÂÖëÊç¢Á†ÅÂàóË°®ÔºàÁî®‰∫éÂ§çÂà∂Ôºâ
        let batchGeneratedCodes = [];

        async function batchCreateRedeemCodes() {
            const credits = parseInt(document.getElementById('batchCredits').value) || 0;
            const count = parseInt(document.getElementById('batchCount').value) || 0;
            const note = document.getElementById('batchNote').value.trim();

            if (credits <= 0) {
                alert('ËØ∑ËæìÂÖ•ÁßØÂàÜÊï∞Èáè');
                return;
            }

            if (count <= 0 || count > 100) {
                alert('ÁîüÊàêÊï∞ÈáèÂøÖÈ°ªÂú®1-100‰πãÈó¥');
                return;
            }

            try {
                const res = await fetch('/api/admin/redeem/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credits, count, note })
                });
                const data = await res.json();

                if (data.success) {
                    batchGeneratedCodes = data.codes.map(c => c.code);

                    // ÊòæÁ§∫ÁªìÊûú
                    document.getElementById('batchResultTitle').textContent =
                        `ÊàêÂäüÁîüÊàê ${data.codes.length} ‰∏™ÂÖëÊç¢Á†ÅÔºàÊØè‰∏™ ${credits} ÁßØÂàÜÔºâ`;

                    // ÊòæÁ§∫ÂÖëÊç¢Á†ÅÂàóË°®
                    const listHtml = data.codes.map(c =>
                        `<div style="font-family: monospace; padding: 4px 0; color: var(--accent-blue);">${c.code}</div>`
                    ).join('');
                    document.getElementById('batchCodesList').innerHTML = listHtml;

                    document.getElementById('batchResult').style.display = 'block';

                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('batchCredits').value = '';
                    document.getElementById('batchCount').value = '';
                    document.getElementById('batchNote').value = '';

                    // Âà∑Êñ∞ÂàóË°®
                    loadRedeemCodes();
                } else {
                    alert('ÁîüÊàêÂ§±Ë¥•: ' + data.error);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        function copyBatchCodes() {
            if (batchGeneratedCodes.length === 0) {
                alert('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÖëÊç¢Á†Å');
                return;
            }
            const codesText = batchGeneratedCodes.join('\n');
            navigator.clipboard.writeText(codesText).then(() => {
                alert(`Â∑≤Â§çÂà∂ ${batchGeneratedCodes.length} ‰∏™ÂÖëÊç¢Á†Å`);
            });
        }

        async function deleteRedeemCode(codeId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂÖëÊç¢Á†ÅÂêóÔºü')) return;

            try {
                const res = await fetch(`/api/admin/redeem/${codeId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadRedeemCodes();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + data.error);
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        // ========================================
        // ÁÆ°ÁêÜÂëòÊìç‰ΩúÊó•ÂøóÂäüËÉΩ
        // ========================================

        let currentLogType = 'all';

        async function loadAdminLogs(type = 'all') {
            currentLogType = type;
            const container = document.getElementById('adminLogsList');
            container.innerHTML = '<p class="loading">Âä†ËΩΩ‰∏≠...</p>';

            try {
                const res = await fetch(`/api/admin/logs?type=${type}`);
                const data = await res.json();

                if (data.success) {
                    renderAdminLogs(data.logs || []);
                } else {
                    container.innerHTML = '<p class="loading">Âä†ËΩΩÂ§±Ë¥•</p>';
                }
            } catch (e) {
                console.error('Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•:', e);
                container.innerHTML = '<p class="loading">Âä†ËΩΩÂ§±Ë¥•</p>';
            }
        }

        function renderAdminLogs(logs) {
            const container = document.getElementById('adminLogsList');

            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">ÊöÇÊó†Êìç‰ΩúÊó•Âøó</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                // Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãËÆæÁΩÆÂõæÊ†á
                const icons = {
                    'PROMPT_CREATE': 'üìù',
                    'PROMPT_UPDATE': '‚úèÔ∏è',
                    'PROMPT_DELETE': 'üóëÔ∏è',
                    'MODULE_CREATE': '‚ûï',
                    'MODULE_DELETE': '‚ùå',
                    'REDEEM_CREATE': 'üé´',
                    'REDEEM_USED': '‚úÖ',
                    'CREDITS_ADD': 'üí∞'
                };
                const icon = icons[log.action_type] || 'üìã';

                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <div class="log-item-action">
                                ${icon} ${log.action_name || log.action_type}
                                <span class="log-item-target">‚Üí ${log.target || ''}</span>
                            </div>
                            <div class="log-item-details">${log.details || ''}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <span class="log-item-admin">${log.admin_name}</span>
                            <span class="log-item-time">${formatTime(log.created_at)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLogs(type) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Âä†ËΩΩÂØπÂ∫îÁ±ªÂûãÁöÑÊó•Âøó
            loadAdminLogs(type);
        }

        // ========================================
        // ÁÆ°ÁêÜÂëòÁî®Êà∑ÁÆ°ÁêÜÂäüËÉΩ
        // ========================================

        let allAdminUsers = [];

        async function loadAdminUsers() {
            const container = document.getElementById('adminsList');
            container.innerHTML = '<p class="loading">Âä†ËΩΩ‰∏≠...</p>';

            try {
                const res = await fetch('/api/admin/admins');
                const data = await res.json();

                if (data.success) {
                    allAdminUsers = data.admins || [];
                    renderAdminUsers();
                } else {
                    container.innerHTML = '<p class="loading">Âä†ËΩΩÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ') + '</p>';
                }
            } catch (e) {
                console.error('Âä†ËΩΩÁÆ°ÁêÜÂëòÂàóË°®Â§±Ë¥•:', e);
                container.innerHTML = '<p class="loading">Âä†ËΩΩÂ§±Ë¥•</p>';
            }
        }

        function renderAdminUsers() {
            const container = document.getElementById('adminsList');

            if (allAdminUsers.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">ÊöÇÊó†ÊôÆÈÄöÁÆ°ÁêÜÂëò</p>';
                return;
            }

            container.innerHTML = allAdminUsers.map(admin => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value" style="letter-spacing: 0;">${admin.username}</div>
                        <div class="redeem-code-meta">
                            ÂàõÂª∫ËÄÖ: ${admin.created_by || '-'} |
                            ÂàõÂª∫Êó∂Èó¥: ${formatTime(admin.created_at)}
                            ${admin.note ? ' | ' + admin.note : ''}
                        </div>
                    </div>
                    <button class="btn-delete-code" style="background: rgba(168, 199, 250, 0.2); color: #A8C7FA;" onclick="resetAdminPassword('${admin.id}', '${admin.username}')">
                        ÈáçÁΩÆÂØÜÁ†Å
                    </button>
                    <button class="btn-delete-code" onclick="deleteAdmin('${admin.id}', '${admin.username}')">
                        Âà†Èô§
                    </button>
                </div>
            `).join('');
        }

        async function createAdmin() {
            const username = document.getElementById('newAdminUsername').value.trim();
            const note = document.getElementById('newAdminNote').value.trim();

            if (!username) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                return;
            }

            try {
                const res = await fetch('/api/admin/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, note })
                });
                const data = await res.json();

                if (data.success) {
                    // ÊòæÁ§∫ÂàõÂª∫ÁªìÊûú
                    document.getElementById('createdAdminName').textContent = username;
                    document.getElementById('adminResult').style.display = 'block';
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminNote').value = '';
                    // Âà∑Êñ∞ÂàóË°®
                    loadAdminUsers();
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        async function deleteAdmin(adminId, username) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÁÆ°ÁêÜÂëò„Äå${username}„ÄçÂêóÔºü`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    alert('Â∑≤Âà†Èô§');
                    loadAdminUsers();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }

        async function resetAdminPassword(adminId, username) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÈáçÁΩÆ„Äå${username}„ÄçÁöÑÂØÜÁ†Å‰∏∫„Äåmaoke2024„ÄçÂêóÔºü`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}/reset-password`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    alert(data.message || 'ÂØÜÁ†ÅÂ∑≤ÈáçÁΩÆ‰∏∫ÔºöÁå´Áßë');
                } else {
                    alert('ÈáçÁΩÆÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                alert('ÁΩëÁªúÈîôËØØ');
            }
        }
    </script>
</body>

</html>