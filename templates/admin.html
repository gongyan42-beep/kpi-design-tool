<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 电商管理设计工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-blue: #6366f1;
            --accent-purple: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* 背景装饰 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% -20%, rgba(99, 102, 241, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(139, 92, 246, 0.1), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ========== 侧边栏 ========== */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.95) 0%, rgba(10, 10, 15, 0.98) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            color: var(--text-primary);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .nav-item.active .nav-icon {
            color: var(--accent-blue);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border-color);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn-logout-small {
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout-small:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ========== 主内容区 ========== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            padding: 24px 32px;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .page-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========== 统计卡片 ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.users { background: rgba(99, 102, 241, 0.15); }
        .stat-icon.sessions { background: rgba(34, 211, 238, 0.15); }
        .stat-icon.messages { background: rgba(16, 185, 129, 0.15); }

        .stat-number {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ========== 内容面板 ========== */
        .content-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-body {
            padding: 24px;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* 登录框 - 现代玻璃风格 */
        .login-box {
            max-width: 420px;
            margin: 100px auto;
            background: var(--bg-card);
            padding: 48px 40px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 10;
        }

        /* 已移除登录框顶部装饰条 */

        .login-box h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text-primary);
        }

        .login-box .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .login-box input::placeholder {
            color: var(--text-muted);
        }

        .login-box button {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .error-msg {
            color: var(--accent-red);
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }

        /* 管理面板 - 默认隐藏，登录后显示 */
        #adminPanel {
            display: none;
        }

        .admin-header {
            display: none;
        }

        /* 隐藏旧的tabs和stats */
        .tabs {
            display: none !important;
        }

        .stats {
            display: none !important;
        }

        /* 用户卡片 - 现代风格 */
        .user-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
            transform: translateX(4px);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .user-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .tag-phone {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .tag-company {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
        }

        .tag-position {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
        }

        .tag-credits {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        .tag-credits-low {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        .tag-sessions {
            background: rgba(161, 161, 170, 0.1);
            border-color: rgba(161, 161, 170, 0.3);
            color: var(--text-secondary);
        }

        /* 行业标签样式 */
        .tag-industry {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: var(--accent-purple);
        }
        .tag-industry-tech { background: rgba(34, 211, 238, 0.1); border-color: rgba(34, 211, 238, 0.3); color: var(--accent-cyan); }
        .tag-industry-manufacture { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: var(--accent-amber); }
        .tag-industry-retail { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--accent-green); }
        .tag-industry-education { background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); color: var(--accent-blue); }
        .tag-industry-finance { background: rgba(236, 72, 153, 0.1); border-color: rgba(236, 72, 153, 0.3); color: #ec4899; }
        .tag-industry-medical { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--accent-red); }
        .tag-industry-construction { background: rgba(251, 146, 60, 0.1); border-color: rgba(251, 146, 60, 0.3); color: #fb923c; }
        .tag-industry-service { background: rgba(167, 139, 250, 0.1); border-color: rgba(167, 139, 250, 0.3); color: #a78bfa; }
        .tag-industry-unknown { background: rgba(113, 113, 122, 0.1); border-color: rgba(113, 113, 122, 0.3); color: var(--text-muted); }

        /* 用户筛选工具栏 */
        .user-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            align-items: center;
        }
        .user-filter-bar .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        .user-filter-bar .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .user-filter-bar .search-input::placeholder {
            color: var(--text-muted);
        }
        .user-filter-bar .filter-select {
            padding: 10px 32px 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: all 0.2s;
        }
        .user-filter-bar .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .user-filter-bar .filter-select:hover {
            border-color: var(--border-light);
        }
        .filter-count {
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            font-size: 13px;
            color: var(--accent-blue);
        }

        /* 视图切换按钮组 */
        .view-toggle-group {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .view-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .view-toggle-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        /* 表格视图样式 */
        .users-table-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }
        .users-table th {
            background: var(--bg-secondary);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .users-table th:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .users-table th.sorted {
            color: var(--accent-blue);
        }
        .users-table th .sort-icon {
            display: inline-block;
            margin-left: 6px;
            opacity: 0.3;
            transition: all 0.2s;
        }
        .users-table th.sorted .sort-icon {
            opacity: 1;
        }
        .users-table th.sorted.desc .sort-icon {
            transform: rotate(180deg);
        }
        .users-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-secondary);
            vertical-align: middle;
        }
        .users-table tr:last-child td {
            border-bottom: none;
        }
        .users-table tr:hover td {
            background: var(--bg-secondary);
        }
        .users-table .user-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .users-table .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        .users-table .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .users-table .user-info .name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .users-table .user-info .company {
            font-size: 12px;
            color: var(--text-muted);
        }
        .users-table .tag-industry {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .users-table .credits-cell {
            font-weight: 600;
            color: var(--accent-green);
        }
        .users-table .credits-cell.low {
            color: var(--accent-orange);
        }
        .users-table .credits-cell.zero {
            color: var(--text-muted);
        }
        .users-table .action-btns {
            display: flex;
            gap: 8px;
        }
        .users-table .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .users-table .action-btn.view {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-blue);
        }
        .users-table .action-btn.view:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        .users-table .action-btn.edit {
            background: rgba(34, 197, 94, 0.1);
            color: var(--accent-green);
        }
        .users-table .action-btn.edit:hover {
            background: rgba(34, 197, 94, 0.2);
        }

        /* 紧凑视图样式 */
        .users-compact-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 8px;
        }
        .user-compact-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-radius: 8px;
            gap: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .user-compact-item:hover {
            background: var(--bg-secondary);
        }
        .user-compact-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }
        .user-compact-item .info {
            flex: 1;
            min-width: 0;
        }
        .user-compact-item .name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        .user-compact-item .company {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-compact-item .stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-muted);
        }
        .user-compact-item .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .user-compact-item .stat-value {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .user-compact-item .tag-industry {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .user-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .user-stat {
            text-align: center;
        }

        .user-stat-num {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* 会话卡片 - 现代风格 */
        .session-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .session-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .session-user {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .clickable-user {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-user:hover {
            text-decoration: underline;
            color: #0066ff;
            transform: translateX(2px);
        }

        .session-company {
            padding: 3px 10px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-amber);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-position {
            padding: 3px 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .session-module {
            padding: 4px 12px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* 消息列表 - 现代风格 */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .msg-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .msg-user {
            background: var(--bg-card-hover);
        }

        .msg-assistant {
            background: transparent;
            border: 1px solid var(--border-color);
        }

        .msg-role {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* 按钮 - 现代风格 */
        .btn-expand {
            padding: 8px 14px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-expand:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* 提示词管理样式 - 现代风格 */
        .prompt-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .module-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
        }

        .module-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .module-list-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn-add-module {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-module:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .module-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .module-item:hover {
            background: var(--bg-card-hover);
        }

        .module-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .module-icon {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 18px;
        }

        .module-item-info {
            flex: 1;
        }

        .module-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .module-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .btn-delete-module {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-item:hover .btn-delete-module {
            opacity: 1;
        }

        .btn-delete-module:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .prompt-editor {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .prompt-editor-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            font-family: inherit;
            padding: 6px 12px;
            outline: none;
            transition: all 0.2s;
            min-width: 120px;
            max-width: 300px;
        }

        .module-name-input:hover {
            border-color: var(--border-color);
            background: var(--bg-card-hover);
        }

        .module-name-input:focus {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .prompt-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .prompt-tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .prompt-tab-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .prompt-tab-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
            font-weight: 500;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-save-prompt {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save-prompt:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* 知识库样式 - 现代风格 */
        .knowledge-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .knowledge-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .knowledge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
        }

        .knowledge-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .knowledge-icon {
            font-size: 20px;
        }

        .knowledge-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .knowledge-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .btn-delete-knowledge {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-delete-knowledge:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-zone label {
            cursor: pointer;
            color: var(--text-secondary);
        }

        .upload-zone label strong {
            color: var(--accent-blue);
        }

        /* 新模块弹窗 - 现代风格 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-form .form-group {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-cancel {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-modal-cancel:hover {
            background: var(--bg-card-hover);
        }

        .btn-modal-submit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .emoji-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .emoji-option:hover,
        .emoji-option.selected {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }

        /* 用户画像模态框 */
        .user-profile-modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 0;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .user-profile-modal-content .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .user-profile-modal-content .modal-header h2 {
            margin: 0;
        }

        .user-profile-modal-content .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card-hover);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* 调研记录模态框样式 */
        .research-notes-modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .research-notes-modal-content .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .research-notes-modal-content .modal-body {
            padding: 24px 32px;
            overflow-y: auto;
            flex: 1;
        }

        .research-add-section { margin-bottom: 24px; }

        .btn-add-research {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-research:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .research-form {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .research-form .form-group { margin-bottom: 16px; }

        .research-form label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .research-form select,
        .research-form textarea,
        .research-form input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .research-form textarea { resize: vertical; min-height: 120px; }

        .research-upload {
            border: 2px dashed var(--border-light);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .research-upload:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.05);
        }

        .research-upload input[type="file"] { display: none; }

        .research-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .research-form-actions .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
        }

        .research-form-actions .btn-submit {
            padding: 10px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .research-timeline { position: relative; padding-left: 32px; }

        .research-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .timeline-item:hover { border-color: var(--border-light); }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 24px;
            width: 12px;
            height: 12px;
            background: var(--accent-purple);
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timeline-category {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: var(--accent-purple);
        }

        .timeline-date { font-size: 12px; color: var(--text-muted); }

        .timeline-content {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .timeline-file {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-file-icon { font-size: 24px; }

        .timeline-file-name {
            font-size: 13px;
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .timeline-file-name:hover { text-decoration: underline; }

        .timeline-notes {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--accent-amber);
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: var(--accent-amber);
        }

        .timeline-actions { margin-top: 12px; text-align: right; }

        .btn-delete-research {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            color: var(--accent-red);
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-delete-research:hover { background: rgba(239, 68, 68, 0.2); }

        .research-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .research-empty-icon { font-size: 48px; margin-bottom: 12px; }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner p {
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .profile-content ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .profile-content li {
            margin-bottom: 8px;
        }

        .profile-stat {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* 搜索和导出栏 - 现代风格 */
        .search-export-bar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 280px;
            max-width: 500px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            color: var(--bg-primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .search-clear-btn:hover {
            background: var(--text-secondary);
        }

        .search-result-count {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .search-result-count.has-results {
            color: var(--accent-green);
        }

        .export-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-export {
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-export-user {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .btn-export-user:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* 用户详情面板 - 现代风格 */
        .user-detail-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-detail-info h2 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            color: var(--accent-blue);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-detail-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-back {
            padding: 10px 18px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: var(--bg-card-hover);
        }

        .btn-user-profile {
            padding: 10px 18px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-user-profile:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn-user-profile:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-user-insight {
            padding: 10px 18px;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-user-insight:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .btn-tool-analysis {
            padding: 10px 18px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-tool-analysis:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-research-notes {
            padding: 10px 18px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-research-notes:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn-export-single {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-export-single:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* 兑换码管理样式 - 现代风格 */
        .redeem-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .redeem-form-card,
        .redeem-list-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
        }

        .redeem-form-card h3,
        .redeem-list-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .redeem-form .form-row {
            display: flex;
            gap: 16px;
        }

        .redeem-form .form-group {
            flex: 1;
            margin-bottom: 16px;
        }

        .redeem-form label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .redeem-form input,
        .redeem-form select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .redeem-form input:focus,
        .redeem-form select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-create-code {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-create-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .redeem-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            text-align: center;
        }

        .result-code {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
            letter-spacing: 4px;
            margin-bottom: 12px;
        }

        .btn-copy-code {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy-code:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .redeem-codes-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .redeem-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .redeem-code-info {
            flex: 1;
        }

        .redeem-code-value {
            font-family: 'Plus Jakarta Sans', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-blue);
            letter-spacing: 2px;
        }

        .redeem-code-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .redeem-code-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 12px;
        }

        .status-unused {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .status-used {
            background: rgba(161, 161, 170, 0.15);
            color: var(--text-muted);
        }

        .btn-delete-code {
            padding: 8px 14px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s;
        }

        .btn-delete-code:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-delete-code:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 日志筛选按钮 - 现代风格 */
        .log-filter-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .log-filter-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .log-filter-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-color: transparent;
        }

        /* 日志列表项 */
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: var(--bg-card-hover);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .log-item-info {
            flex: 1;
        }

        .log-item-action {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .log-item-target {
            color: var(--accent-blue);
            font-weight: 500;
        }

        .log-item-details {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.5;
        }

        .log-item-admin {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
        }

        .log-item-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* 图标编辑器样式 */
        .icon-editor-wrapper {
            position: relative;
            display: inline-block;
        }

        .editable-icon {
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed transparent;
        }

        .editable-icon:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-blue);
        }

        .editable-icon::after {
            content: '✏️';
            font-size: 12px;
            position: absolute;
            bottom: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .icon-editor-wrapper:hover .editable-icon::after {
            opacity: 1;
        }

        .icon-picker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            min-width: 280px;
        }

        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .icon-picker-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            background: transparent;
        }

        .icon-picker-option:hover {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.1);
        }

        .icon-picker-option.selected {
            border-color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        /* 版本历史样式 */
        .version-item {
            display: flex;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-item:hover {
            background: var(--bg-card-hover);
        }

        .version-badge {
            flex-shrink: 0;
            width: 72px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .version-badge.major {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .version-content {
            flex: 1;
        }

        .version-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .version-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .version-desc ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .version-desc li {
            margin-bottom: 4px;
        }

        .version-date {
            flex-shrink: 0;
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
            min-width: 80px;
        }

        .version-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .version-tag.feature {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .version-tag.fix {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .version-tag.ui {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .version-tag.optimize {
            background: rgba(34, 211, 238, 0.15);
            color: var(--accent-cyan);
        }
    </style>
</head>

<body>
    <!-- 登录框 -->
    <div class="login-box" id="loginBox">
        <h1>管理后台</h1>
        <p class="login-subtitle">电商管理设计工具</p>
        <form id="loginForm" onsubmit="adminLogin(); return false;" autocomplete="on">
            <input type="text" id="adminUsername" name="username" placeholder="用户名"
                autocomplete="username"
                onkeydown="if(event.key==='Enter')document.getElementById('adminPassword').focus()">
            <input type="password" id="adminPassword" name="password" placeholder="密码"
                autocomplete="current-password"
                onkeydown="if(event.key==='Enter')adminLogin()">
            <button type="submit">登录</button>
        </form>
        <p class="error-msg" id="loginError"></p>
    </div>

    <!-- 管理面板（侧边栏布局） -->
    <div class="app-container" id="adminPanel">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">⚡</div>
                    <div>
                        <div class="logo-text">Admin Panel</div>
                        <div class="logo-subtitle">电商管理设计工具</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">数据概览</div>
                    <div class="nav-item active" onclick="switchTab('users')" data-tab="users" data-role="super">
                        <span class="nav-icon">👥</span>
                        <span>用户列表</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('sessions')" data-tab="sessions" data-role="super">
                        <span class="nav-icon">💬</span>
                        <span>聊天记录</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">内容管理</div>
                    <div class="nav-item" onclick="switchTab('prompts')" data-tab="prompts" data-role="super">
                        <span class="nav-icon">📝</span>
                        <span>提示词管理</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('redeem')" data-tab="redeem" data-role="all">
                        <span class="nav-icon">🎫</span>
                        <span>兑换码管理</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">系统设置</div>
                    <div class="nav-item" onclick="switchTab('admins')" data-tab="admins" data-role="super">
                        <span class="nav-icon">👤</span>
                        <span>管理员管理</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('buttons')" data-tab="buttons" data-role="super">
                        <span class="nav-icon">🎛️</span>
                        <span>按钮配置</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('logs')" data-tab="logs" data-role="super">
                        <span class="nav-icon">📋</span>
                        <span>操作日志</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('versions')" data-tab="versions" data-role="all">
                        <span class="nav-icon">🏷️</span>
                        <span>版本历史</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Admin</div>
                        <div class="user-role" id="adminRoleText">超级管理员</div>
                    </div>
                    <button class="btn-logout-small" onclick="adminLogout()">退出</button>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 页面标题 -->
            <div class="main-header">
                <div>
                    <h1 class="page-title" id="pageTitle">用户列表</h1>
                    <p class="page-subtitle" id="pageSubtitle">管理所有注册用户</p>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon users">👥</div>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">注册用户</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon sessions">💬</div>
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">对话会话</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon messages">📨</div>
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">总消息数</div>
                </div>
            </div>

            <!-- 用户详情面板 -->
            <div class="user-detail-panel" id="userDetailPanel">
                <div class="user-detail-header">
                    <div class="user-detail-info">
                        <h2 id="detailUserEmail">用户邮箱</h2>
                        <div class="user-detail-meta">
                            <span class="tag tag-phone" id="detailUserPhone"></span>
                            <span class="tag tag-company" id="detailUserCompany"></span>
                            <span class="tag tag-position" id="detailUserPosition"></span>
                            <span class="tag tag-credits" id="detailUserCredits"></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-back" onclick="hideUserDetail()">← 返回列表</button>
                        <button class="btn-user-insight" onclick="generateUserInsight()">🔍 用户洞察</button>
                        <button class="btn-tool-analysis" onclick="generateToolAnalysis()">🛠️ 工具分析</button>
                        <button class="btn-research-notes" onclick="showResearchNotesModal()">📋 调研记录</button>
                        <button class="btn-export-single" onclick="exportUserSessions()">导出该用户全部对话</button>
                    </div>
                </div>
                <div id="userSessionsList"></div>
            </div>

            <!-- 搜索和导出栏（聊天记录标签下显示） -->
            <div class="search-export-bar" id="exportBar" style="display: none;">
                <!-- 搜索区域 -->
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="sessionSearchInput" class="search-input"
                            placeholder="搜索用户邮箱、公司、消息内容..."
                            oninput="handleSessionSearch()">
                        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                            ✕
                        </button>
                    </div>
                    <span class="search-result-count" id="searchResultCount"></span>
                </div>
                <!-- 导出区域 -->
                <div class="export-section">
                    <span class="export-label">导出数据：</span>
                    <button class="btn-export" onclick="exportChat('all', 'json')">全部对话 (JSON)</button>
                    <button class="btn-export" onclick="exportChat('all', 'csv')">全部对话 (CSV)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'json')">仅用户输入 (JSON)</button>
                    <button class="btn-export btn-export-user" onclick="exportChat('user', 'csv')">仅用户输入 (CSV)</button>
                </div>
            </div>

            <!-- 用户列表 -->
            <div id="usersTab">
                <!-- 筛选工具栏 -->
                <div class="user-filter-bar">
                    <input type="text" class="search-input" id="userSearchInput" placeholder="搜索用户名、公司、手机号..." oninput="filterUsers()">
                    <select class="filter-select" id="industryFilter" onchange="filterUsers()">
                        <option value="">全部行业</option>
                        <option value="科技/互联网">科技/互联网</option>
                        <option value="制造业">制造业</option>
                        <option value="零售/贸易">零售/贸易</option>
                        <option value="教育培训">教育培训</option>
                        <option value="金融">金融</option>
                        <option value="医疗健康">医疗健康</option>
                        <option value="建筑/房产">建筑/房产</option>
                        <option value="服务业">服务业</option>
                        <option value="未知">未知行业</option>
                    </select>
                    <select class="filter-select" id="creditsFilter" onchange="filterUsers()">
                        <option value="">全部积分</option>
                        <option value="zero">无积分 (0)</option>
                        <option value="low">低积分 (<20)</option>
                        <option value="normal">正常 (20-50)</option>
                        <option value="high">高积分 (>50)</option>
                    </select>
                    <select class="filter-select" id="activityFilter" onchange="filterUsers()">
                        <option value="">全部活跃度</option>
                        <option value="inactive">未活跃 (0对话)</option>
                        <option value="low">低活跃 (1-2对话)</option>
                        <option value="medium">中活跃 (3-5对话)</option>
                        <option value="high">高活跃 (>5对话)</option>
                    </select>

                    <!-- 视图切换按钮组 -->
                    <div class="view-toggle-group">
                        <button class="view-toggle-btn active" data-view="card" onclick="switchUserView('card')" title="卡片视图">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                        </button>
                        <button class="view-toggle-btn" data-view="table" onclick="switchUserView('table')" title="表格视图">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <line x1="3" y1="12" x2="21" y2="12"/>
                                <line x1="3" y1="18" x2="21" y2="18"/>
                            </svg>
                        </button>
                        <button class="view-toggle-btn" data-view="compact" onclick="switchUserView('compact')" title="紧凑视图">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="3" y1="4" x2="21" y2="4"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="3" y1="14" x2="21" y2="14"/>
                                <line x1="3" y1="19" x2="21" y2="19"/>
                            </svg>
                        </button>
                    </div>

                    <span class="filter-count" id="filterCount">显示 0 / 0 用户</span>
                </div>
                <div id="usersList"></div>
            </div>

            <!-- 会话列表 -->
            <div id="sessionsTab" class="hidden">
                <div id="sessionsList"></div>
            </div>

            <!-- 提示词管理 -->
            <div id="promptsTab" class="hidden">
                <div class="prompt-container">
                    <!-- 模块列表 -->
                    <div class="module-list">
                        <div class="module-list-header">
                            <h3>模块列表</h3>
                            <button class="btn-add-module" onclick="showAddModuleModal()">+ 新增模块</button>
                        </div>
                        <div id="moduleListItems">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>

                    <!-- 提示词编辑器 -->
                    <div class="prompt-editor" id="promptEditor" style="display: none;">
                        <div class="prompt-editor-header">
                            <div class="prompt-editor-title">
                                <div class="icon-editor-wrapper">
                                    <span id="currentModuleIcon" class="editable-icon" onclick="showIconPicker()" title="点击修改图标">📋</span>
                                    <div id="iconPickerDropdown" class="icon-picker-dropdown" style="display: none;">
                                        <div class="icon-picker-grid" id="iconPickerGrid">
                                            <!-- 图标选项会由 JS 动态生成 -->
                                        </div>
                                    </div>
                                </div>
                                <input type="text" id="currentModuleName" class="module-name-input" value=""
                                    placeholder="模块名称" onblur="saveModuleName()"
                                    onkeydown="if(event.key==='Enter'){this.blur()}">
                            </div>
                            <button class="btn-save-prompt" onclick="savePrompt()">保存提示词</button>
                        </div>

                        <div class="prompt-tabs">
                            <button class="prompt-tab-btn active" onclick="switchPromptTab('prompt')">系统提示词</button>
                            <button class="prompt-tab-btn" onclick="switchPromptTab('welcome')">欢迎引导</button>
                            <button class="prompt-tab-btn" onclick="switchPromptTab('knowledge')">知识库</button>
                        </div>

                        <!-- 提示词编辑 -->
                        <div id="promptContent">
                            <textarea class="prompt-textarea" id="promptTextarea"
                                placeholder="输入该模块的系统提示词..."></textarea>
                        </div>

                        <!-- 欢迎引导编辑 -->
                        <div id="welcomeContent" style="display: none;">
                            <div class="welcome-section" style="display: flex; flex-direction: column; gap: 20px;">
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">欢迎语</label>
                                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">用户进入模块时显示的欢迎文字，支持 Markdown 格式</p>
                                    <textarea class="prompt-textarea" id="welcomeTextarea"
                                        placeholder="例如：欢迎使用**评价教练**！&#10;&#10;教你写出高转化评价。&#10;&#10;请告诉我您的需求，我会为您提供专业的建议和方案。"
                                        style="min-height: 150px;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">输入格式引导</label>
                                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">固定显示在欢迎语下方，引导用户按正确格式输入信息，支持 Markdown 格式</p>
                                    <textarea class="prompt-textarea" id="inputGuideTextarea"
                                        placeholder="例如：请提供以下信息：&#10;1. 产品名称&#10;2. 产品特点&#10;3. 目标用户群体"
                                        style="min-height: 120px;"></textarea>
                                </div>
                                <button class="btn-save-prompt" onclick="saveWelcomeConfig()" style="align-self: flex-start;">保存欢迎配置</button>
                            </div>
                        </div>

                        <!-- 知识库管理 -->
                        <div id="knowledgeContent" style="display: none;">
                            <div class="knowledge-section">
                                <div class="knowledge-header">
                                    <h3>知识库文件</h3>
                                </div>
                                <div class="knowledge-list" id="knowledgeList">
                                    <p class="loading">暂无知识库文件</p>
                                </div>
                                <div class="upload-zone">
                                    <input type="file" id="knowledgeUpload" accept=".txt,.md,.pdf,.docx"
                                        onchange="uploadKnowledge()">
                                    <label for="knowledgeUpload">
                                        📁 点击或拖拽上传文件<br>
                                        <small>支持 TXT、MD、PDF、DOCX 格式</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p id="promptSaveStatus" style="margin-top: 12px; font-size: 13px; color: #10b981;"></p>
                    </div>

                    <!-- 未选择模块时的占位 -->
                    <div class="prompt-editor" id="promptPlaceholder">
                        <div style="text-align: center; padding: 100px 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">👈</div>
                            <p>请从左侧选择一个模块进行编辑</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 兑换码管理 -->
            <div id="redeemTab" class="hidden">
                <div class="redeem-container">
                    <!-- 📱 手机号直接充值（新功能） -->
                    <div class="redeem-form-card" style="margin-bottom: 24px; border: 2px solid rgba(16, 185, 129, 0.3); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(6, 78, 59, 0.1));">
                        <h3 style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">📱</span>
                            手机号直接充值
                            <span style="font-size: 12px; padding: 2px 8px; background: #10b981; color: white; border-radius: 4px; margin-left: 8px;">推荐</span>
                        </h3>
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                            输入手机号直接充值，用户已注册即时到账，未注册则自动预存、注册后到账
                        </p>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>用户手机号</label>
                                <input type="tel" id="directRechargePhone" placeholder="输入11位手机号" maxlength="11">
                            </div>

                            <div class="form-group">
                                <label>充值积分</label>
                                <input type="number" id="directRechargeCredits" placeholder="输入积分数量" min="1"
                                    oninput="updateDirectRechargePreview()">
                                <div id="directRechargeHint" style="font-size: 13px; color: var(--text-muted); margin-top: 8px;">
                                    💡 提示：2积分 ≈ 1次回答机会
                                </div>
                            </div>

                            <div class="form-group">
                                <label>充值原因（选填）</label>
                                <input type="text" id="directRechargeReason" placeholder="如：VIP客户、活动赠送">
                            </div>

                            <button class="btn-create-code" id="directRechargeBtn" onclick="directRechargeCredits()"
                                style="background: linear-gradient(135deg, #10b981, #059669);">
                                💰 确认充值
                            </button>
                        </div>

                        <!-- 充值结果 -->
                        <div id="directRechargeResult" class="redeem-result" style="display: none;">
                            <div style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 8px;">✅ 充值成功</div>
                            <div style="font-size: 14px; color: var(--text-secondary);" id="directRechargeResultText"></div>
                        </div>
                    </div>

                    <!-- 📱 批量手机号充值（新功能） -->
                    <div class="redeem-form-card" style="margin-bottom: 24px; border: 2px solid rgba(168, 85, 247, 0.3); background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(88, 28, 135, 0.1));">
                        <h3 style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">📋</span>
                            批量手机号充值
                            <span style="font-size: 12px; padding: 2px 8px; background: #a855f7; color: white; border-radius: 4px; margin-left: 8px;">批量</span>
                        </h3>
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                            上传 Excel 或直接输入多个手机号，批量充值积分
                        </p>
                        <div class="redeem-form">
                            <!-- 上传 Excel -->
                            <div class="form-group">
                                <label>方式一：上传 Excel 文件</label>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <input type="file" id="batchExcelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload()">
                                    <button type="button" onclick="document.getElementById('batchExcelFile').click()"
                                        style="padding: 12px 20px; background: #282A2C; border: 1px dashed #444746; border-radius: 8px; color: var(--text-secondary); cursor: pointer; flex: 1; text-align: center;">
                                        📄 点击选择 Excel 文件
                                    </button>
                                    <span id="excelFileName" style="color: var(--text-muted); font-size: 13px;"></span>
                                </div>
                            </div>

                            <!-- 手动输入 -->
                            <div class="form-group">
                                <label>方式二：手动输入手机号</label>
                                <textarea id="batchPhonesInput" placeholder="每行一个手机号，或用逗号/空格分隔&#10;&#10;示例：&#10;13800138000&#10;13900139000&#10;或 13800138000,13900139000"
                                    style="width: 100%; min-height: 120px; padding: 12px 16px; background: var(--bg-card-hover); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Plus Jakarta Sans', monospace; resize: vertical;"
                                    oninput="parseBatchPhones()"></textarea>
                            </div>

                            <!-- 识别结果 -->
                            <div id="batchPhonesSummary" style="padding: 12px 16px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; margin-bottom: 16px; display: none;">
                                <span style="color: #a855f7; font-weight: 600;">📱 已识别 <span id="batchPhonesCount">0</span> 个手机号</span>
                                <span id="batchPhonesPreview" style="color: var(--text-muted); font-size: 13px; margin-left: 12px;"></span>
                            </div>

                            <!-- 充值设置 -->
                            <div class="form-row" style="display: flex; gap: 16px;">
                                <div class="form-group" style="flex: 1;">
                                    <label>统一充值积分</label>
                                    <input type="number" id="batchCredits" placeholder="输入积分数量" min="1" oninput="updateBatchPreview()">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>充值原因（可选）</label>
                                    <input type="text" id="batchReason" placeholder="如：活动赠送、批量发放">
                                </div>
                            </div>

                            <div id="batchHint" style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                                💡 提示：2积分 ≈ 1次回答机会
                            </div>

                            <button class="btn-create-code" id="batchRechargeBtn" onclick="batchRechargeCredits()" disabled
                                style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                                📋 开始批量充值
                            </button>
                        </div>

                        <!-- 批量充值结果 -->
                        <div id="batchRechargeResult" class="redeem-result" style="display: none; text-align: left;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;" id="batchResultTitle"></div>
                            <div id="batchResultDetails" style="max-height: 200px; overflow-y: auto; background: var(--bg-primary); border-radius: 8px; padding: 12px;"></div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid var(--border-color); margin: 0 0 24px 0; padding-top: 24px;">
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                            👇 以下为旧版兑换码功能，仍可继续使用
                        </p>
                    </div>

                    <!-- 创建兑换码表单 -->
                    <div class="redeem-form-card">
                        <h3>生成兑换码</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>目标用户姓名</label>
                                <input type="text" id="redeemTargetName" placeholder="输入用户姓名">
                            </div>

                            <!-- 用户类型选择 -->
                            <div class="form-group">
                                <label>用户类型</label>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid #444746;"
                                        id="typeBusinessSchoolLabel">
                                        <input type="radio" name="redeemUserType" value="business_school"
                                            onchange="toggleRedeemType()" checked>
                                        <span>🎓 商学院学员</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #282A2C; border-radius: 8px; flex: 1; border: 2px solid transparent;"
                                        id="typeCatCoinsLabel">
                                        <input type="radio" name="redeemUserType" value="cat_coins"
                                            onchange="toggleRedeemType()">
                                        <span>🐱 猫币兑换</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 商学院用户积分显示 -->
                            <div class="form-group" id="businessSchoolInfo">
                                <div
                                    style="padding: 16px; background: rgba(129, 201, 149, 0.15); border-radius: 12px; border: 1px solid #81C995;">
                                    <div style="font-size: 16px; font-weight: 600; color: #81C995; margin-bottom: 8px;">
                                        🎓 商学院学员专属</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #E3E3E3;">2000 积分</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">约 1000 次回答机会</div>
                                </div>
                            </div>

                            <!-- 猫币输入（仅猫币兑换时显示） -->
                            <div class="form-group" id="catCoinsInputGroup" style="display: none;">
                                <label>猫币数量</label>
                                <input type="number" id="redeemCatCoins" placeholder="输入猫币数量" min="1"
                                    oninput="updateRedeemPreview()">
                                <div class="cat-coin-preview" id="redeemPreview"
                                    style="padding: 12px; background: rgba(129, 201, 149, 0.1); border-radius: 8px; color: #81C995; font-size: 14px; display: none; margin-top: 8px;">
                                </div>
                                <div
                                    style="padding: 12px; background: #282A2C; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #C4C7C5;">
                                    <div style="font-weight: 500; margin-bottom: 8px; color: #E3E3E3;">💡 猫币兑换规则</div>
                                    <div>• 每个猫币 = 20积分</div>
                                    <div style="margin-top: 8px; color: #81C995;">示例：5猫币 = 100积分（约50次回答机会）</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>备注（可选）</label>
                                <input type="text" id="redeemNote" placeholder="如：猫课学员、VIP客户等">
                            </div>
                            <button class="btn-create-code" onclick="createRedeemCode()">生成兑换码</button>
                        </div>
                        <!-- 生成结果 -->
                        <div id="redeemResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="generatedCode"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;" id="generatedCredits">
                            </div>
                            <button class="btn-copy-code" onclick="copyRedeemCode()">复制兑换码</button>
                        </div>

                        <!-- 批量生成分隔线 -->
                        <div style="border-top: 1px solid var(--border-color); margin: 24px 0; padding-top: 24px;">
                            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">批量生成兑换码</h3>
                            <div class="redeem-form">
                                <div style="display: flex; gap: 12px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>积分数量</label>
                                        <input type="number" id="batchCredits" placeholder="每个兑换码的积分" min="1">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>生成数量</label>
                                        <input type="number" id="batchCount" placeholder="1-100" min="1" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>备注（可选）</label>
                                    <input type="text" id="batchNote" placeholder="如：活动赠送、批量发放等">
                                </div>
                                <button class="btn-create-code" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="batchCreateRedeemCodes()">批量生成</button>
                            </div>
                            <!-- 批量生成结果 -->
                            <div id="batchResult" class="redeem-result" style="display: none;">
                                <div style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 12px;" id="batchResultTitle"></div>
                                <div id="batchCodesList" style="max-height: 200px; overflow-y: auto; text-align: left; background: var(--bg-primary); border-radius: 8px; padding: 12px;"></div>
                                <button class="btn-copy-code" style="margin-top: 12px;" onclick="copyBatchCodes()">复制全部兑换码</button>
                            </div>
                        </div>
                    </div>

                    <!-- 兑换码列表 -->
                    <div class="redeem-list-card">
                        <h3>兑换码记录</h3>
                        <div id="redeemCodesList" class="redeem-codes-list">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div id="logsTab" class="hidden">
                <div class="logs-container">
                    <!-- 日志筛选 -->
                    <div class="logs-filter" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="log-filter-btn active" onclick="filterLogs('all')">全部日志</button>
                        <button class="log-filter-btn" onclick="filterLogs('redeem')">兑换码管理</button>
                        <button class="log-filter-btn" onclick="filterLogs('user_redeem')">用户兑换</button>
                        <button class="log-filter-btn" onclick="filterLogs('prompt')">提示词操作</button>
                    </div>
                    <!-- 日志列表 -->
                    <div class="logs-list-card" style="background: #1E1F20; border-radius: 16px; padding: 24px;">
                        <h3
                            style="font-size: 16px; color: #E3E3E3; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #444746;">
                            操作日志</h3>
                        <div id="adminLogsList" class="admin-logs-list" style="max-height: 600px; overflow-y: auto;">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 管理员管理（仅主管理员可见） -->
            <div id="adminsTab" class="hidden">
                <div class="redeem-container">
                    <!-- 添加管理员表单 -->
                    <div class="redeem-form-card">
                        <h3>添加管理员</h3>
                        <div class="redeem-form">
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" id="newAdminUsername" placeholder="输入用户名">
                            </div>
                            <div class="form-group">
                                <label>备注（可选）</label>
                                <input type="text" id="newAdminNote" placeholder="如：运营组、销售组">
                            </div>
                            <div class="form-group">
                                <div style="padding: 16px; background: rgba(168, 199, 250, 0.1); border-radius: 12px; border: 1px solid #A8C7FA;">
                                    <div style="font-size: 14px; color: #A8C7FA; margin-bottom: 8px;">💡 默认密码</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #E3E3E3;">maoke2024</div>
                                    <div style="font-size: 13px; color: #C4C7C5; margin-top: 4px;">新管理员首次登录请使用此密码</div>
                                </div>
                            </div>
                            <button class="btn-create-code" onclick="createAdmin()">添加管理员</button>
                        </div>
                        <!-- 添加结果 -->
                        <div id="adminResult" class="redeem-result" style="display: none;">
                            <div class="result-code" id="createdAdminName"></div>
                            <div style="font-size: 14px; color: #C4C7C5; margin-bottom: 12px;">默认密码：maoke2024</div>
                        </div>
                    </div>

                    <!-- 管理员列表 -->
                    <div class="redeem-list-card">
                        <h3>管理员列表</h3>
                        <div id="adminsList" class="redeem-codes-list">
                            <p class="loading">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 按钮配置（仅主管理员可见） -->
            <div id="buttonsTab" class="hidden">
                <div class="buttons-container" style="max-width: 900px;">
                    <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #a5b4fc;">
                            <span>💡</span>
                            <span>配置用户详情页的三个分析按钮（生成用户画像、用户洞察、工具分析）的名称和提示词</span>
                        </div>
                    </div>

                    <div id="buttonConfigList" style="display: flex; flex-direction: column; gap: 24px;">
                        <p class="loading">加载中...</p>
                    </div>
                </div>
            </div>

            <!-- 版本历史 -->
            <div id="versionsTab" class="hidden">
                <div class="versions-container" style="max-width: 800px;">
                    <!-- 当前版本卡片 -->
                    <div class="current-version-card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">当前版本</div>
                                <div style="font-size: 32px; font-weight: 700; color: var(--accent-blue);" id="currentVersionNum">v1.0.0</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 13px; color: var(--text-muted);">累计更新</div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--text-primary);" id="totalVersionCount">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- 版本列表 -->
                    <div class="content-panel">
                        <div class="panel-header">
                            <div class="panel-title">版本更新记录</div>
                        </div>
                        <div class="panel-body" id="versionsList" style="max-height: 600px; overflow-y: auto;">
                            <!-- 版本条目会由 JS 渲染 -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 新增模块弹窗 -->
    <div class="modal-overlay" id="addModuleModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>新增模块</h2>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label>模块ID（英文，如 customer_research）</label>
                    <input type="text" id="newModuleId" placeholder="customer_research">
                </div>
                <div class="form-group">
                    <label>模块名称</label>
                    <input type="text" id="newModuleName" placeholder="客户调研">
                </div>
                <div class="form-group">
                    <label>模块描述</label>
                    <input type="text" id="newModuleDesc" placeholder="帮助分析客户需求和市场反馈">
                </div>
                <div class="form-group">
                    <label>副标题</label>
                    <input type="text" id="newModuleSubtitle" placeholder="深入了解目标客户">
                </div>
                <div class="form-group">
                    <label>选择图标</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" onclick="selectEmoji('📊')">📊</span>
                        <span class="emoji-option" onclick="selectEmoji('🎯')">🎯</span>
                        <span class="emoji-option" onclick="selectEmoji('💡')">💡</span>
                        <span class="emoji-option" onclick="selectEmoji('📈')">📈</span>
                        <span class="emoji-option" onclick="selectEmoji('🔍')">🔍</span>
                        <span class="emoji-option" onclick="selectEmoji('🛒')">🛒</span>
                        <span class="emoji-option" onclick="selectEmoji('👥')">👥</span>
                        <span class="emoji-option" onclick="selectEmoji('📝')">📝</span>
                        <span class="emoji-option" onclick="selectEmoji('🚀')">🚀</span>
                        <span class="emoji-option" onclick="selectEmoji('⭐')">⭐</span>
                    </div>
                    <input type="hidden" id="newModuleIcon" value="📊">
                </div>
                <div class="form-group">
                    <label>主题色</label>
                    <input type="color" id="newModuleColor" value="#6366f1"
                        style="width: 60px; height: 40px; padding: 4px;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="hideAddModuleModal()">取消</button>
                <button class="btn-modal-submit" onclick="createModule()">创建模块</button>
            </div>
        </div>
    </div>

    <!-- 用户画像模态框 -->
    <div id="userProfileModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) hideUserProfileModal()">
        <div class="modal-content user-profile-modal-content">
            <div class="modal-header">
                <h2 id="userProfileModalTitle">🎯 用户画像分析</h2>
                <button class="modal-close" onclick="hideUserProfileModal()">✕</button>
            </div>
            <div class="modal-body">
                <div id="userProfileContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>正在分析用户聊天记录，请稍候...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户调研记录模态框 -->
    <div id="researchNotesModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) hideResearchNotesModal()">
        <div class="modal-content research-notes-modal-content">
            <div class="modal-header">
                <h2>📋 用户调研记录</h2>
                <button class="modal-close" onclick="hideResearchNotesModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 添加调研按钮 -->
                <div class="research-add-section">
                    <button class="btn-add-research" onclick="showAddResearchForm()">➕ 添加调研记录</button>
                </div>

                <!-- 添加调研表单 -->
                <div id="addResearchForm" class="research-form" style="display: none;">
                    <div class="form-group">
                        <label>调研类型</label>
                        <select id="researchCategory">
                            <option value="phone_call">📞 电话沟通录音转文字</option>
                            <option value="site_visit">🏢 现场拜访</option>
                            <option value="wechat_chat">💬 微信沟通</option>
                            <option value="email">📧 邮件沟通</option>
                            <option value="meeting">📋 会议记录</option>
                            <option value="survey">📝 问卷调研</option>
                            <option value="other">📎 其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>调研内容（可粘贴文字）</label>
                        <textarea id="researchContent" rows="6" placeholder="粘贴或输入调研内容..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>上传文件（可选）</label>
                        <div class="research-upload" onclick="document.getElementById('researchFileUpload').click()">
                            <input type="file" id="researchFileUpload" accept=".pdf,.doc,.docx,.txt" onchange="previewResearchFile()">
                            <div>📁 点击上传文件<br><small style="color: var(--text-muted);">支持 PDF、Word、TXT 格式</small></div>
                        </div>
                        <div id="researchFilePreview" style="display: none; margin-top: 8px;"></div>
                    </div>
                    <div class="form-group">
                        <label>备注（可选）</label>
                        <input type="text" id="researchNotes" placeholder="如：关键决策人、后续跟进事项">
                    </div>
                    <div class="research-form-actions">
                        <button class="btn-cancel" onclick="hideAddResearchForm()">取消</button>
                        <button class="btn-submit" onclick="submitResearchNote()">保存</button>
                    </div>
                </div>

                <!-- 调研时间线 -->
                <div id="researchTimeline" class="research-timeline">
                    <p class="loading" style="text-align: center; color: var(--text-muted);">加载中...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局数据
        let allUsers = [];

        // 视图状态
        let currentUserView = 'card'; // card, table, compact
        let tableSortField = 'created_at';
        let tableSortDirection = 'desc';
        let allSessions = [];
        let currentUserEmail = null;
        let currentAdminRole = 'normal';  // 当前管理员角色：'super' 或 'normal'

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', async function() {
            await checkLoginStatus();
        });

        // 检查是否已登录
        async function checkLoginStatus() {
            try {
                const res = await fetch('/api/admin/me');
                const data = await res.json();

                if (data.success) {
                    // 已登录，直接显示管理面板
                    currentAdminRole = data.role || 'normal';
                    const username = data.username || 'Admin';

                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';

                    // 更新侧边栏用户信息
                    const adminName = username.charAt(0).toUpperCase() + username.slice(1);
                    document.getElementById('adminName').textContent = adminName;
                    document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
                    document.getElementById('adminRoleText').textContent = currentAdminRole === 'super' ? '超级管理员' : '普通管理员';

                    // 根据角色显示/隐藏标签页
                    setupTabsForRole(currentAdminRole);

                    // 加载数据
                    if (currentAdminRole === 'super') {
                        loadData();
                    } else {
                        // 普通管理员直接跳转到兑换码管理
                        switchTab('redeem');
                        loadRedeemCodes();
                    }
                }
                // 如果未登录，保持显示登录框（默认状态）
            } catch (e) {
                console.log('检查登录状态失败，显示登录框');
            }
        }

        // 管理员登录
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = '请输入用户名和密码';
                return;
            }

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    currentAdminRole = data.role || 'normal';
                    document.getElementById('loginBox').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';

                    // 更新侧边栏用户信息
                    const adminName = username.charAt(0).toUpperCase() + username.slice(1);
                    document.getElementById('adminName').textContent = adminName;
                    document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
                    document.getElementById('adminRoleText').textContent = currentAdminRole === 'super' ? '超级管理员' : '普通管理员';

                    // 根据角色显示/隐藏标签页
                    setupTabsForRole(currentAdminRole);

                    // 加载数据
                    if (currentAdminRole === 'super') {
                        loadData();
                    } else {
                        // 普通管理员直接跳转到兑换码管理
                        switchTab('redeem');
                        loadRedeemCodes();
                    }
                } else {
                    errorEl.textContent = data.message || data.error;
                }
            } catch (e) {
                errorEl.textContent = '网络错误';
            }
        }

        // 根据角色设置标签页显示
        function setupTabsForRole(role) {
            const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
            navItems.forEach(item => {
                const itemRole = item.getAttribute('data-role');
                if (itemRole === 'super' && role !== 'super') {
                    item.style.display = 'none';
                } else {
                    item.style.display = '';
                }
            });

            // 隐藏统计数据（普通管理员不显示）
            if (role !== 'super') {
                document.getElementById('statsGrid').style.display = 'none';
            }
        }

        function adminLogout() {
            location.reload();
        }

        // 加载数据（先加载所有数据，再渲染）
        async function loadData() {
            // 并行加载用户和会话数据
            const [usersRes, sessionsRes] = await Promise.all([
                fetch('/api/admin/users').then(r => r.json()).catch(() => ({ success: false })),
                fetch('/api/admin/sessions').then(r => r.json()).catch(() => ({ success: false }))
            ]);

            // 保存数据
            if (usersRes.success) {
                allUsers = usersRes.users || [];
                document.getElementById('totalUsers').textContent = allUsers.length;
            }

            if (sessionsRes.success) {
                allSessions = sessionsRes.sessions || [];
                document.getElementById('totalSessions').textContent = allSessions.length;

                // 计算总消息数
                let totalMsgs = 0;
                allSessions.forEach(s => {
                    totalMsgs += (s.messages || []).length;
                });
                document.getElementById('totalMessages').textContent = totalMsgs;
            }

            // 数据都加载完成后再渲染
            renderUsers();
            renderSessions();
        }

        // 加载用户（保留用于单独刷新）
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                if (data.success) {
                    allUsers = data.users || [];
                    document.getElementById('totalUsers').textContent = allUsers.length;
                    renderUsers();
                }
            } catch (e) {
                console.error('加载用户失败', e);
            }
        }

        // 加载会话（保留用于单独刷新）
        async function loadSessions() {
            try {
                const res = await fetch('/api/admin/sessions');
                const data = await res.json();

                if (data.success) {
                    allSessions = data.sessions || [];
                    document.getElementById('totalSessions').textContent = allSessions.length;

                    // 计算总消息数
                    let totalMsgs = 0;
                    allSessions.forEach(s => {
                        totalMsgs += (s.messages || []).length;
                    });
                    document.getElementById('totalMessages').textContent = totalMsgs;

                    renderSessions();
                }
            } catch (e) {
                console.error('加载会话失败', e);
            }
        }

        // 渲染用户列表（带统计信息）
        // 行业关键词映射表
        const industryKeywords = {
            '科技/互联网': ['科技', '网络', '软件', '信息', '数据', '智能', 'AI', '互联网', '云', '数字', '电子商务', '平台'],
            '制造业': ['机电', '机械', '设备', '制造', '工业', '材料', '电子', '自动化', '生产', '加工', '精密'],
            '零售/贸易': ['商贸', '贸易', '电商', '零售', '批发', '超市', '百货', '连锁', '进出口'],
            '教育培训': ['教育', '培训', '学院', '学校', '大学', '教学', '课程', '在线教育'],
            '金融': ['金融', '投资', '银行', '保险', '证券', '资本', '基金', '信托', '期货', '财富'],
            '医疗健康': ['医疗', '医药', '健康', '生物', '医院', '诊所', '制药', '护理', '康复'],
            '建筑/房产': ['建筑', '地产', '房产', '装饰', '工程', '设计院', '建设', '置业', '物业'],
            '服务业': ['服务', '咨询', '传媒', '广告', '设计', '文化', '娱乐', '旅游', '酒店', '餐饮']
        };

        // 行业到 CSS 类名映射
        const industryClassMap = {
            '科技/互联网': 'tag-industry-tech',
            '制造业': 'tag-industry-manufacture',
            '零售/贸易': 'tag-industry-retail',
            '教育培训': 'tag-industry-education',
            '金融': 'tag-industry-finance',
            '医疗健康': 'tag-industry-medical',
            '建筑/房产': 'tag-industry-construction',
            '服务业': 'tag-industry-service',
            '未知': 'tag-industry-unknown'
        };

        // 根据公司名关键词匹配行业
        function getIndustryByKeyword(companyName) {
            if (!companyName) return '未知';
            for (const [industry, keywords] of Object.entries(industryKeywords)) {
                for (const keyword of keywords) {
                    if (companyName.includes(keyword)) {
                        return industry;
                    }
                }
            }
            return '未知';
        }

        // 获取行业对应的 CSS 类名
        function getIndustryClass(industry) {
            return industryClassMap[industry] || 'tag-industry-unknown';
        }

        // 存储用户统计数据（供筛选使用）
        let userStatsCache = {};

        function renderUsers(filteredUsers = null) {
            const container = document.getElementById('usersList');
            const usersToRender = filteredUsers || allUsers;

            if (allUsers.length === 0) {
                container.innerHTML = '<p class="loading">暂无注册用户</p>';
                document.getElementById('filterCount').textContent = '显示 0 / 0 用户';
                return;
            }

            // 为每个用户统计会话数、消息数和最后聊天时间
            userStatsCache = {};
            allSessions.forEach(s => {
                const email = s.user_email || '未知';
                if (!userStatsCache[email]) {
                    userStatsCache[email] = { sessions: 0, messages: 0, lastChatTime: null };
                }
                userStatsCache[email].sessions++;
                userStatsCache[email].messages += (s.messages || []).length;
                // 记录最后聊天时间（取最新的 updated_at）
                const sessionTime = s.updated_at || s.created_at;
                if (sessionTime) {
                    if (!userStatsCache[email].lastChatTime || sessionTime > userStatsCache[email].lastChatTime) {
                        userStatsCache[email].lastChatTime = sessionTime;
                    }
                }
            });

            // 更新筛选计数
            document.getElementById('filterCount').textContent = `显示 ${usersToRender.length} / ${allUsers.length} 用户`;

            if (usersToRender.length === 0) {
                container.innerHTML = '<p class="loading">没有符合条件的用户</p>';
                return;
            }

            // 根据当前视图模式渲染
            switch(currentUserView) {
                case 'table':
                    renderUsersTable(usersToRender);
                    break;
                case 'compact':
                    renderUsersCompact(usersToRender);
                    break;
                default:
                    renderUsersCard(usersToRender);
            }
        }

        // 卡片视图渲染
        function renderUsersCard(users) {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map(user => {
                const email = user.email || '未知';
                const stats = userStatsCache[email] || { sessions: 0, messages: 0, lastChatTime: null };
                const credits = user.credits || 0;
                const creditsClass = credits < 20 ? 'tag-credits-low' : 'tag-credits';

                // 获取行业
                const industry = getIndustryByKeyword(user.company);
                const industryClass = getIndustryClass(industry);

                return `
                <div class="user-card" onclick="showUserDetail('${email}')" data-email="${email}" data-company="${user.company || ''}" data-industry="${industry}" data-credits="${credits}" data-sessions="${stats.sessions}">
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-email">${user.nickname || email}</div>
                            <div class="user-tags">
                                ${user.phone ? `<span class="tag tag-phone">📱 ${user.phone}</span>` : ''}
                                ${user.company ? `<span class="tag tag-company">🏢 ${user.company}</span>` : ''}
                                ${user.position ? `<span class="tag tag-position">👤 ${user.position}</span>` : ''}
                                <span class="tag ${industryClass}">🏭 ${industry}</span>
                                <span class="tag ${creditsClass}">💎 ${credits} 积分</span>
                                <span class="tag tag-sessions">💬 ${stats.sessions} 次对话</span>
                            </div>
                            <div class="user-meta">
                                注册时间: ${formatTime(user.created_at)}
                            </div>
                        </div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-num" style="color: ${credits < 20 ? '#f28b82' : '#81C995'};">${credits}</div>
                                <div class="user-stat-label">积分</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.sessions}</div>
                                <div class="user-stat-label">对话</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-num">${stats.messages}</div>
                                <div class="user-stat-label">消息</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-card-actions" style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button class="action-btn view" onclick="event.stopPropagation(); showUserChats('${email}')" title="查看聊天记录">查看聊天记录</button>
                        <button class="action-btn edit" onclick="event.stopPropagation(); showEditCreditsModal('${email}', ${credits})">修改积分</button>
                    </div>
                </div>
            `}).join('');
        }

        // 表格视图渲染
        function renderUsersTable(users) {
            const container = document.getElementById('usersList');

            // 排序用户
            const sortedUsers = sortUsersForTable(users);

            const getSortClass = (field) => {
                if (tableSortField !== field) return '';
                return `sorted ${tableSortDirection}`;
            };

            const sortIcon = `<span class="sort-icon">▲</span>`;

            container.innerHTML = `
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th class="${getSortClass('nickname')}" onclick="sortTableBy('nickname')">
                                    用户${sortIcon}
                                </th>
                                <th class="${getSortClass('industry')}" onclick="sortTableBy('industry')">
                                    行业${sortIcon}
                                </th>
                                <th class="${getSortClass('credits')}" onclick="sortTableBy('credits')">
                                    积分${sortIcon}
                                </th>
                                <th class="${getSortClass('sessions')}" onclick="sortTableBy('sessions')">
                                    对话数${sortIcon}
                                </th>
                                <th class="${getSortClass('messages')}" onclick="sortTableBy('messages')">
                                    消息数${sortIcon}
                                </th>
                                <th class="${getSortClass('created_at')}" onclick="sortTableBy('created_at')">
                                    注册时间${sortIcon}
                                </th>
                                <th class="${getSortClass('lastChatTime')}" onclick="sortTableBy('lastChatTime')">
                                    最后聊天${sortIcon}
                                </th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedUsers.map(user => {
                                const email = user.email || '未知';
                                const stats = userStatsCache[email] || { sessions: 0, messages: 0, lastChatTime: null };
                                const credits = user.credits || 0;
                                const industry = getIndustryByKeyword(user.company);
                                const industryClass = getIndustryClass(industry);
                                const creditsClass = credits === 0 ? 'zero' : (credits < 20 ? 'low' : '');
                                const displayName = user.nickname || email.split('@')[0];
                                const initial = displayName.charAt(0).toUpperCase();

                                return `
                                    <tr>
                                        <td>
                                            <div class="user-name-cell">
                                                <div class="user-avatar-small">${initial}</div>
                                                <div class="user-info">
                                                    <div class="name">${displayName}</div>
                                                    <div class="company">${user.company || '未填写公司'}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="tag-industry ${industryClass}">${industry}</span>
                                        </td>
                                        <td class="credits-cell ${creditsClass}">${credits}</td>
                                        <td>${stats.sessions}</td>
                                        <td>${stats.messages}</td>
                                        <td>${formatTime(user.created_at)}</td>
                                        <td>${stats.lastChatTime ? formatTime(stats.lastChatTime) : '-'}</td>
                                        <td>
                                            <div class="action-btns">
                                                <button class="action-btn view" onclick="event.stopPropagation(); showUserChats('${email}')" title="查看聊天记录">聊天</button>
                                                <button class="action-btn view" onclick="event.stopPropagation(); showUserDetail('${email}')">详情</button>
                                                <button class="action-btn edit" onclick="event.stopPropagation(); showEditCreditsModal('${email}', ${credits})">积分</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // 紧凑视图渲染
        function renderUsersCompact(users) {
            const container = document.getElementById('usersList');

            // 按注册时间排序（最新的在前）
            const sortedUsers = [...users].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            container.innerHTML = `
                <div class="users-compact-list">
                    ${sortedUsers.map(user => {
                        const email = user.email || '未知';
                        const stats = userStatsCache[email] || { sessions: 0, messages: 0, lastChatTime: null };
                        const credits = user.credits || 0;
                        const industry = getIndustryByKeyword(user.company);
                        const industryClass = getIndustryClass(industry);
                        const displayName = user.nickname || email.split('@')[0];
                        const initial = displayName.charAt(0).toUpperCase();

                        return `
                            <div class="user-compact-item" onclick="showUserDetail('${email}')">
                                <div class="avatar">${initial}</div>
                                <div class="info">
                                    <div class="name">${displayName}</div>
                                    <div class="company">${user.company || '未填写公司'}</div>
                                </div>
                                <span class="tag-industry ${industryClass}">${industry}</span>
                                <div class="stats">
                                    <div class="stat">
                                        <span>💎</span>
                                        <span class="stat-value" style="color: ${credits < 20 ? '#f28b82' : '#81C995'};">${credits}</span>
                                    </div>
                                    <div class="stat">
                                        <span>💬</span>
                                        <span class="stat-value">${stats.sessions}</span>
                                    </div>
                                    <div class="stat">
                                        <span>📝</span>
                                        <span class="stat-value">${stats.messages}</span>
                                    </div>
                                </div>
                                <button class="action-btn view" onclick="event.stopPropagation(); showUserChats('${email}')" title="查看聊天记录" style="margin-left: 12px; padding: 4px 10px; font-size: 12px;">聊天</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 切换用户视图
        function switchUserView(view) {
            currentUserView = view;

            // 更新按钮状态
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // 重新渲染
            filterUsers();
        }

        // 表格排序
        function sortTableBy(field) {
            if (tableSortField === field) {
                // 切换排序方向
                tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                tableSortField = field;
                tableSortDirection = 'desc'; // 默认降序
            }
            filterUsers();
        }

        // 排序用户数据
        function sortUsersForTable(users) {
            return [...users].sort((a, b) => {
                const emailA = a.email || '未知';
                const emailB = b.email || '未知';
                const statsA = userStatsCache[emailA] || { sessions: 0, messages: 0 };
                const statsB = userStatsCache[emailB] || { sessions: 0, messages: 0 };

                let valA, valB;

                switch(tableSortField) {
                    case 'nickname':
                        valA = (a.nickname || emailA).toLowerCase();
                        valB = (b.nickname || emailB).toLowerCase();
                        break;
                    case 'industry':
                        valA = getIndustryByKeyword(a.company);
                        valB = getIndustryByKeyword(b.company);
                        break;
                    case 'credits':
                        valA = a.credits || 0;
                        valB = b.credits || 0;
                        break;
                    case 'sessions':
                        valA = statsA.sessions;
                        valB = statsB.sessions;
                        break;
                    case 'messages':
                        valA = statsA.messages;
                        valB = statsB.messages;
                        break;
                    case 'lastChatTime':
                        valA = statsA.lastChatTime ? new Date(statsA.lastChatTime) : new Date(0);
                        valB = statsB.lastChatTime ? new Date(statsB.lastChatTime) : new Date(0);
                        break;
                    case 'created_at':
                    default:
                        valA = new Date(a.created_at);
                        valB = new Date(b.created_at);
                        break;
                }

                let compare = 0;
                if (valA < valB) compare = -1;
                else if (valA > valB) compare = 1;

                return tableSortDirection === 'asc' ? compare : -compare;
            });
        }

        // 筛选用户
        function filterUsers() {
            const searchText = document.getElementById('userSearchInput').value.toLowerCase().trim();
            const industryFilter = document.getElementById('industryFilter').value;
            const creditsFilter = document.getElementById('creditsFilter').value;
            const activityFilter = document.getElementById('activityFilter').value;

            const filtered = allUsers.filter(user => {
                const email = user.email || '';
                const nickname = user.nickname || '';
                const company = user.company || '';
                const phone = user.phone || '';
                const credits = user.credits || 0;
                const stats = userStatsCache[email] || { sessions: 0, messages: 0, lastChatTime: null };
                const industry = getIndustryByKeyword(company);

                // 搜索过滤
                if (searchText) {
                    const matchSearch = email.toLowerCase().includes(searchText) ||
                                       nickname.toLowerCase().includes(searchText) ||
                                       company.toLowerCase().includes(searchText) ||
                                       phone.includes(searchText);
                    if (!matchSearch) return false;
                }

                // 行业过滤
                if (industryFilter && industry !== industryFilter) {
                    return false;
                }

                // 积分过滤
                if (creditsFilter) {
                    switch (creditsFilter) {
                        case 'zero': if (credits !== 0) return false; break;
                        case 'low': if (credits <= 0 || credits >= 20) return false; break;
                        case 'normal': if (credits < 20 || credits > 50) return false; break;
                        case 'high': if (credits <= 50) return false; break;
                    }
                }

                // 活跃度过滤
                if (activityFilter) {
                    const sessions = stats.sessions;
                    switch (activityFilter) {
                        case 'inactive': if (sessions !== 0) return false; break;
                        case 'low': if (sessions < 1 || sessions > 2) return false; break;
                        case 'medium': if (sessions < 3 || sessions > 5) return false; break;
                        case 'high': if (sessions <= 5) return false; break;
                    }
                }

                return true;
            });

            renderUsers(filtered);
        }

        // 显示用户详情（该用户的所有对话）
        function showUserDetail(email) {
            currentUserEmail = email;

            // 找到用户信息
            const user = allUsers.find(u => u.email === email) || {};

            // 更新详情面板
            document.getElementById('detailUserEmail').textContent = user.nickname || email;
            document.getElementById('detailUserPhone').textContent = user.phone ? '📱 ' + user.phone : '';
            document.getElementById('detailUserCompany').textContent = user.company ? '🏢 ' + user.company : '';
            document.getElementById('detailUserPosition').textContent = user.position ? '👤 ' + user.position : '';
            document.getElementById('detailUserCredits').textContent = '💎 ' + (user.credits || 0) + ' 积分';

            // 过滤该用户的会话
            const userSessions = allSessions.filter(s => s.user_email === email);

            // 渲染该用户的会话
            const container = document.getElementById('userSessionsList');
            if (userSessions.length === 0) {
                container.innerHTML = '<p class="loading">该用户暂无对话记录</p>';
            } else {
                container.innerHTML = userSessions.map((s, idx) => `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user-info">
                                <span class="session-module">${s.module}</span>
                            </div>
                            <div>
                                <span class="session-time">${formatTime(s.updated_at)}</span>
                                <button class="btn-expand" onclick="toggleUserMessages(${idx})">
                                    ${(s.messages || []).length} 条消息 ▼
                                </button>
                            </div>
                        </div>
                        <div class="messages-list hidden" id="user-messages-${idx}">
                            ${(s.messages || []).map(m => `
                                <div class="msg-item msg-${m.role}">
                                    <div class="msg-role">${m.role === 'user' ? '用户' : 'AI'}</div>
                                    <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // 显示详情面板，隐藏所有列表
            document.getElementById('userDetailPanel').style.display = 'block';
            document.getElementById('usersList').style.display = 'none';
            document.getElementById('sessionsList').style.display = 'none';
        }

        // 从聊天记录列表点击用户邮箱查看详情
        function showUserDetailFromSession(email) {
            if (!email) return;

            // 显示用户详情
            showUserDetail(email);

            // 记录来源标签，用于返回时恢复
            sessionStorage.setItem('userDetailSource', 'sessions');
        }

        // 从用户列表跳转到聊天记录Tab，并筛选该用户
        function showUserChats(email) {
            if (!email) return;

            // 切换到聊天记录Tab
            switchTab('sessions');

            // 设置搜索框的值并触发搜索
            const searchInput = document.getElementById('sessionSearchInput');
            if (searchInput) {
                searchInput.value = email;
                handleSessionSearch();
            }
        }

        function hideUserDetail() {
            currentUserEmail = null;
            const source = sessionStorage.getItem('userDetailSource');

            // 隐藏详情面板
            document.getElementById('userDetailPanel').style.display = 'none';

            // 根据来源显示相应的列表
            if (source === 'sessions') {
                // 如果是从聊天记录tab来的，保持在聊天记录tab
                document.getElementById('sessionsList').style.display = 'block';
                document.getElementById('usersList').style.display = 'none';
            } else {
                // 否则显示用户列表
                document.getElementById('usersList').style.display = 'block';
                document.getElementById('sessionsList').style.display = 'none';
            }

            // 清除来源记录
            sessionStorage.removeItem('userDetailSource');
        }

        function toggleUserMessages(idx) {
            const el = document.getElementById('user-messages-' + idx);
            el.classList.toggle('hidden');
        }

        // 生成用户画像
        async function generateUserProfile() {
            if (!currentUserEmail) {
                alert('请先选择一个用户');
                return;
            }

            // 显示模态框和加载状态
            const modal = document.getElementById('userProfileModal');
            const content = document.getElementById('userProfileContent');
            document.getElementById('userProfileModalTitle').textContent = '🎯 用户画像分析';
            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>正在分析用户聊天记录，请稍候...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/admin/user-profile-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUserEmail
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayUserProfile(data.profile);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--text-secondary); font-size: 16px;">
                                ❌ ${data.error || '生成用户画像失败'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('生成用户画像失败:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary); font-size: 16px;">
                            ❌ 网络错误或服务器异常
                        </p>
                    </div>
                `;
            }
        }

        // 显示用户画像
        function displayUserProfile(profile) {
            const content = document.getElementById('userProfileContent');

            content.innerHTML = `
                <div class="profile-section">
                    <h3>📊 基本信息</h3>
                    <div class="profile-content">
                        <p><strong>用户邮箱：</strong>${escapeHtml(profile.email || '')}</p>
                        <p><strong>对话次数：</strong><span class="profile-stat">${profile.session_count || 0} 次</span></p>
                        <p><strong>消息总数：</strong><span class="profile-stat">${profile.message_count || 0} 条</span></p>
                        <p><strong>分析时间：</strong>${new Date(profile.analyzed_at).toLocaleString('zh-CN')}</p>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>🎯 用户画像总结</h3>
                    <div class="profile-content">
                        ${formatProfileText(profile.summary || '暂无总结')}
                    </div>
                </div>

                ${profile.topics && profile.topics.length > 0 ? `
                <div class="profile-section">
                    <h3>💡 主要关注话题</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.topics.map(topic => `<li>${escapeHtml(topic)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${profile.patterns && profile.patterns.length > 0 ? `
                <div class="profile-section">
                    <h3>📈 使用模式</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.patterns.map(pattern => `<li>${escapeHtml(pattern)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${profile.recommendations && profile.recommendations.length > 0 ? `
                <div class="profile-section">
                    <h3>💎 建议与洞察</h3>
                    <div class="profile-content">
                        <ul>
                            ${profile.recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // 格式化文本（支持换行）
        function formatProfileText(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // 隐藏用户画像模态框
        function hideUserProfileModal() {
            document.getElementById('userProfileModal').style.display = 'none';
        }

        // 生成用户洞察（需求摘要）
        async function generateUserInsight(forceRefresh = false) {
            if (!currentUserEmail) {
                alert('请先选择一个用户');
                return;
            }

            // 显示模态框和加载状态
            const modal = document.getElementById('userProfileModal');
            const content = document.getElementById('userProfileContent');
            document.getElementById('userProfileModalTitle').textContent = '🔍 用户洞察';
            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>${forceRefresh ? '正在重新分析...' : '正在分析用户需求洞察，请稍候...'}</p>
                </div>
            `;

            try {
                const response = await fetch('/api/admin/user-insight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUserEmail,
                        force_refresh: forceRefresh
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayInsightResult(data.result, '用户洞察', data.from_cache, 'generateUserInsight');
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--text-secondary); font-size: 16px;">
                                ❌ ${data.error || '生成用户洞察失败'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('生成用户洞察失败:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary); font-size: 16px;">
                            ❌ 网络错误或服务器异常
                        </p>
                    </div>
                `;
            }
        }

        // 生成工具分析（功能需求文档）
        async function generateToolAnalysis(forceRefresh = false) {
            if (!currentUserEmail) {
                alert('请先选择一个用户');
                return;
            }

            // 显示模态框和加载状态
            const modal = document.getElementById('userProfileModal');
            const content = document.getElementById('userProfileContent');
            document.getElementById('userProfileModalTitle').textContent = '🛠️ 工具分析';
            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>${forceRefresh ? '正在重新分析...' : '正在分析工具需求，请稍候...'}</p>
                </div>
            `;

            try {
                const response = await fetch('/api/admin/tool-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUserEmail,
                        force_refresh: forceRefresh
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayInsightResult(data.result, '工具分析', data.from_cache, 'generateToolAnalysis');
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--text-secondary); font-size: 16px;">
                                ❌ ${data.error || '生成工具分析失败'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('生成工具分析失败:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary); font-size: 16px;">
                            ❌ 网络错误或服务器异常
                        </p>
                    </div>
                `;
            }
        }

        // 显示洞察/分析结果（Markdown 格式）
        function displayInsightResult(result, title, fromCache = false, refreshFn = null) {
            const content = document.getElementById('userProfileContent');

            // 简单的 Markdown 到 HTML 转换
            let htmlContent = result
                // 先处理代码块
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // 处理标题
                .replace(/^### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^## (.*$)/gm, '<h3>$1</h3>')
                .replace(/^# (.*$)/gm, '<h2>$1</h2>')
                // 处理粗体
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // 处理表格
                .replace(/^\|(.+)\|$/gm, (match) => {
                    const cells = match.split('|').filter(c => c.trim());
                    return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                })
                // 处理无序列表
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // 处理有序列表
                .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
                // 处理引用
                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                // 处理换行
                .replace(/\n/g, '<br>');

            // 缓存标识
            const cacheIndicator = fromCache ? `
                <span style="
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    margin-left: 8px;
                ">⚡ 秒开缓存</span>
            ` : '';

            // 刷新按钮
            const refreshButton = refreshFn ? `
                <button onclick="${refreshFn}(true)" class="btn-refresh" style="
                    padding: 8px 16px;
                    background: var(--bg-card);
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    color: var(--text-secondary);
                    cursor: pointer;
                    margin-right: 8px;
                ">🔄 重新分析</button>
            ` : '';

            content.innerHTML = `
                <div class="profile-section">
                    <h3>📋 ${title}${cacheIndicator}</h3>
                    <div class="profile-content insight-result" style="white-space: pre-wrap; line-height: 1.8;">
                        ${htmlContent}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        ${refreshButton}
                        <button onclick="copyInsightResult()" class="btn-copy" style="
                            padding: 8px 16px;
                            background: var(--bg-card);
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            color: var(--text-secondary);
                            cursor: pointer;
                        ">📋 复制内容</button>
                    </div>
                </div>
            `;

            // 保存原始结果用于复制
            content.dataset.rawResult = result;
        }

        // 复制分析结果
        function copyInsightResult() {
            const content = document.getElementById('userProfileContent');
            const rawResult = content.dataset.rawResult || '';

            navigator.clipboard.writeText(rawResult).then(() => {
                const btn = document.querySelector('.btn-copy');
                btn.textContent = '✅ 已复制';
                setTimeout(() => {
                    btn.textContent = '📋 复制内容';
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        // ========================================
        // 用户调研记录功能
        // ========================================

        let researchCategories = [];

        function showResearchNotesModal() {
            if (!currentUserEmail) {
                alert('请先选择一个用户');
                return;
            }
            document.getElementById('researchNotesModal').style.display = 'flex';
            loadResearchNotes();
        }

        function hideResearchNotesModal() {
            document.getElementById('researchNotesModal').style.display = 'none';
            hideAddResearchForm();
        }

        function showAddResearchForm() {
            document.getElementById('addResearchForm').style.display = 'block';
        }

        function hideAddResearchForm() {
            document.getElementById('addResearchForm').style.display = 'none';
            // 重置表单
            document.getElementById('researchCategory').value = 'phone_call';
            document.getElementById('researchContent').value = '';
            document.getElementById('researchNotes').value = '';
            document.getElementById('researchFileUpload').value = '';
            document.getElementById('researchFilePreview').style.display = 'none';
        }

        function previewResearchFile() {
            const file = document.getElementById('researchFileUpload').files[0];
            if (file) {
                const preview = document.getElementById('researchFilePreview');
                preview.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                        <span style="font-size: 20px;">${getFileIcon(file.name)}</span>
                        <span style="color: var(--text-primary);">${file.name}</span>
                        <span style="color: var(--text-muted); font-size: 12px;">(${formatFileSize(file.size)})</span>
                        <button onclick="clearResearchFile(event)" style="margin-left: auto; background: none; border: none; color: var(--accent-red); cursor: pointer;">✕</button>
                    </div>
                `;
                preview.style.display = 'block';
            }
        }

        function clearResearchFile(e) {
            e.stopPropagation();
            document.getElementById('researchFileUpload').value = '';
            document.getElementById('researchFilePreview').style.display = 'none';
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = { 'pdf': '📄', 'doc': '📝', 'docx': '📝', 'txt': '📃' };
            return icons[ext] || '📎';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function submitResearchNote() {
            const category = document.getElementById('researchCategory').value;
            const content = document.getElementById('researchContent').value.trim();
            const notes = document.getElementById('researchNotes').value.trim();
            const file = document.getElementById('researchFileUpload').files[0];

            if (!content && !file) {
                alert('请输入调研内容或上传文件');
                return;
            }

            try {
                let response;

                if (file) {
                    // 上传文件
                    const formData = new FormData();
                    formData.append('user_email', currentUserEmail);
                    formData.append('category', category);
                    formData.append('notes', notes);
                    formData.append('file', file);
                    if (content) formData.append('content', content);

                    response = await fetch('/api/admin/research-notes/upload', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // 纯文字
                    response = await fetch('/api/admin/research-notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_email: currentUserEmail,
                            category: category,
                            content: content,
                            notes: notes
                        })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    hideAddResearchForm();
                    loadResearchNotes();
                } else {
                    alert('保存失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('保存调研记录失败:', error);
                alert('保存失败，请重试');
            }
        }

        async function loadResearchNotes() {
            const timeline = document.getElementById('researchTimeline');
            timeline.innerHTML = '<p style="text-align: center; color: var(--text-muted);">加载中...</p>';

            try {
                const response = await fetch(`/api/admin/research-notes/${encodeURIComponent(currentUserEmail)}`);
                const data = await response.json();

                if (!data.success || !data.notes || !data.notes.length) {
                    timeline.innerHTML = `
                        <div class="research-empty">
                            <div class="research-empty-icon">📋</div>
                            <p>暂无调研记录</p>
                            <p style="font-size: 13px;">点击上方「添加调研记录」按钮开始记录</p>
                        </div>
                    `;
                    return;
                }

                researchCategories = data.categories || [];
                const categoryMap = {};
                researchCategories.forEach(c => categoryMap[c.id] = c);

                timeline.innerHTML = data.notes.map(note => {
                    const cat = categoryMap[note.category] || { icon: '📎', name: note.category };
                    const date = new Date(note.created_at).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let contentHtml = '';
                    if (note.content) {
                        contentHtml = `<div class="timeline-content">${escapeHtml(note.content)}</div>`;
                    }

                    let fileHtml = '';
                    if (note.file_name) {
                        const fileUrl = note.file_url || '#';
                        fileHtml = `
                            <div class="timeline-file">
                                <span class="timeline-file-icon">${getFileIcon(note.file_name)}</span>
                                <a href="${fileUrl}" target="_blank" class="timeline-file-name">${note.file_name}</a>
                            </div>
                        `;
                    }

                    let notesHtml = '';
                    if (note.notes) {
                        notesHtml = `<div class="timeline-notes">📌 ${escapeHtml(note.notes)}</div>`;
                    }

                    return `
                        <div class="timeline-item" data-id="${note.id}">
                            <div class="timeline-header">
                                <span class="timeline-category">${cat.icon} ${cat.name}</span>
                                <span class="timeline-date">${date}</span>
                            </div>
                            ${contentHtml}
                            ${fileHtml}
                            ${notesHtml}
                            <div class="timeline-actions">
                                <button class="btn-delete-research" onclick="deleteResearchNote('${note.id}')">删除</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('加载调研记录失败:', error);
                timeline.innerHTML = '<p style="text-align: center; color: var(--accent-red);">加载失败，请重试</p>';
            }
        }

        async function deleteResearchNote(noteId) {
            if (!confirm('确定删除这条调研记录吗？')) return;

            try {
                const response = await fetch(`/api/admin/research-notes/${noteId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    loadResearchNotes();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除调研记录失败:', error);
                alert('删除失败，请重试');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 导出单个用户的所有对话
        function exportUserSessions() {
            if (!currentUserEmail) return;

            const user = allUsers.find(u => u.email === currentUserEmail) || {};
            const userSessions = allSessions.filter(s => s.user_email === currentUserEmail);

            const exportData = {
                user: {
                    email: currentUserEmail,
                    company: user.company || '',
                    position: user.position || '',
                    credits: user.credits || 0,
                    created_at: user.created_at
                },
                sessions: userSessions.map(s => ({
                    session_id: s.session_id || s.id,
                    module: s.module,
                    created_at: s.created_at,
                    messages: s.messages
                })),
                exported_at: new Date().toISOString()
            };

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `user_${currentUserEmail.split('@')[0]}_${timestamp}.json`;

            downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
        }

        // 存储过滤后的会话（用于搜索和导出）
        let filteredSessions = [];
        let currentSearchKeyword = '';

        // 搜索处理函数
        function handleSessionSearch() {
            const input = document.getElementById('sessionSearchInput');
            const keyword = input.value.trim().toLowerCase();
            currentSearchKeyword = keyword;

            // 显示/隐藏清除按钮
            document.getElementById('searchClearBtn').style.display = keyword ? 'flex' : 'none';

            // 过滤会话
            if (!keyword) {
                filteredSessions = [...allSessions];
            } else {
                filteredSessions = allSessions.filter(s => {
                    // 搜索用户邮箱
                    if ((s.user_email || '').toLowerCase().includes(keyword)) return true;
                    // 搜索公司名称
                    if ((s.user_company || '').toLowerCase().includes(keyword)) return true;
                    // 搜索职位
                    if ((s.user_position || '').toLowerCase().includes(keyword)) return true;
                    // 搜索模块名称
                    if ((s.module || '').toLowerCase().includes(keyword)) return true;
                    // 搜索消息内容
                    const messages = s.messages || [];
                    for (const m of messages) {
                        if ((m.content || '').toLowerCase().includes(keyword)) return true;
                    }
                    return false;
                });
            }

            // 更新搜索结果计数
            updateSearchResultCount();
            // 重新渲染
            renderSessions();
        }

        // 更新搜索结果计数
        function updateSearchResultCount() {
            const countEl = document.getElementById('searchResultCount');
            if (!currentSearchKeyword) {
                countEl.textContent = '';
                countEl.classList.remove('has-results');
            } else {
                countEl.textContent = `找到 ${filteredSessions.length} 条记录`;
                countEl.classList.toggle('has-results', filteredSessions.length > 0);
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('sessionSearchInput').value = '';
            currentSearchKeyword = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            filteredSessions = [...allSessions];
            updateSearchResultCount();
            renderSessions();
        }

        // 渲染会话列表
        function renderSessions() {
            const container = document.getElementById('sessionsList');

            // 如果还没有初始化 filteredSessions，使用 allSessions
            if (filteredSessions.length === 0 && allSessions.length > 0 && !currentSearchKeyword) {
                filteredSessions = [...allSessions];
            }

            const sessionsToRender = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToRender.length === 0) {
                container.innerHTML = currentSearchKeyword
                    ? '<p class="loading">未找到匹配的聊天记录</p>'
                    : '<p class="loading">暂无聊天记录</p>';
                return;
            }

            container.innerHTML = sessionsToRender.map((s, idx) => `
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-user-info">
                            <span class="session-user clickable-user" onclick="showUserDetailFromSession('${s.user_email || ''}')" title="点击查看该用户的所有聊天记录">${s.user_email || '未知用户'}</span>
                            ${s.user_company ? `<span class="session-company">🏢 ${s.user_company}</span>` : ''}
                            ${s.user_position ? `<span class="session-position">👤 ${s.user_position}</span>` : ''}
                            <span class="session-module">${s.module}</span>
                        </div>
                        <div>
                            <span class="session-time">${formatTime(s.updated_at)}</span>
                            <button class="btn-expand" onclick="toggleMessages(${idx})">
                                ${(s.messages || []).length} 条消息 ▼
                            </button>
                        </div>
                    </div>
                    <div class="messages-list hidden" id="messages-${idx}">
                        ${(s.messages || []).map(m => `
                            <div class="msg-item msg-${m.role}">
                                <div class="msg-role">${m.role === 'user' ? '用户' : 'AI'}</div>
                                <div>${escapeHtml(m.content).substring(0, 500)}${m.content.length > 500 ? '...' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 展开/收起消息
        function toggleMessages(idx) {
            const el = document.getElementById('messages-' + idx);
            el.classList.toggle('hidden');
        }

        // 切换标签
        function switchTab(tab) {
            // 更新侧边栏导航高亮
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => item.classList.remove('active'));
            const targetItem = document.querySelector(`.sidebar-nav .nav-item[data-tab="${tab}"]`);
            if (targetItem) targetItem.classList.add('active');

            // 更新页面标题
            const titles = {
                'users': { title: '用户列表', subtitle: '管理所有注册用户' },
                'sessions': { title: '聊天记录', subtitle: '查看所有对话历史' },
                'prompts': { title: '提示词管理', subtitle: '配置AI模块提示词' },
                'redeem': { title: '兑换码管理', subtitle: '生成和管理兑换码' },
                'admins': { title: '管理员管理', subtitle: '添加和管理管理员账号' },
                'buttons': { title: '按钮配置', subtitle: '配置用户分析按钮的名称和提示词' },
                'logs': { title: '操作日志', subtitle: '查看系统操作记录' },
                'versions': { title: '版本历史', subtitle: '查看系统更新记录' }
            };
            if (titles[tab]) {
                document.getElementById('pageTitle').textContent = titles[tab].title;
                document.getElementById('pageSubtitle').textContent = titles[tab].subtitle;
            }

            // 切换内容面板
            document.getElementById('usersTab').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sessionsTab').classList.toggle('hidden', tab !== 'sessions');
            document.getElementById('promptsTab').classList.toggle('hidden', tab !== 'prompts');
            document.getElementById('redeemTab').classList.toggle('hidden', tab !== 'redeem');
            document.getElementById('adminsTab').classList.toggle('hidden', tab !== 'admins');
            document.getElementById('buttonsTab').classList.toggle('hidden', tab !== 'buttons');
            document.getElementById('logsTab').classList.toggle('hidden', tab !== 'logs');
            document.getElementById('versionsTab').classList.toggle('hidden', tab !== 'versions');
            document.getElementById('userDetailPanel').style.display = 'none';

            // 显示/隐藏导出按钮
            document.getElementById('exportBar').style.display = tab === 'sessions' ? 'flex' : 'none';

            // 切换到用户列表时，重置列表显示状态（修复从详情页直接切换标签后列表不显示的问题）
            if (tab === 'users') {
                document.getElementById('usersList').style.display = 'block';
                document.getElementById('sessionsList').style.display = 'none';
            }
            // 切换到聊天记录时，重置列表显示状态
            if (tab === 'sessions') {
                document.getElementById('sessionsList').style.display = 'block';
                document.getElementById('usersList').style.display = 'none';
            }

            // 显示/隐藏统计卡片
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.style.display = (tab === 'users' || tab === 'sessions') ? 'grid' : 'none';
            }

            // 切换到提示词管理时加载模块
            if (tab === 'prompts') {
                loadModules();
            }
            // 切换到兑换码管理时加载兑换码列表
            if (tab === 'redeem') {
                loadRedeemCodes();
            }
            // 切换到日志标签时加载日志
            if (tab === 'logs') {
                loadAdminLogs('all');
            }
            // 切换到管理员管理时加载管理员列表
            if (tab === 'admins') {
                loadAdminUsers();
            }
            // 切换到按钮配置时加载配置
            if (tab === 'buttons') {
                loadButtonConfigs();
            }
            // 切换到版本历史时渲染版本
            if (tab === 'versions') {
                renderVersionHistory();
            }
        }

        // 导出聊天记录（包含完整用户信息）
        function exportChat(type, format) {
            // 使用搜索结果或全部数据
            const sessionsToExport = currentSearchKeyword ? filteredSessions : allSessions;

            if (sessionsToExport.length === 0) {
                alert(currentSearchKeyword ? '搜索结果为空，无数据可导出' : '暂无数据可导出');
                return;
            }

            // 构建用户信息映射
            const userMap = {};
            allUsers.forEach(u => {
                userMap[u.email] = u;
            });

            let exportData;
            const timestamp = new Date().toISOString().slice(0, 10);
            // 文件名添加搜索标识
            const searchSuffix = currentSearchKeyword ? `_search_${currentSearchKeyword.substring(0, 20)}` : '';

            if (type === 'user') {
                // 只导出用户输入
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || '未知',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        user_messages: (s.messages || []).filter(m => m.role === 'user').map(m => m.content)
                    };
                });
            } else {
                // 导出全部对话
                exportData = sessionsToExport.map(s => {
                    const user = userMap[s.user_email] || {};
                    return {
                        session_id: s.session_id || s.id,
                        user_email: s.user_email || '未知',
                        user_company: user.company || s.user_company || '',
                        user_position: user.position || s.user_position || '',
                        module: s.module,
                        created_at: s.created_at,
                        messages: s.messages
                    };
                });
            }

            if (format === 'json') {
                downloadFile(
                    JSON.stringify(exportData, null, 2),
                    `chat_${type}${searchSuffix}_${timestamp}.json`,
                    'application/json'
                );
            } else {
                // CSV 格式
                const csvContent = convertToCSV(exportData, type);
                downloadFile(csvContent, `chat_${type}${searchSuffix}_${timestamp}.csv`, 'text/csv');
            }
        }

        // 转换为 CSV
        function convertToCSV(data, type) {
            let rows = [];

            if (type === 'user') {
                rows.push(['会话ID', '用户邮箱', '公司名称', '职位', '模块', '时间', '用户输入']);
                data.forEach(s => {
                    (s.user_messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            } else {
                rows.push(['会话ID', '用户邮箱', '公司名称', '职位', '模块', '时间', '角色', '内容']);
                data.forEach(s => {
                    (s.messages || []).forEach(msg => {
                        rows.push([
                            s.session_id,
                            s.user_email,
                            s.user_company,
                            s.user_position,
                            s.module,
                            s.created_at,
                            msg.role === 'user' ? '用户' : 'AI',
                            msg.content.replace(/"/g, '""').replace(/\n/g, ' ')
                        ]);
                    });
                });
            }

            return rows.map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
        }

        // 下载文件
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 格式化时间（直接解析字符串，避免时区转换问题）
        function formatTime(str) {
            if (!str) return '-';
            // 格式: 2026-01-15T09:47:00 或 2026-01-15T09:47:00.123456
            const match = str.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
            if (!match) {
                // 兜底：用 Date 解析
                const d = new Date(str);
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            }
            const [, year, month, day, hour, minute] = match;
            return `${parseInt(month)}/${parseInt(day)} ${hour}:${minute}`;
        }

        // HTML 转义
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ========================================
        // 提示词管理功能
        // ========================================

        let allModules = [];
        let currentModuleId = null;

        // 加载模块列表
        async function loadModules() {
            try {
                const res = await fetch('/api/admin/modules');
                const data = await res.json();

                if (data.success) {
                    allModules = data.modules || [];
                    renderModuleList();
                }
            } catch (e) {
                console.error('加载模块失败', e);
            }
        }

        // 渲染模块列表
        function renderModuleList() {
            const container = document.getElementById('moduleListItems');

            if (allModules.length === 0) {
                container.innerHTML = '<p class="loading">暂无模块</p>';
                return;
            }

            container.innerHTML = allModules.map(m => `
                <div class="module-item ${currentModuleId === m.id ? 'active' : ''}"
                     onclick="selectModule('${m.id}')">
                    <div class="module-icon" style="background: ${m.color}20; color: ${m.color};">
                        ${m.icon || '📋'}
                    </div>
                    <div class="module-item-info">
                        <div class="module-item-name">${m.name}</div>
                        <div class="module-item-desc">${m.description || ''}</div>
                    </div>
                    <button class="btn-delete-module" onclick="event.stopPropagation(); deleteModule('${m.id}', '${m.name}')" title="删除模块">×</button>
                </div>
            `).join('');
        }

        // 删除模块
        async function deleteModule(moduleId, moduleName) {
            if (!confirm(`确定要删除模块「${moduleName}」吗？\n\n删除后首页将不再显示该模块。`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/modules/${moduleId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    alert('模块已删除');
                    // 如果删除的是当前选中的模块，清除选择
                    if (currentModuleId === moduleId) {
                        currentModuleId = null;
                        document.getElementById('promptEditor').style.display = 'none';
                        document.getElementById('promptPlaceholder').style.display = 'block';
                    }
                    // 重新加载模块列表
                    await loadModules();
                } else {
                    alert('删除失败: ' + (data.message || data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // 选择模块
        async function selectModule(moduleId) {
            currentModuleId = moduleId;
            const module = allModules.find(m => m.id === moduleId);

            if (!module) return;

            // 更新UI
            document.getElementById('promptEditor').style.display = 'block';
            document.getElementById('promptPlaceholder').style.display = 'none';
            document.getElementById('currentModuleIcon').textContent = module.icon || '📋';
            document.getElementById('currentModuleName').value = module.name;
            document.getElementById('promptSaveStatus').textContent = '';

            // 更新模块列表高亮
            renderModuleList();

            // 加载提示词
            await loadPrompt(moduleId);

            // 加载欢迎配置
            await loadWelcomeConfig(moduleId);

            // 加载知识库
            await loadKnowledge(moduleId);
        }

        // 加载提示词
        async function loadPrompt(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/prompt`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('promptTextarea').value = data.prompt || '';
                }
            } catch (e) {
                console.error('加载提示词失败', e);
            }
        }

        // 加载欢迎配置
        async function loadWelcomeConfig(moduleId) {
            try {
                const module = allModules.find(m => m.id === moduleId);
                if (module) {
                    document.getElementById('welcomeTextarea').value = module.welcome_message || '';
                    document.getElementById('inputGuideTextarea').value = module.input_guide || '';
                }
            } catch (e) {
                console.error('加载欢迎配置失败', e);
            }
        }

        // 保存欢迎配置
        async function saveWelcomeConfig() {
            if (!currentModuleId) return;

            const welcomeMessage = document.getElementById('welcomeTextarea').value;
            const inputGuide = document.getElementById('inputGuideTextarea').value;
            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = '保存中...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        welcome_message: welcomeMessage,
                        input_guide: inputGuide
                    })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 欢迎配置保存成功';
                    statusEl.style.color = '#10b981';
                    // 更新本地缓存
                    const moduleIndex = allModules.findIndex(m => m.id === currentModuleId);
                    if (moduleIndex !== -1) {
                        allModules[moduleIndex].welcome_message = welcomeMessage;
                        allModules[moduleIndex].input_guide = inputGuide;
                    }
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + (data.error || '未知错误');
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // 保存提示词
        async function savePrompt() {
            if (!currentModuleId) return;

            const prompt = document.getElementById('promptTextarea').value;
            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = '保存中...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 保存成功';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + (data.message || data.error || '未知错误');
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // 保存模块名称
        async function saveModuleName() {
            if (!currentModuleId) return;

            const nameInput = document.getElementById('currentModuleName');
            const newName = nameInput.value.trim();
            const statusEl = document.getElementById('promptSaveStatus');

            if (!newName) {
                // 如果名称为空，恢复原名称
                const module = allModules.find(m => m.id === currentModuleId);
                if (module) {
                    nameInput.value = module.name;
                }
                return;
            }

            // 检查名称是否改变
            const module = allModules.find(m => m.id === currentModuleId);
            if (module && module.name === newName) {
                return; // 名称未变，不需要保存
            }

            try {
                statusEl.textContent = '保存模块名称...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 模块名称已保存';
                    statusEl.style.color = '#10b981';
                    // 更新本地数据并重新渲染列表
                    if (module) {
                        module.name = newName;
                    }
                    renderModuleList();
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + (data.message || data.error || '未知错误');
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // ========================================
        // 图标选择器功能
        // ========================================

        // 可选图标列表
        const availableIcons = [
            // 业务相关
            '📊', '📈', '📉', '💰', '💵', '💎',
            '🎯', '🏆', '⭐', '🌟', '✨', '🔥',
            // 人员相关
            '👥', '👤', '🧑‍💼', '👨‍💼', '👩‍💼', '🤝',
            // 工具相关
            '📝', '📋', '✏️', '📌', '🔧', '⚙️',
            // 分析相关
            '🔍', '💡', '🧠', '📐', '🗂️', '📁',
            // 电商相关
            '🛒', '🛍️', '📦', '🚀', '💼', '🏪',
            // 策略相关
            '🎓', '🎖️', '🏅', '📣', '💬', '🗣️',
            // 其他常用
            '❤️', '💜', '💙', '💚', '🧡', '💛'
        ];

        // 显示图标选择器
        function showIconPicker() {
            const dropdown = document.getElementById('iconPickerDropdown');
            const grid = document.getElementById('iconPickerGrid');
            const currentIcon = document.getElementById('currentModuleIcon').textContent;

            // 生成图标选项
            grid.innerHTML = availableIcons.map(icon => `
                <div class="icon-picker-option ${icon === currentIcon ? 'selected' : ''}"
                     onclick="selectModuleIcon('${icon}')">
                    ${icon}
                </div>
            `).join('');

            // 显示下拉菜单
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';

            // 点击外部关闭
            if (dropdown.style.display === 'block') {
                setTimeout(() => {
                    document.addEventListener('click', closeIconPickerOnClickOutside);
                }, 10);
            }
        }

        // 点击外部关闭图标选择器
        function closeIconPickerOnClickOutside(e) {
            const wrapper = document.querySelector('.icon-editor-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('iconPickerDropdown').style.display = 'none';
                document.removeEventListener('click', closeIconPickerOnClickOutside);
            }
        }

        // 选择模块图标
        async function selectModuleIcon(icon) {
            if (!currentModuleId) return;

            // 更新 UI
            document.getElementById('currentModuleIcon').textContent = icon;
            document.getElementById('iconPickerDropdown').style.display = 'none';
            document.removeEventListener('click', closeIconPickerOnClickOutside);

            const statusEl = document.getElementById('promptSaveStatus');

            try {
                statusEl.textContent = '保存图标...';
                statusEl.style.color = '#6b7280';

                const res = await fetch(`/api/admin/modules/${currentModuleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ icon })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = '✓ 图标已保存';
                    statusEl.style.color = '#10b981';
                    // 更新本地数据并重新渲染列表
                    const module = allModules.find(m => m.id === currentModuleId);
                    if (module) {
                        module.icon = icon;
                    }
                    renderModuleList();
                } else {
                    statusEl.textContent = '✗ 保存失败: ' + (data.message || data.error || '未知错误');
                    statusEl.style.color = '#ef4444';
                }
            } catch (e) {
                statusEl.textContent = '✗ 网络错误';
                statusEl.style.color = '#ef4444';
            }
        }

        // 切换提示词/欢迎引导/知识库标签
        function switchPromptTab(tab) {
            document.querySelectorAll('.prompt-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('promptContent').style.display = tab === 'prompt' ? 'block' : 'none';
            document.getElementById('welcomeContent').style.display = tab === 'welcome' ? 'block' : 'none';
            document.getElementById('knowledgeContent').style.display = tab === 'knowledge' ? 'block' : 'none';
        }

        // 加载知识库文件
        async function loadKnowledge(moduleId) {
            try {
                const res = await fetch(`/api/admin/modules/${moduleId}/knowledge`);
                const data = await res.json();

                const container = document.getElementById('knowledgeList');

                if (data.success && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = getFileIcon(f.file_type);
                        return `
                            <div class="knowledge-item">
                                <div class="knowledge-item-info">
                                    <span class="knowledge-icon">${icon}</span>
                                    <div>
                                        <div class="knowledge-name">${f.filename}</div>
                                        <div class="knowledge-meta">${formatTime(f.created_at)}</div>
                                    </div>
                                </div>
                                <button class="btn-delete-knowledge" onclick="deleteKnowledge('${f.id}')">删除</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="loading">暂无知识库文件</p>';
                }
            } catch (e) {
                console.error('加载知识库失败', e);
            }
        }

        // 获取文件图标
        function getFileIcon(type) {
            const icons = {
                'txt': '📄',
                'md': '📝',
                'pdf': '📕',
                'docx': '📘'
            };
            return icons[type] || '📄';
        }

        // 上传知识库文件
        async function uploadKnowledge() {
            if (!currentModuleId) {
                alert('请先选择模块');
                return;
            }

            const input = document.getElementById('knowledgeUpload');
            const file = input.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/admin/modules/${currentModuleId}/knowledge`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert('上传成功');
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('上传失败: ' + (data.message || data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }

            // 清空文件选择
            input.value = '';
        }

        // 删除知识库文件
        async function deleteKnowledge(fileId) {
            if (!confirm('确定要删除这个文件吗？')) return;

            try {
                const res = await fetch(`/api/admin/knowledge/${fileId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    await loadKnowledge(currentModuleId);
                } else {
                    alert('删除失败: ' + (data.message || data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // 显示新增模块弹窗
        function showAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'flex';
        }

        // 隐藏新增模块弹窗
        function hideAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            // 清空表单
            document.getElementById('newModuleId').value = '';
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleDesc').value = '';
            document.getElementById('newModuleSubtitle').value = '';
            document.getElementById('newModuleIcon').value = '📊';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
        }

        // 选择 Emoji
        function selectEmoji(emoji) {
            document.getElementById('newModuleIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === emoji);
            });
        }

        // 创建新模块
        async function createModule() {
            const id = document.getElementById('newModuleId').value.trim();
            const name = document.getElementById('newModuleName').value.trim();
            const description = document.getElementById('newModuleDesc').value.trim();
            const subtitle = document.getElementById('newModuleSubtitle').value.trim();
            const icon = document.getElementById('newModuleIcon').value;
            const color = document.getElementById('newModuleColor').value;

            if (!id || !name) {
                alert('请填写模块ID和名称');
                return;
            }

            // 验证 ID 格式（只允许英文、数字、下划线）
            if (!/^[a-z][a-z0-9_]*$/.test(id)) {
                alert('模块ID只能包含小写字母、数字和下划线，且以字母开头');
                return;
            }

            try {
                const res = await fetch('/api/admin/modules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        name,
                        description,
                        subtitle,
                        icon,
                        color,
                        prompt: `## ${name}模块\n\n请在此输入该模块的系统提示词...`
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('模块创建成功！');
                    hideAddModuleModal();
                    await loadModules();
                    // 自动选中新模块
                    selectModule(id);
                } else {
                    const errorMsg = data.message || data.error || '未知错误';
                    alert('创建失败: ' + errorMsg);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 兑换码管理功能
        // ========================================

        let allRedeemCodes = [];

        async function loadRedeemCodes() {
            try {
                const res = await fetch('/api/admin/redeem/codes');
                const data = await res.json();
                if (data.success) {
                    allRedeemCodes = data.codes;
                    renderRedeemCodes();
                }
            } catch (e) {
                console.error('加载兑换码失败:', e);
            }
        }

        function renderRedeemCodes() {
            const container = document.getElementById('redeemCodesList');
            if (allRedeemCodes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无兑换码</p>';
                return;
            }

            container.innerHTML = allRedeemCodes.map(code => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value">${code.code}</div>
                        <div class="redeem-code-meta">
                            目标: ${code.target_name} |
                            ${code.cat_coins ? code.cat_coins + '猫币 → ' : ''}${code.credits} 积分 |
                            创建: ${code.created_by} | ${formatTime(code.created_at)}
                            ${code.note ? ' | ' + code.note : ''}
                        </div>
                    </div>
                    <span class="redeem-code-status ${code.is_used ? 'status-used' : 'status-unused'}">
                        ${code.is_used ? '已使用' : '未使用'}
                    </span>
                    <button class="btn-delete-code" onclick="deleteRedeemCode('${code.id}')" ${code.is_used ? 'disabled' : ''}>
                        删除
                    </button>
                </div>
            `).join('');
        }

        // 计算猫币兑换积分
        function calculateCreditsFromCatCoins(catCoins) {
            if (catCoins <= 0) return 0;
            // 每个猫币 = 20积分
            return catCoins * 20;
        }

        // 更新兑换预览
        function updateRedeemPreview() {
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const preview = document.getElementById('redeemPreview');
            if (catCoins > 0) {
                const credits = calculateCreditsFromCatCoins(catCoins);
                preview.innerHTML = `<strong>${catCoins} 个猫币 = ${credits} 积分</strong>（约 ${Math.floor(credits / 2)} 次回答机会）`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // 切换用户类型
        function toggleRedeemType() {
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const businessSchoolInfo = document.getElementById('businessSchoolInfo');
            const catCoinsInputGroup = document.getElementById('catCoinsInputGroup');
            const typeBusinessSchoolLabel = document.getElementById('typeBusinessSchoolLabel');
            const typeCatCoinsLabel = document.getElementById('typeCatCoinsLabel');

            if (userType === 'business_school') {
                businessSchoolInfo.style.display = 'block';
                catCoinsInputGroup.style.display = 'none';
                typeBusinessSchoolLabel.style.borderColor = '#444746';
                typeCatCoinsLabel.style.borderColor = 'transparent';
            } else {
                businessSchoolInfo.style.display = 'none';
                catCoinsInputGroup.style.display = 'block';
                typeBusinessSchoolLabel.style.borderColor = 'transparent';
                typeCatCoinsLabel.style.borderColor = '#444746';
            }
        }

        // ========================================
        // 手机号直接充值
        // ========================================

        function updateDirectRechargePreview() {
            const credits = parseInt(document.getElementById('directRechargeCredits').value) || 0;
            const hint = document.getElementById('directRechargeHint');

            if (credits > 0) {
                const answers = Math.floor(credits / 2);
                hint.innerHTML = `💡 ${credits} 积分 ≈ ${answers} 次回答机会`;
            } else {
                hint.innerHTML = '💡 提示：2积分 ≈ 1次回答机会';
            }
        }

        async function directRechargeCredits() {
            const phone = document.getElementById('directRechargePhone').value.trim();
            const credits = parseInt(document.getElementById('directRechargeCredits').value) || 0;
            const reason = document.getElementById('directRechargeReason').value.trim() || '管理员手动充值';

            if (!phone || phone.length < 11) {
                alert('请输入正确的11位手机号');
                return;
            }

            if (credits <= 0) {
                alert('请输入充值积分数量');
                return;
            }

            // 简单确认
            if (!confirm(`确认为手机号 ${phone} 充值 ${credits} 积分？`)) {
                return;
            }

            try {
                const res = await fetch('/api/admin/credits/add-by-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, credits, reason })
                });
                const data = await res.json();

                if (data.success) {
                    // 显示成功
                    const resultTextEl = document.getElementById('directRechargeResultText');
                    if (data.data.user && data.data.user.nickname) {
                        // 用户已注册，直接充值成功
                        resultTextEl.innerHTML = `为「${data.data.user.nickname}」充值 ${credits} 积分，当前余额 ${data.data.new_balance}`;
                    } else {
                        // 用户未注册，预充值成功
                        resultTextEl.innerHTML = `已为手机号 <strong>${phone}</strong> 预充值 <strong>${credits}</strong> 积分<br><span style="color: var(--text-muted); font-size: 12px;">用户注册时将自动到账</span>`;
                    }
                    document.getElementById('directRechargeResult').style.display = 'block';

                    // 清空输入
                    document.getElementById('directRechargePhone').value = '';
                    document.getElementById('directRechargeCredits').value = '';
                    document.getElementById('directRechargeReason').value = '';
                    updateDirectRechargePreview();
                } else {
                    alert('充值失败: ' + data.error);
                }
            } catch (e) {
                console.error('Recharge failed:', e);
                alert('网络错误');
            }
        }

        // ========================================
        // 批量手机号充值
        // ========================================

        // 存储解析后的手机号
        let parsedPhones = [];

        function parseBatchPhones() {
            const input = document.getElementById('batchPhonesInput').value;

            // 智能分隔：先按换行，再按逗号，再按空格
            let phones = input
                .split(/[\n,\s]+/)
                .map(p => p.trim())
                .filter(p => p.length === 11 && /^1\d{10}$/.test(p));

            // 去重
            phones = [...new Set(phones)];
            parsedPhones = phones;

            updateBatchPhonesSummary();
        }

        function updateBatchPhonesSummary() {
            const summaryEl = document.getElementById('batchPhonesSummary');
            const countEl = document.getElementById('batchPhonesCount');
            const previewEl = document.getElementById('batchPhonesPreview');
            const btn = document.getElementById('batchRechargeBtn');

            if (parsedPhones.length > 0) {
                summaryEl.style.display = 'block';
                countEl.textContent = parsedPhones.length;

                // 显示前几个手机号预览
                const preview = parsedPhones.slice(0, 3).join(', ');
                previewEl.textContent = parsedPhones.length > 3 ? `(${preview}...)` : `(${preview})`;

                // 检查是否可以充值
                const credits = parseInt(document.getElementById('batchCredits').value) || 0;
                btn.disabled = credits <= 0;
            } else {
                summaryEl.style.display = 'none';
                btn.disabled = true;
            }
        }

        function updateBatchPreview() {
            const credits = parseInt(document.getElementById('batchCredits').value) || 0;
            const hint = document.getElementById('batchHint');

            if (credits > 0) {
                const answers = Math.floor(credits / 2);
                hint.innerHTML = `💡 每个手机号充值 ${credits} 积分 ≈ ${answers} 次回答机会`;
            } else {
                hint.innerHTML = '💡 提示：2积分 ≈ 1次回答机会';
            }

            updateBatchPhonesSummary();
        }

        async function handleExcelUpload() {
            const fileInput = document.getElementById('batchExcelFile');
            const file = fileInput.files[0];

            if (!file) return;

            document.getElementById('excelFileName').textContent = '上传中...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/admin/upload-excel-phones', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('excelFileName').textContent = `✅ ${file.name} (${data.count} 个手机号)`;

                    // 将解析的手机号填入文本框
                    document.getElementById('batchPhonesInput').value = data.phones.join('\n');
                    parsedPhones = data.phones;
                    updateBatchPhonesSummary();
                } else {
                    document.getElementById('excelFileName').textContent = '';
                    alert('解析失败: ' + data.error);
                }
            } catch (e) {
                console.error('Excel upload failed:', e);
                document.getElementById('excelFileName').textContent = '';
                alert('上传失败');
            }

            // 清空文件选择，允许重新选择同一文件
            fileInput.value = '';
        }

        async function batchRechargeCredits() {
            if (parsedPhones.length === 0) {
                alert('请先输入手机号');
                return;
            }

            const credits = parseInt(document.getElementById('batchCredits').value) || 0;
            if (credits <= 0) {
                alert('请输入充值积分数量');
                return;
            }

            const reason = document.getElementById('batchReason').value.trim() || '管理员批量充值';

            // 确认
            if (!confirm(`确认为 ${parsedPhones.length} 个手机号各充值 ${credits} 积分？\n\n总计：${parsedPhones.length * credits} 积分`)) {
                return;
            }

            const btn = document.getElementById('batchRechargeBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '充值中...';

            try {
                const res = await fetch('/api/admin/credits/batch-add-by-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phones: parsedPhones,
                        credits: credits,
                        reason: reason
                    })
                });
                const data = await res.json();

                if (data.success) {
                    const results = data.results;
                    const resultEl = document.getElementById('batchRechargeResult');
                    const titleEl = document.getElementById('batchResultTitle');
                    const detailsEl = document.getElementById('batchResultDetails');

                    // 设置标题颜色
                    if (results.fail_count === 0) {
                        titleEl.style.color = '#10b981';
                        titleEl.textContent = `✅ 全部成功！共充值 ${results.success_count} 个用户`;
                    } else if (results.success_count === 0) {
                        titleEl.style.color = '#ef4444';
                        titleEl.textContent = `❌ 全部失败！${results.fail_count} 个手机号无法充值`;
                    } else {
                        titleEl.style.color = '#f59e0b';
                        titleEl.textContent = `⚠️ 部分成功：成功 ${results.success_count} 个，失败 ${results.fail_count} 个`;
                    }

                    // 构建详情
                    let detailsHtml = '';

                    if (results.success_list.length > 0) {
                        detailsHtml += '<div style="margin-bottom: 12px;"><strong style="color: #10b981;">成功：</strong></div>';
                        results.success_list.forEach(item => {
                            const name = item.nickname || '未注册用户';
                            detailsHtml += `<div style="font-size: 13px; color: var(--text-secondary); margin-left: 12px;">📱 ${item.phone} → ${name}（余额: ${item.new_balance}）</div>`;
                        });
                    }

                    if (results.fail_list.length > 0) {
                        detailsHtml += '<div style="margin: 12px 0 0;"><strong style="color: #ef4444;">失败：</strong></div>';
                        results.fail_list.forEach(item => {
                            detailsHtml += `<div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">📱 ${item.phone} - ${item.error}</div>`;
                        });
                    }

                    detailsEl.innerHTML = detailsHtml;
                    resultEl.style.display = 'block';

                    // 清空输入
                    document.getElementById('batchPhonesInput').value = '';
                    document.getElementById('batchCredits').value = '';
                    document.getElementById('batchReason').value = '';
                    parsedPhones = [];
                    updateBatchPhonesSummary();
                    updateBatchPreview();
                } else {
                    alert('批量充值失败: ' + data.error);
                }
            } catch (e) {
                console.error('Batch recharge failed:', e);
                alert('网络错误');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ========================================
        // 兑换码管理
        // ========================================

        async function createRedeemCode() {
            const targetName = document.getElementById('redeemTargetName').value.trim();
            const userType = document.querySelector('input[name="redeemUserType"]:checked').value;
            const catCoins = parseInt(document.getElementById('redeemCatCoins').value) || 0;
            const note = document.getElementById('redeemNote').value.trim();

            if (!targetName) {
                alert('请输入目标用户姓名');
                return;
            }

            // 猫币兑换模式需要输入猫币数量
            if (userType === 'cat_coins' && (!catCoins || catCoins <= 0)) {
                alert('请输入猫币数量');
                return;
            }

            try {
                const requestBody = {
                    target_name: targetName,
                    note,
                    user_type: userType
                };

                // 根据类型设置积分
                if (userType === 'business_school') {
                    requestBody.credits = 2000;  // 商学院固定2000积分
                } else {
                    requestBody.cat_coins = catCoins;
                }

                const res = await fetch('/api/admin/redeem/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    // 显示生成的兑换码
                    document.getElementById('generatedCode').textContent = data.code.code;
                    const creditsInfo = userType === 'business_school'
                        ? '商学院学员 → 2000 积分'
                        : `${catCoins} 猫币 → ${data.code.credits} 积分`;
                    document.getElementById('generatedCredits').textContent = creditsInfo;
                    document.getElementById('redeemResult').style.display = 'block';
                    // 清空表单
                    document.getElementById('redeemTargetName').value = '';
                    document.getElementById('redeemCatCoins').value = '';
                    document.getElementById('redeemNote').value = '';
                    document.getElementById('redeemPreview').style.display = 'none';
                    // 刷新列表
                    loadRedeemCodes();
                } else {
                    alert('生成失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        function copyRedeemCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('兑换码已复制: ' + code);
            });
        }

        // 批量生成的兑换码列表（用于复制）
        let batchGeneratedCodes = [];

        async function batchCreateRedeemCodes() {
            const credits = parseInt(document.getElementById('batchCredits').value) || 0;
            const count = parseInt(document.getElementById('batchCount').value) || 0;
            const note = document.getElementById('batchNote').value.trim();

            if (credits <= 0) {
                alert('请输入积分数量');
                return;
            }

            if (count <= 0 || count > 100) {
                alert('生成数量必须在1-100之间');
                return;
            }

            try {
                const res = await fetch('/api/admin/redeem/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credits, count, note })
                });
                const data = await res.json();

                if (data.success) {
                    batchGeneratedCodes = data.codes.map(c => c.code);

                    // 显示结果
                    document.getElementById('batchResultTitle').textContent =
                        `成功生成 ${data.codes.length} 个兑换码（每个 ${credits} 积分）`;

                    // 显示兑换码列表
                    const listHtml = data.codes.map(c =>
                        `<div style="font-family: monospace; padding: 4px 0; color: var(--accent-blue);">${c.code}</div>`
                    ).join('');
                    document.getElementById('batchCodesList').innerHTML = listHtml;

                    document.getElementById('batchResult').style.display = 'block';

                    // 清空表单
                    document.getElementById('batchCredits').value = '';
                    document.getElementById('batchCount').value = '';
                    document.getElementById('batchNote').value = '';

                    // 刷新列表
                    loadRedeemCodes();
                } else {
                    alert('生成失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        function copyBatchCodes() {
            if (batchGeneratedCodes.length === 0) {
                alert('没有可复制的兑换码');
                return;
            }
            const codesText = batchGeneratedCodes.join('\n');
            navigator.clipboard.writeText(codesText).then(() => {
                alert(`已复制 ${batchGeneratedCodes.length} 个兑换码`);
            });
        }

        async function deleteRedeemCode(codeId) {
            if (!confirm('确定要删除这个兑换码吗？')) return;

            try {
                const res = await fetch(`/api/admin/redeem/${codeId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadRedeemCodes();
                } else {
                    alert('删除失败: ' + data.error);
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 管理员操作日志功能
        // ========================================

        let currentLogType = 'all';

        async function loadAdminLogs(type = 'all') {
            currentLogType = type;
            const container = document.getElementById('adminLogsList');
            container.innerHTML = '<p class="loading">加载中...</p>';

            try {
                const res = await fetch(`/api/admin/logs?type=${type}`);
                const data = await res.json();

                if (data.success) {
                    renderAdminLogs(data.logs || []);
                } else {
                    container.innerHTML = '<p class="loading">加载失败</p>';
                }
            } catch (e) {
                console.error('加载日志失败:', e);
                container.innerHTML = '<p class="loading">加载失败</p>';
            }
        }

        function renderAdminLogs(logs) {
            const container = document.getElementById('adminLogsList');

            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无操作日志</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                // 根据操作类型设置图标
                const icons = {
                    'PROMPT_CREATE': '📝',
                    'PROMPT_UPDATE': '✏️',
                    'PROMPT_DELETE': '🗑️',
                    'MODULE_CREATE': '➕',
                    'MODULE_DELETE': '❌',
                    'REDEEM_CREATE': '🎫',
                    'REDEEM_USED': '✅',
                    'CREDITS_ADD': '💰'
                };
                const icon = icons[log.action_type] || '📋';

                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <div class="log-item-action">
                                ${icon} ${log.action_name || log.action_type}
                                <span class="log-item-target">→ ${log.target || ''}</span>
                            </div>
                            <div class="log-item-details">${log.details || ''}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <span class="log-item-admin">${log.admin_name}</span>
                            <span class="log-item-time">${formatTime(log.created_at)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLogs(type) {
            // 更新按钮状态
            document.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // 加载对应类型的日志
            loadAdminLogs(type);
        }

        // ========================================
        // 管理员用户管理功能
        // ========================================

        let allAdminUsers = [];

        async function loadAdminUsers() {
            const container = document.getElementById('adminsList');
            container.innerHTML = '<p class="loading">加载中...</p>';

            try {
                const res = await fetch('/api/admin/admins');
                const data = await res.json();

                if (data.success) {
                    allAdminUsers = data.admins || [];
                    renderAdminUsers();
                } else {
                    container.innerHTML = '<p class="loading">加载失败: ' + (data.error || '未知错误') + '</p>';
                }
            } catch (e) {
                console.error('加载管理员列表失败:', e);
                container.innerHTML = '<p class="loading">加载失败</p>';
            }
        }

        function renderAdminUsers() {
            const container = document.getElementById('adminsList');

            if (allAdminUsers.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#C4C7C5;padding:40px;">暂无普通管理员</p>';
                return;
            }

            container.innerHTML = allAdminUsers.map(admin => `
                <div class="redeem-code-item">
                    <div class="redeem-code-info">
                        <div class="redeem-code-value" style="letter-spacing: 0;">${admin.username}</div>
                        <div class="redeem-code-meta">
                            创建者: ${admin.created_by || '-'} |
                            创建时间: ${formatTime(admin.created_at)}
                            ${admin.note ? ' | ' + admin.note : ''}
                        </div>
                    </div>
                    <button class="btn-delete-code" style="background: rgba(168, 199, 250, 0.2); color: #A8C7FA;" onclick="resetAdminPassword('${admin.id}', '${admin.username}')">
                        重置密码
                    </button>
                    <button class="btn-delete-code" onclick="deleteAdmin('${admin.id}', '${admin.username}')">
                        删除
                    </button>
                </div>
            `).join('');
        }

        async function createAdmin() {
            const username = document.getElementById('newAdminUsername').value.trim();
            const note = document.getElementById('newAdminNote').value.trim();

            if (!username) {
                alert('请输入用户名');
                return;
            }

            try {
                const res = await fetch('/api/admin/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, note })
                });
                const data = await res.json();

                if (data.success) {
                    // 显示创建结果
                    document.getElementById('createdAdminName').textContent = username;
                    document.getElementById('adminResult').style.display = 'block';
                    // 清空表单
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminNote').value = '';
                    // 刷新列表
                    loadAdminUsers();
                } else {
                    alert('创建失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        async function deleteAdmin(adminId, username) {
            if (!confirm(`确定要删除管理员「${username}」吗？`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    alert('已删除');
                    loadAdminUsers();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        async function resetAdminPassword(adminId, username) {
            if (!confirm(`确定要重置「${username}」的密码为「maoke2024」吗？`)) return;

            try {
                const res = await fetch(`/api/admin/admins/${adminId}/reset-password`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    alert(data.message || '密码已重置为：猫科');
                } else {
                    alert('重置失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 按钮配置管理
        // ========================================

        let buttonConfigs = [];

        async function loadButtonConfigs() {
            const container = document.getElementById('buttonConfigList');
            container.innerHTML = '<p class="loading">加载中...</p>';

            try {
                const res = await fetch('/api/admin/buttons');
                const data = await res.json();

                if (data.success) {
                    buttonConfigs = data.buttons;
                    renderButtonConfigs();
                } else {
                    container.innerHTML = '<p style="color: var(--accent-red);">加载失败: ' + data.error + '</p>';
                }
            } catch (e) {
                container.innerHTML = '<p style="color: var(--accent-red);">网络错误</p>';
            }
        }

        function renderButtonConfigs() {
            const container = document.getElementById('buttonConfigList');
            const buttonColors = {
                'user_profile': 'linear-gradient(135deg, #a855f7, #6366f1)',
                'user_insight': 'linear-gradient(135deg, #22d3ee, #3b82f6)',
                'tool_analysis': 'linear-gradient(135deg, #f97316, #f59e0b)'
            };

            const buttonOrder = ['user_profile', 'user_insight', 'tool_analysis'];
            const sortedConfigs = buttonOrder.map(id => buttonConfigs.find(b => b.id === id)).filter(Boolean);

            container.innerHTML = sortedConfigs.map((btn, index) => `
                <div class="button-config-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="width: 48px; height: 48px; background: ${buttonColors[btn.id] || 'var(--accent-blue)'}; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            ${btn.icon || '📋'}
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">按钮 ${index + 1}</div>
                            <div style="font-size: 13px; color: var(--text-muted);">ID: ${btn.id}</div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">按钮名称</label>
                        <input type="text" id="btn-name-${btn.id}" value="${btn.name || ''}"
                            style="width: 100%; padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 15px;"
                            placeholder="输入按钮显示名称">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">按钮图标（emoji）</label>
                        <input type="text" id="btn-icon-${btn.id}" value="${btn.icon || ''}"
                            style="width: 80px; padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 20px; text-align: center;"
                            placeholder="🔍">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">提示词</label>
                        <textarea id="btn-prompt-${btn.id}"
                            style="width: 100%; min-height: 200px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 14px; line-height: 1.6; resize: vertical; font-family: 'DM Sans', 'Noto Sans SC', monospace;"
                            placeholder="输入 AI 分析使用的提示词...">${btn.prompt || ''}</textarea>
                    </div>

                    <button onclick="saveButtonConfig('${btn.id}')"
                        style="padding: 12px 24px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(99, 102, 241, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        💾 保存配置
                    </button>
                </div>
            `).join('');
        }

        async function saveButtonConfig(buttonId) {
            const name = document.getElementById(`btn-name-${buttonId}`).value.trim();
            const icon = document.getElementById(`btn-icon-${buttonId}`).value.trim();
            const prompt = document.getElementById(`btn-prompt-${buttonId}`).value;

            if (!name) {
                alert('请输入按钮名称');
                return;
            }

            try {
                const res = await fetch(`/api/admin/buttons/${buttonId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, icon, prompt })
                });
                const data = await res.json();

                if (data.success) {
                    alert('✅ 保存成功！');
                    // 更新本地缓存
                    const btn = buttonConfigs.find(b => b.id === buttonId);
                    if (btn) {
                        btn.name = name;
                        btn.icon = icon;
                        btn.prompt = prompt;
                    }
                } else {
                    alert('保存失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // ========================================
        // 版本历史功能
        // ========================================

        // 版本历史数据（每次更新在这里添加新版本）
        // 基于 git log 完整记录
        const versionHistory = [
            {
                version: '1.3.0',
                date: '2026-01-17',
                title: 'AI 聊天深度思考模式',
                type: 'feature',
                changes: [
                    '将 AI 聊天默认模型改为深度思考模式',
                    '提升 AI 回答质量和推理能力'
                ],
                major: true
            },
            {
                version: '1.2.9',
                date: '2026-01-17',
                title: '移动端适配优化',
                type: 'fix',
                changes: [
                    '添加侧边栏遮罩层',
                    '调整快捷回复 margin',
                    '优化移动端交互体验'
                ]
            },
            {
                version: '1.2.8',
                date: '2026-01-17',
                title: '修复多个潜在 Bug',
                type: 'fix',
                changes: [
                    '修复多个潜在 bug',
                    '提升系统稳定性'
                ]
            },
            {
                version: '1.2.7',
                date: '2026-01-17',
                title: '修复添加模块错误提示',
                type: 'fix',
                changes: [
                    '修复添加模块时错误提示显示 undefined 的问题',
                    '优化错误信息展示'
                ]
            },
            {
                version: '1.2.6',
                date: '2026-01-16',
                title: '批量手机号充值功能',
                type: 'feature',
                changes: [
                    '添加批量手机号充值功能',
                    '支持 Excel 文件导入',
                    '支持批量预充值（用户未注册时预存）'
                ]
            },
            {
                version: '1.2.5',
                date: '2026-01-16',
                title: '飞书消息同步功能',
                type: 'feature',
                changes: [
                    '添加消息每分钟增量同步到飞书',
                    '飞书消息同步增加用户详细信息',
                    '支持自动分表存储',
                    '新建 messages 表同步对话内容'
                ]
            },
            {
                version: '1.2.4',
                date: '2026-01-15',
                title: '飞书多维表格数据备份',
                type: 'feature',
                changes: [
                    '添加飞书多维表格数据备份同步功能',
                    '支持定时自动备份用户数据'
                ]
            },
            {
                version: '1.2.3',
                date: '2026-01-15',
                title: 'UI 样式优化',
                type: 'ui',
                changes: [
                    '字体大小从 15px 改为 16px，与 Gemini 风格保持一致',
                    '星星图标颜色从紫色渐变改为蓝色',
                    '侧边栏智能体描述字体大小调整为 13px'
                ]
            },
            {
                version: '1.2.2',
                date: '2026-01-15',
                title: '用户列表视图切换 + 调研记录',
                type: 'feature',
                changes: [
                    '添加用户列表视图切换功能（卡片/表格/紧凑视图）',
                    '添加用户调研记录功能',
                    '支持录入电话沟通、现场拜访、微信沟通等多种调研类型'
                ]
            },
            {
                version: '1.2.1',
                date: '2026-01-15',
                title: 'CSRF 安全防护 + 用户最后聊天时间',
                type: 'feature',
                changes: [
                    '添加 CSRF 防护中间件，验证 POST/PUT/DELETE 请求来源',
                    '配置 Session Cookie 安全选项（Secure, HttpOnly, SameSite）',
                    '用户表格视图添加「最后聊天时间」列',
                    '支持按最后聊天时间排序',
                    '支持认领无主会话（未登录用户创建的会话）'
                ],
                major: true
            },
            {
                version: '1.2.0',
                date: '2026-01-14',
                title: '新增版本历史功能',
                type: 'feature',
                changes: [
                    '在管理后台添加「版本历史」页面',
                    '展示所有历史版本更新记录',
                    '支持功能/修复/UI/优化等类型标签',
                    '基于 git 提交历史完整记录所有更新'
                ],
                major: true
            },
            {
                version: '1.1.9',
                date: '2026-01-14',
                title: '修复部署脚本 data 目录嵌套 bug',
                type: 'fix',
                changes: [
                    '修复 Docker 部署时 data 目录嵌套问题',
                    '优化部署脚本稳定性'
                ]
            },
            {
                version: '1.1.8',
                date: '2026-01-14',
                title: '用户列表 CRM 风格改造合并',
                type: 'feature',
                changes: [
                    '合并 CRM 风格用户列表所有改动',
                    '表格视图、多维度排序、最近活跃时间'
                ]
            },
            {
                version: '1.1.7',
                date: '2026-01-14',
                title: '更新聊天模板和日志',
                type: 'optimize',
                changes: [
                    '优化聊天界面模板',
                    '改进日志记录功能'
                ]
            },
            {
                version: '1.1.6',
                date: '2026-01-14',
                title: '优化数据库和权限管理功能',
                type: 'feature',
                changes: [
                    '优化数据库查询性能',
                    '增强权限管理功能',
                    '改进管理员操作体验'
                ]
            },
            {
                version: '1.1.5',
                date: '2026-01-14',
                title: '添加主账号按钮配置功能',
                type: 'feature',
                changes: [
                    '新增按钮配置管理页面',
                    '支持自定义分析按钮名称和提示词',
                    '主管理员专属功能'
                ]
            },
            {
                version: '1.1.4',
                date: '2026-01-14',
                title: 'CRM 风格用户列表重构',
                type: 'feature',
                changes: [
                    '用户列表改为 CRM 风格表格视图',
                    '支持多维度排序',
                    '显示最近活跃时间'
                ]
            },
            {
                version: '1.1.3',
                date: '2026-01-14',
                title: '移除管理后台登录框顶部装饰条',
                type: 'ui',
                changes: [
                    '优化登录界面视觉效果',
                    '移除不必要的装饰元素'
                ]
            },
            {
                version: '1.1.2',
                date: '2026-01-14',
                title: '优化用户列表页面',
                type: 'feature',
                changes: [
                    '增加用户筛选功能',
                    '添加行业智能识别',
                    '支持按积分、活跃度筛选'
                ]
            },
            {
                version: '1.1.1',
                date: '2026-01-12',
                title: 'AI 自验证工作流',
                type: 'feature',
                changes: [
                    '添加 AI 自验证工作流机制',
                    '提升代码质量保障'
                ]
            },
            {
                version: '1.1.0',
                date: '2026-01-12',
                title: '修复用户画像分析 json 变量作用域错误',
                type: 'fix',
                changes: [
                    '修复 JSON 解析变量作用域问题',
                    '提升用户画像分析稳定性'
                ],
                major: true
            },
            {
                version: '1.0.9',
                date: '2026-01-12',
                title: '全面提升应用安全性',
                type: 'fix',
                changes: [
                    '修复多个关键安全漏洞',
                    '增强输入验证和过滤',
                    '提升整体安全等级'
                ]
            },
            {
                version: '1.0.8',
                date: '2026-01-12',
                title: '实现 MD5 到 bcrypt 平滑密码迁移',
                type: 'feature',
                changes: [
                    '支持用户登录时自动迁移密码加密方式',
                    '保证老用户无感升级',
                    '新用户直接使用 bcrypt'
                ]
            },
            {
                version: '1.0.7',
                date: '2026-01-12',
                title: '新增用户画像分析功能',
                type: 'feature',
                changes: [
                    '添加 AI 用户画像分析',
                    '支持用户洞察生成',
                    '支持工具分析报告'
                ]
            },
            {
                version: '1.0.6',
                date: '2026-01-12',
                title: '修复关键安全漏洞：密码加密升级',
                type: 'fix',
                changes: [
                    '将 MD5 密码哈希替换为 bcrypt',
                    '提升密码存储安全性',
                    '符合现代安全标准'
                ]
            },
            {
                version: '1.0.5',
                date: '2026-01-12',
                title: '聊天记录用户邮箱可点击',
                type: 'feature',
                changes: [
                    '点击聊天记录中的用户邮箱可查看该用户所有对话',
                    '优化用户详情页导航'
                ]
            },
            {
                version: '1.0.4',
                date: '2026-01-12',
                title: '管理后台移动端响应式适配',
                type: 'feature',
                changes: [
                    '为管理后台添加完整的移动端响应式适配',
                    '优化移动端操作体验',
                    '侧边栏折叠/展开功能'
                ]
            },
            {
                version: '1.0.3',
                date: '2026-01-10',
                title: '实现管理员用户管理功能',
                type: 'feature',
                changes: [
                    '支持创建普通管理员账号',
                    '支持删除管理员',
                    '支持重置管理员密码',
                    '区分超级管理员和普通管理员权限',
                    '管理后台 UI 样式优化',
                    '深色主题全面升级'
                ]
            },
            {
                version: '1.0.2',
                date: '2026-01-10',
                title: '管理后台 UI 优化',
                type: 'ui',
                changes: [
                    '全新侧边栏布局设计',
                    '统计卡片视觉优化',
                    '登录界面美化'
                ]
            },
            {
                version: '1.0.1',
                date: '2026-01-10',
                title: '兑换码管理功能',
                type: 'feature',
                changes: [
                    '支持生成兑换码',
                    '支持批量生成',
                    '支持手机号直接充值'
                ]
            },
            {
                version: '1.0.0',
                date: '2026-01-10',
                title: '系统初始版本',
                type: 'feature',
                changes: [
                    '电商管理设计工具核心功能',
                    'AI 对话模块（KPI 模块、促销活动等）',
                    '用户注册登录系统',
                    '积分充值系统',
                    '管理后台基础功能',
                    'Supabase 数据库集成'
                ],
                major: true
            }
        ];

        // 渲染版本历史
        function renderVersionHistory() {
            const container = document.getElementById('versionsList');

            if (versionHistory.length === 0) {
                container.innerHTML = '<p class="loading">暂无版本记录</p>';
                return;
            }

            // 更新当前版本号和累计更新次数
            document.getElementById('currentVersionNum').textContent = 'v' + versionHistory[0].version;
            document.getElementById('totalVersionCount').textContent = versionHistory.length + ' 次';

            // 渲染版本列表
            container.innerHTML = versionHistory.map(v => {
                const typeLabels = {
                    'feature': '新功能',
                    'fix': '修复',
                    'ui': 'UI优化',
                    'optimize': '优化'
                };

                return `
                    <div class="version-item">
                        <div class="version-badge ${v.major ? 'major' : ''}">v${v.version}</div>
                        <div class="version-content">
                            <div class="version-title">
                                ${v.title}
                                <span class="version-tag ${v.type}">${typeLabels[v.type] || v.type}</span>
                            </div>
                            <div class="version-desc">
                                <ul>
                                    ${v.changes.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div class="version-date">${v.date}</div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>

</html>